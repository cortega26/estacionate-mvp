// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum DurationType {
  ELEVEN_HOURS @map("11h")
  TWENTY_THREE_HOURS @map("23h")
}

enum SpotStatus {
  available
  reserved
  blocked
}

enum BookingStatus {
  pending
  confirmed
  cancelled
  completed
  no_show
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum PaymentMethod {
  mercadopago
  fintoc
}

enum GatewayStatus {
  pending
  approved
  rejected
  cancelled
  refunded
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// Models

model Building {
  id                String   @id @default(uuid())
  name              String   @db.VarChar(255)
  address           String
  adminCompany      String?  @map("admin_company") @db.VarChar(255)
  contactEmail      String   @map("contact_email") @db.VarChar(255)
  phone             String?  @db.VarChar(20)
  totalUnits        Int      @map("total_units")
  visitorSpotsCount Int      @default(0) @map("visitor_spots_count")
  timezone          String   @default("America/Santiago") @db.VarChar(50)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  units        Unit[]
  visitorSpots VisitorSpot[]
  payouts      Payout[]
  users        User[]

  @@map("buildings")
}

model Unit {
  id         String   @id @default(uuid())
  buildingId String   @map("building_id")
  unitNumber String   @map("unit_number") @db.VarChar(10)
  floor      Int?
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  building  Building   @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  residents Resident[]

  @@unique([buildingId, unitNumber])
  @@map("units")
}

model Resident {
  id               String    @id @default(uuid())
  unitId           String    @map("unit_id")
  email            String    @unique @db.VarChar(255)
  rut              String    @unique @db.VarChar(12)
  firstName        String    @map("first_name") @db.VarChar(100)
  lastName         String    @map("last_name") @db.VarChar(100)
  phone            String?   @db.VarChar(20)
  isVerified       Boolean   @default(false) @map("is_verified")
  verifiedAt       DateTime? @map("verified_at")
  verificationCode String?   @map("verification_code") @db.VarChar(10)
  passwordHash     String?   @map("password_hash") @db.VarChar(255) // Added for MVP password login
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  unit     Unit      @relation(fields: [unitId], references: [id], onDelete: Restrict)
  bookings Booking[]

  @@map("residents")
}

model VisitorSpot {
  id          String   @id @default(uuid())
  buildingId  String   @map("building_id")
  spotNumber  String   @map("spot_number") @db.VarChar(10)
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  building           Building            @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  availabilityBlocks AvailabilityBlock[]

  @@unique([buildingId, spotNumber])
  @@map("visitor_spots")
}

model AvailabilityBlock {
  id             String       @id @default(uuid())
  spotId         String       @map("spot_id")
  startDatetime  DateTime     @map("start_datetime")
  endDatetime    DateTime     @map("end_datetime")
  durationType   DurationType @map("duration_type")
  basePriceClp   Int          @map("base_price_clp")
  status         SpotStatus   @default(available)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @default(now()) @updatedAt @map("updated_at")

  // Relations
  spot     VisitorSpot @relation(fields: [spotId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@map("availability_blocks")
}

model Booking {
  id                  String        @id @default(uuid())
  residentId          String        @map("resident_id")
  availabilityBlockId String        @map("availability_block_id")
  visitorName         String        @map("visitor_name") @db.VarChar(255)
  visitorPhone        String?       @map("visitor_phone") @db.VarChar(20)
  vehiclePlate        String        @map("vehicle_plate") @db.VarChar(10)
  amountClp           Int           @map("amount_clp")
  commissionClp       Int           @map("commission_clp")
  status              BookingStatus @default(pending)
  paymentStatus       PaymentStatus @default(pending) @map("payment_status")
  confirmationCode    String        @unique @map("confirmation_code") @db.VarChar(10)
  specialInstructions String?       @map("special_instructions")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @default(now()) @updatedAt @map("updated_at")

  // Relations
  resident          Resident          @relation(fields: [residentId], references: [id], onDelete: Restrict)
  availabilityBlock AvailabilityBlock @relation(fields: [availabilityBlockId], references: [id], onDelete: Restrict)
  payment           Payment?

  @@map("bookings")
}

model Payment {
  id                String        @id @default(uuid())
  bookingId         String        @unique @map("booking_id")
  externalPaymentId String?       @map("external_payment_id") @db.VarChar(255)
  paymentMethod     PaymentMethod? @map("payment_method")
  amountClp         Int           @map("amount_clp")
  status            GatewayStatus @default(pending)
  gatewayResponse   Json?         @map("gateway_response")
  processedAt       DateTime?     @map("processed_at")
  createdAt         DateTime      @default(now()) @map("created_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Restrict)

  @@map("payments")
}

model Payout {
  id                    String    @id @default(uuid())
  buildingId            String    @map("building_id")
  periodStart           DateTime  @map("period_start") @db.Date
  periodEnd             DateTime  @map("period_end") @db.Date
  totalRevenueClp       Int       @map("total_revenue_clp")
  platformCommissionClp Int       @map("platform_commission_clp")
  buildingShareClp      Int       @map("building_share_clp")
  status                String    @default("calculated") @db.VarChar(20) // calculated, paid, disputed
  paidAt                DateTime? @map("paid_at")
  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  building Building @relation(fields: [buildingId], references: [id], onDelete: Restrict)

  @@map("payouts")
}

enum Role {
  admin
  support
  building_admin
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         Role     @default(admin)
  buildingId   String?  @map("building_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  building Building? @relation(fields: [buildingId], references: [id])
  auditLogs AuditLog[]

  @@map("users")
}

model AuditLog {
  id          String      @id @default(uuid())
  tableName   String      @map("table_name") @db.VarChar(50)
  recordId    String      @map("record_id") @db.Uuid
  action      AuditAction
  oldValues   Json?       @map("old_values")
  newValues   Json?       @map("new_values")
  userId      String?     @map("user_id")
  ipAddress   String?     @map("ip_address") @db.Inet
  userAgent   String?     @map("user_agent")
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}
