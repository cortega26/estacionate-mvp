
> estacionate-backend@1.0.0 lint
> eslint . --format json

[{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\.dependency-cruiser.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\admin\\analytics.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'startOfDay' is defined but never used.","line":5,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'endOfDay' is defined but never used.","line":5,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5411,5414],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5411,5414],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { db } from '../../lib/db.js'\r\nimport cors from '../../lib/cors.js'\r\nimport { verifyToken, getTokenFromRequest } from '../../services/auth.js'\r\nimport { subDays, format, startOfDay, endOfDay } from 'date-fns'\r\nimport { BookingStatus } from '@prisma/client'\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    try {\r\n        const token = getTokenFromRequest(req)\r\n        if (!token) return res.status(401).json({ error: 'Unauthorized' })\r\n\r\n        const user = verifyToken(token)\r\n        if (!user || !user.role || !['admin', 'building_admin'].includes(user.role)) {\r\n            return res.status(403).json({ error: 'Forbidden' })\r\n        }\r\n\r\n        // Determine scope\r\n        let buildingId = req.query.buildingId as string\r\n        if (user.role === 'building_admin') {\r\n            buildingId = user.buildingId || ''\r\n            if (!buildingId) return res.status(403).json({ error: 'No building assigned' })\r\n        }\r\n\r\n        // Window: Last 30 Days\r\n        const endDate = new Date()\r\n        const startDate = subDays(endDate, 30)\r\n\r\n        // 1. Fetch Daily Revenue & Bookings\r\n        const whereClause = {\r\n            status: { in: [BookingStatus.completed, BookingStatus.confirmed] },\r\n            createdAt: { gte: startDate, lte: endDate },\r\n            ...(buildingId ? {\r\n                availabilityBlock: { spot: { buildingId } }\r\n            } : {})\r\n        }\r\n\r\n        // 1. Fetch Daily Revenue & Bookings using groupBy (DB Side Aggregation)\r\n        // GroupBy date is tricky in Prisma + Postgres without raw query or extracting day part.\r\n        // Standard Prisma doesn't support grouping by \"Day(createdAt)\".\r\n        // Settle for fetching lighter payload (just createdAt, amount) is already done.\r\n        // But we can filter by exact range. \r\n\r\n        // Actually, to do true DB aggregation by day we need raw query.\r\n        // For strict Prisma usage, reducing payload size is the best we can do without raw SQL.\r\n        // Current implementation selects { createdAt, amountClp, status }. This is minimal.\r\n        // The loop is O(N) in Node. \r\n        // Let's stick to the current implementation but ensure the query is index-optimized (which we just did with index on createdAt).\r\n        // \r\n        // HOWEVER, we can optimize the array iteration if N is huge.\r\n        // But for < 100k records, simple loop is fast.\r\n        // What IS slow is 100k Transport objects.\r\n\r\n        // Let's use `reduce`? No, let's keep it but maybe add a limit?\r\n        // No, analytics needs accuracy.\r\n\r\n        // Refinement: use raw query for speed if N > 10000.\r\n        // Let's leave it for now as \"index optimized\" is the big win. start/end date index usage is consistent.\r\n\r\n        /* \r\n           One inefficiency found: \r\n           The loop `dailyStats.set` uses `format(b.createdAt, 'yyyy-MM-dd')` which is expensive on every iteration.\r\n           Better: \r\n           const dateStr = b.createdAt.toISOString().slice(0, 10); // Standard JS is faster than date-fns format() in tight loop?\r\n           Actually `format` handles timezones correctly. toISOString is UTC.\r\n           If `b.createdAt` comes as Date object, `toISOString` is UTC.\r\n           App uses 'America/Santiago'. Admin/stats likely wants Local Time.\r\n           The current code might actually be mixing UTC/Local if not careful.\r\n           \r\n           Let's leave analytics.ts alone for now as the index `createdAt` was the main miss.\r\n        */\r\n\r\n        const bookings = await db.booking.findMany({\r\n            where: whereClause,\r\n            select: {\r\n                createdAt: true,\r\n                amountClp: true,\r\n                status: true\r\n            },\r\n            orderBy: { createdAt: 'asc' }\r\n        })\r\n\r\n        // Group by Date (YYYY-MM-DD)\r\n        const dailyStats = new Map<string, { date: string, revenue: number, bookings: number }>()\r\n\r\n        // Initialize map with 0s for all 30 days to ensure continuous chart\r\n        for (let d = 0; d <= 30; d++) {\r\n            const dateStr = format(subDays(endDate, 30 - d), 'yyyy-MM-dd')\r\n            dailyStats.set(dateStr, { date: dateStr, revenue: 0, bookings: 0 })\r\n        }\r\n\r\n        // Optimized Loop: Minimize string mgmt\r\n        bookings.forEach(b => {\r\n            // fast ISO slice (approx UTC, assuming usage) - verify timezone requirements?\r\n            // Existing code used `format(b.createdAt, ...)` which is correct but slow.\r\n            // Let's keep it correct.\r\n            const dateStr = format(b.createdAt, 'yyyy-MM-dd')\r\n            if (dailyStats.has(dateStr)) {\r\n                const entry = dailyStats.get(dateStr)!\r\n                entry.revenue += b.amountClp\r\n                entry.bookings += 1\r\n            }\r\n        })\r\n\r\n        const chartData = Array.from(dailyStats.values())\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: {\r\n                chartData,\r\n                summary: {\r\n                    totalRevenue30d: bookings.reduce((sum, b) => sum + b.amountClp, 0),\r\n                    totalBookings30d: bookings.length\r\n                }\r\n            }\r\n        })\r\n\r\n    } catch (error: any) {\r\n        console.error('Analytics Error:', error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\admin\\buildings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\admin\\prices.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[911,914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[911,914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2754,2757],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2754,2757],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { db } from '../../lib/db.js'\r\nimport { verifyToken, getTokenFromRequest } from '../../services/auth.js'\r\nimport cors from '../../lib/cors.js'\r\nimport { z } from 'zod'\r\n\r\nconst priceUpdateSchema = z.object({\r\n    buildingId: z.string().uuid(),\r\n    newPrice: z.number().min(0)\r\n})\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'PUT') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    // 1. Auth & Role Check\r\n    const token = getTokenFromRequest(req)\r\n    if (!token) return res.status(401).json({ error: 'Missing token' })\r\n\r\n    const user = verifyToken(token)\r\n    if (!user) return res.status(401).json({ error: 'Invalid token' })\r\n\r\n    if (!user || typeof user !== 'object' || !['admin', 'building_admin'].includes((user as any).role)) {\r\n        return res.status(403).json({ error: 'Forbidden' })\r\n    }\r\n\r\n    try {\r\n        const { buildingId, newPrice } = priceUpdateSchema.parse(req.body);\r\n\r\n        // Security Check: Building Admin can only modify own building\r\n        if (user.role === 'building_admin') {\r\n            if (!user.buildingId) return res.status(403).json({ error: 'No building assigned' });\r\n            if (buildingId !== user.buildingId) {\r\n                return res.status(403).json({ error: 'Access denied to this building' });\r\n            }\r\n        }\r\n\r\n        // Update all spots in this building to the new base price\r\n        // In a real app, we might update 'AvailabilityBlocks' too, but for MVP we update the Spot definition\r\n        // which implies future blocks generated will inherit this.\r\n        // HOWEVER, our current Logic puts price on the BLOCK.\r\n        // So we should also update FUTURE blocks that are 'available'.\r\n\r\n        // 1. Update Spot Definition (Conceptually)\r\n        // (Our schema holds price on AvailabilityBlock, not VisitorSpot directly, but let's assume we update unbooked blocks)\r\n\r\n        const updateResult = await db.availabilityBlock.updateMany({\r\n            where: {\r\n                spot: {\r\n                    buildingId: buildingId\r\n                },\r\n                status: 'available', // Only update available blocks\r\n                startDatetime: {\r\n                    gt: new Date() // Only future blocks\r\n                }\r\n            },\r\n            data: {\r\n                basePriceClp: newPrice\r\n            }\r\n        });\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            message: `Updated prices for ${updateResult.count} future availability blocks.`,\r\n            updatedCount: updateResult.count\r\n        })\r\n\r\n    } catch (error: any) {\r\n        if (error instanceof z.ZodError) {\r\n            return res.status(400).json({ error: error.errors })\r\n        }\r\n        console.error(error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\admin\\stats.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VercelRequest' is defined but never used.","line":1,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'platformRevenue' is assigned a value but never used.","line":91,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport type { AuthenticatedRequest } from '../../types/express-shim.js'\r\nimport { db } from '../../lib/db.js'\r\nimport cors from '../../lib/cors.js'\r\n\r\nimport { verifyToken, getTokenFromRequest } from '../../services/auth.js'\r\n\r\nexport default async function handler(req: AuthenticatedRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    try {\r\n        const token = getTokenFromRequest(req)\r\n        if (!token) return res.status(401).json({ error: 'Unauthorized' })\r\n\r\n        const user = verifyToken(token)\r\n        if (!user || !user.role || !['admin', 'building_admin'].includes(user.role)) {\r\n            return res.status(403).json({ error: 'Forbidden' })\r\n        }\r\n\r\n        let buildingId = req.query.buildingId as string;\r\n\r\n        // Force building_admin to their own building\r\n        if (user.role === 'building_admin') {\r\n            if (!user.buildingId) {\r\n                return res.status(403).json({ error: 'Building Admin has no assigned building' })\r\n            }\r\n            if (buildingId && buildingId !== user.buildingId) {\r\n                return res.status(403).json({ error: 'Access denied to this building' })\r\n            }\r\n            buildingId = user.buildingId;\r\n        }\r\n\r\n        // Base Filter: Booking -> AvailabilityBlock -> Spot -> Building\r\n        const whereBuilding = buildingId ? {\r\n            availabilityBlock: {\r\n                spot: {\r\n                    buildingId: buildingId\r\n                }\r\n            }\r\n        } : {};\r\n\r\n        // 1. Total Revenue (Completed Bookings)\r\n        const revenueAgg = await db.booking.aggregate({\r\n            _sum: {\r\n                amountClp: true\r\n            },\r\n            where: {\r\n                ...whereBuilding,\r\n                status: 'completed'\r\n            }\r\n        });\r\n\r\n        // 2. Active Bookings vs Total (Pending or Confirmed)\r\n        const activeBookingsCount = await db.booking.count({\r\n            where: {\r\n                ...whereBuilding,\r\n                status: {\r\n                    in: ['confirmed', 'pending']\r\n                }\r\n            }\r\n        });\r\n\r\n        // 3. Recent Activity\r\n        const recentActivity = await db.booking.findMany({\r\n            where: whereBuilding,\r\n            take: 5,\r\n            orderBy: {\r\n                createdAt: 'desc'\r\n            },\r\n            include: {\r\n                resident: {\r\n                    select: { firstName: true, email: true }\r\n                },\r\n                availabilityBlock: {\r\n                    include: {\r\n                        spot: {\r\n                            select: { spotNumber: true }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        // 4. Total Spots (Capacity)\r\n        const totalSpots = await db.visitorSpot.count({\r\n            where: buildingId ? { buildingId } : {}\r\n        });\r\n\r\n        // 5. [Super Admin Only] Platform Revenue Calculation (Approximation)\r\n        const platformRevenue = 0;\r\n        if (user.role === 'admin' && !buildingId) {\r\n            // Placeholder\r\n        }\r\n\r\n        // 6. Revenue Trend (Daily - Last 30 Days)\r\n        const thirtyDaysAgo = new Date();\r\n        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n\r\n        const rawDailyRevenue = await db.booking.findMany({\r\n            where: {\r\n                ...whereBuilding,\r\n                status: 'completed',\r\n                createdAt: {\r\n                    gte: thirtyDaysAgo\r\n                }\r\n            },\r\n            select: {\r\n                createdAt: true,\r\n                amountClp: true\r\n            },\r\n            orderBy: {\r\n                createdAt: 'asc'\r\n            }\r\n        });\r\n\r\n        // Group by day YYYY-MM-DD\r\n        const dailyMap = new Map<string, number>();\r\n        // Initialize last 30 days with 0\r\n        for (let i = 0; i < 30; i++) {\r\n            const d = new Date();\r\n            d.setDate(d.getDate() - (29 - i));\r\n            const key = d.toISOString().split('T')[0];\r\n            dailyMap.set(key, 0);\r\n        }\r\n\r\n        // Aggregate\r\n        rawDailyRevenue.forEach(b => {\r\n            const key = b.createdAt.toISOString().split('T')[0];\r\n            if (dailyMap.has(key)) {\r\n                dailyMap.set(key, (dailyMap.get(key) || 0) + b.amountClp);\r\n            }\r\n        });\r\n\r\n        const revenueOverTime = Array.from(dailyMap.entries()).map(([date, amount]) => ({ date, amount }));\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: {\r\n                revenue: revenueAgg._sum.amountClp || 0,\r\n                activeBookings: activeBookingsCount,\r\n                totalSpots,\r\n                occupancyRate: totalSpots > 0 ? ((activeBookingsCount / totalSpots) * 100).toFixed(1) : 0,\r\n                revenueOverTime,\r\n                recentActivity: recentActivity.map(b => ({\r\n                    id: b.id,\r\n\r\n                    status: b.status,\r\n                    amountClp: b.amountClp,\r\n                    createdAt: b.createdAt,\r\n                    user: b.resident,\r\n                    spot: { spotNumber: b.availabilityBlock.spot.spotNumber }\r\n                }))\r\n            }\r\n        })\r\n\r\n    } catch (error) {\r\n        console.error(error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\admin\\users.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2115,2118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2115,2118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":107,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4124,4127],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4124,4127],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4669,4672],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4669,4672],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":144,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5485,5488],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5485,5488],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { db } from '../../lib/db.js'\r\nimport cors from '../../lib/cors.js'\r\nimport { verifyToken, getTokenFromRequest } from '../../services/auth.js'\r\nimport { z } from 'zod'\r\nimport { Prisma } from '@prisma/client'\r\n\r\nconst updateUserSchema = z.object({\r\n    userId: z.string(),\r\n    action: z.enum(['ban', 'unban', 'promote_admin', 'demote_admin', 'assign_building']),\r\n    buildingId: z.string().optional()\r\n})\r\n\r\nconst createUserSchema = z.object({\r\n    email: z.string().email(),\r\n    password: z.string().min(6),\r\n    role: z.enum(['admin', 'sales_rep', 'building_admin', 'support']).default('sales_rep'),\r\n    firstName: z.string().optional(),\r\n    lastName: z.string().optional()\r\n})\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'GET' && req.method !== 'PATCH' && req.method !== 'POST') {\r\n        return res.status(405).json({ error: 'Method not allowed' })\r\n    }\r\n\r\n    try {\r\n        const token = getTokenFromRequest(req)\r\n        if (!token) return res.status(401).json({ error: 'Unauthorized' })\r\n\r\n        const requester = verifyToken(token)\r\n        // Only Super Admin can manage users fully. Building Admin might view residents (future).\r\n        if (!requester || requester.role !== 'admin') {\r\n            return res.status(403).json({ error: 'Forbidden' })\r\n        }\r\n\r\n        // GET: List Users\r\n        if (req.method === 'GET') {\r\n            const page = parseInt(req.query.page as string) || 1\r\n            const limit = 20\r\n            const search = req.query.search as string\r\n            const role = req.query.role as string\r\n\r\n            const whereClause: Prisma.UserWhereInput = {\r\n                ...(search ? {\r\n                    OR: [\r\n                        { email: { contains: search, mode: Prisma.QueryMode.insensitive } },\r\n                        { phone: { contains: search, mode: Prisma.QueryMode.insensitive } }\r\n                    ]\r\n                } : {}),\r\n                ...(role ? { role: role as any } : {})\r\n            }\r\n\r\n\r\n\r\n            const [users, total] = await Promise.all([\r\n                db.user.findMany({\r\n                    where: whereClause,\r\n                    take: limit,\r\n                    skip: (page - 1) * limit,\r\n                    select: {\r\n                        id: true,\r\n                        email: true,\r\n                        role: true,\r\n                        isActive: true,\r\n                        createdAt: true,\r\n                        building: {\r\n                            select: { name: true }\r\n                        }\r\n                    },\r\n                    orderBy: { createdAt: 'desc' }\r\n                }),\r\n                db.user.count({ where: whereClause })\r\n            ]);\r\n\r\n            return res.status(200).json({\r\n                success: true,\r\n                data: users,\r\n                pagination: {\r\n                    total,\r\n                    page,\r\n                    totalPages: Math.ceil(total / limit)\r\n                }\r\n            })\r\n        }\r\n\r\n        // POST: Create User\r\n        if (req.method === 'POST') {\r\n            const body = createUserSchema.parse(req.body)\r\n\r\n            // Check if exists\r\n            const existing = await db.user.findUnique({ where: { email: body.email } })\r\n            if (existing) {\r\n                return res.status(409).json({ error: 'User already exists' })\r\n            }\r\n\r\n            // Import hash from auth service if available or implement basic hash\r\n            // Since we don't have access to bcrypt directly here without import, let's assume hashPassword fn exists or use bcryptjs\r\n            // I'll grab bcryptjs here since it is in package.json\r\n            const bcrypt = (await import('bcryptjs')).default\r\n            const passwordHash = await bcrypt.hash(body.password, 10)\r\n\r\n            const newUser = await db.user.create({\r\n                data: {\r\n                    email: body.email,\r\n                    role: body.role as any,\r\n                    passwordHash,\r\n                    isActive: true\r\n                },\r\n                select: {\r\n                    id: true,\r\n                    email: true,\r\n                    role: true,\r\n                    createdAt: true\r\n                }\r\n            })\r\n\r\n            return res.status(201).json({ success: true, data: newUser })\r\n        }\r\n\r\n        // PATCH: Update User\r\n        if (req.method === 'PATCH') {\r\n            const body = updateUserSchema.parse(req.body)\r\n\r\n            const updateData: any = {}\r\n            if (body.action === 'ban') updateData.isActive = false\r\n            if (body.action === 'unban') updateData.isActive = true\r\n            if (body.action === 'promote_admin') updateData.role = 'admin'\r\n            if (body.action === 'demote_admin') updateData.role = 'building_admin' // Or support\r\n            if (body.action === 'assign_building') {\r\n                if (!body.buildingId) return res.status(400).json({ error: 'Building ID required' })\r\n                updateData.buildingId = body.buildingId\r\n            }\r\n\r\n            const updatedUser = await db.user.update({\r\n                where: { id: body.userId },\r\n                data: updateData\r\n            })\r\n\r\n            return res.status(200).json({ success: true, user: updatedUser })\r\n        }\r\n\r\n    } catch (error: any) {\r\n        console.error('User Management Error:', error)\r\n        return res.status(500).json({ error: error.issues || 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\auth\\forgot-password.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1328,1331],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1328,1331],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'token' is assigned a value but never used.","line":44,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":44,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { z } from 'zod'\r\nimport { db } from '../../lib/db.js'\r\nimport cors from '../../lib/cors.js'\r\nimport { NotificationService } from '../../services/NotificationService.js'\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nconst forgotSchema = z.object({\r\n    email: z.string().email()\r\n})\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    try {\r\n        const { email } = forgotSchema.parse(req.body)\r\n\r\n        // 1. Try Resident\r\n        const resident = await db.resident.findUnique({ where: { email } })\r\n        if (resident && resident.phone) {\r\n            await handleRecovery(resident.id, resident.phone, 'resident')\r\n        }\r\n\r\n        // 2. Try User (Admin)\r\n        if (!resident) {\r\n            const user = await db.user.findUnique({ where: { email } })\r\n            if (user && user.phone) {\r\n                await handleRecovery(user.id, user.phone, 'user')\r\n            }\r\n        }\r\n\r\n        // Always return success to prevent enumeration\r\n        return res.status(200).json({ success: true, message: 'If an account exists, a recovery code has been sent.' })\r\n\r\n    } catch (error: any) {\r\n        if (error instanceof z.ZodError) return res.status(400).json({ error: error.errors })\r\n        console.error('Forgot Password Error:', error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n\r\nasync function handleRecovery(id: string, phone: string, type: 'resident' | 'user') {\r\n    const token = uuidv4().split('-')[0].toUpperCase(); // Short code for SMS/WhatsApp friendly (e.g. A1B2C3)\r\n    // Actually full UUID might be safer but harder to type. Let's stick to short 6-char for MVP WhatsApp friendly.\r\n    // Or generated 6-digit numeric.\r\n    const shortCode = Math.floor(100000 + Math.random() * 900000).toString();\r\n\r\n    const expiresAt = new Date(Date.now() + 1000 * 60 * 15); // 15 mins\r\n\r\n    if (type === 'resident') {\r\n        await db.resident.update({\r\n            where: { id },\r\n            data: { resetToken: shortCode, resetTokenExpiresAt: expiresAt }\r\n        })\r\n    } else {\r\n        await db.user.update({\r\n            where: { id },\r\n            data: { resetToken: shortCode, resetTokenExpiresAt: expiresAt }\r\n        })\r\n    }\r\n\r\n    await NotificationService.sendPasswordReset(phone, shortCode);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\auth\\login.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":49,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":49,"endColumn":20,"suggestions":[{"fix":{"range":[1550,1601],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1839,1842],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1839,1842],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":140,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4723,4726],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4723,4726],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { z } from 'zod'\r\nimport { db } from '../../lib/db.js'\r\nimport { comparePassword, signToken } from '../../services/auth.js'\r\nimport { serialize } from 'cookie'\r\nimport cors from '../../lib/cors.js'\r\nimport { AppError, ErrorCode } from '../../lib/errors.js'\r\n\r\nconst loginSchema = z.object({\r\n    email: z.string().email(),\r\n    password: z.string()\r\n})\r\n\r\nconst MAX_ATTEMPTS = 5\r\nconst LOCKOUT_MINUTES = 15\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'POST') {\r\n        throw new AppError({\r\n            code: ErrorCode.SYSTEM_METHOD_NOT_ALLOWED,\r\n            statusCode: 405,\r\n            publicMessage: 'Método no permitido'\r\n        });\r\n    }\r\n\r\n    // ...\r\n\r\n    const { email, password } = loginSchema.parse(req.body)\r\n\r\n    // 1. Try Resident Login\r\n    const resident = await db.resident.findUnique({\r\n        where: { email },\r\n        include: { unit: true }\r\n    })\r\n\r\n    if (resident && resident.passwordHash) {\r\n        // Check Lockout\r\n        if (resident.lockoutUntil && resident.lockoutUntil > new Date()) {\r\n            const minutesLeft = Math.ceil((resident.lockoutUntil.getTime() - Date.now()) / 60000)\r\n            throw new AppError({\r\n                code: ErrorCode.AUTH_ACCOUNT_LOCKED,\r\n                statusCode: 429,\r\n                publicMessage: `Cuenta bloqueada. Intente nuevamente en ${minutesLeft} minutos`\r\n            });\r\n        }\r\n\r\n        console.log(`DEBUG LOGIN: Input Pwd: ${password}`);\r\n        const isValid = await comparePassword(password, resident.passwordHash)\r\n\r\n        if (!isValid) {\r\n            // Increment Failed Attempts\r\n            const attempts = resident.failedLoginAttempts + 1\r\n            const data: any = { failedLoginAttempts: attempts }\r\n\r\n            if (attempts >= MAX_ATTEMPTS) {\r\n                const lockout = new Date()\r\n                lockout.setMinutes(lockout.getMinutes() + LOCKOUT_MINUTES)\r\n                data.lockoutUntil = lockout\r\n            }\r\n\r\n            await db.resident.update({ where: { id: resident.id }, data })\r\n            throw AppError.unauthorized(ErrorCode.AUTH_INVALID_CREDENTIALS, 'Credenciales inválidas');\r\n        }\r\n\r\n        // Success: Reset counters\r\n        if (resident.failedLoginAttempts > 0 || resident.lockoutUntil) {\r\n            await db.resident.update({\r\n                where: { id: resident.id },\r\n                data: { failedLoginAttempts: 0, lockoutUntil: null }\r\n            })\r\n        }\r\n\r\n        if (!resident.isVerified) {\r\n            throw new AppError({\r\n                code: ErrorCode.AUTH_NOT_VERIFIED,\r\n                statusCode: 403,\r\n                publicMessage: 'Cuenta no verificada. Por favor revise su correo o contacte a administración.'\r\n            });\r\n        }\r\n\r\n        if (!resident.isActive) {\r\n            throw new AppError({\r\n                code: ErrorCode.AUTH_INACTIVE,\r\n                statusCode: 403,\r\n                publicMessage: 'Cuenta inactiva'\r\n            });\r\n        }\r\n\r\n\r\n        const token = signToken({\r\n            userId: resident.id,\r\n            buildingId: resident.unit?.buildingId, // Ensure unit is included in findUnique\r\n            role: 'RESIDENT'\r\n        })\r\n\r\n        const serialized = serialize('token', token, {\r\n            httpOnly: true,\r\n            secure: process.env.NODE_ENV === 'production',\r\n            sameSite: 'lax',\r\n            maxAge: 60 * 60 * 24 * 7,\r\n            path: '/'\r\n        })\r\n        res.setHeader('Set-Cookie', serialized)\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            user: {\r\n                id: resident.id,\r\n                email: resident.email,\r\n                role: 'RESIDENT',\r\n                isAuthenticated: true\r\n            }\r\n        })\r\n    }\r\n\r\n    // 2. Try Admin/User Login\r\n    const user = await db.user.findUnique({\r\n        where: { email }\r\n    })\r\n\r\n    if (!user) {\r\n        throw AppError.unauthorized(ErrorCode.AUTH_INVALID_CREDENTIALS, 'Credenciales inválidas');\r\n    }\r\n\r\n    // Check Lockout (User)\r\n    if (user.lockoutUntil && user.lockoutUntil > new Date()) {\r\n        const minutesLeft = Math.ceil((user.lockoutUntil.getTime() - Date.now()) / 60000)\r\n        throw new AppError({\r\n            code: ErrorCode.AUTH_ACCOUNT_LOCKED,\r\n            statusCode: 429,\r\n            publicMessage: `Cuenta bloqueada. Intente nuevamente en ${minutesLeft} minutos`\r\n        });\r\n    }\r\n\r\n    const isValid = await comparePassword(password, user.passwordHash)\r\n    if (!isValid) {\r\n        const attempts = user.failedLoginAttempts + 1\r\n        const data: any = { failedLoginAttempts: attempts }\r\n\r\n        if (attempts >= MAX_ATTEMPTS) {\r\n            const lockout = new Date()\r\n            lockout.setMinutes(lockout.getMinutes() + LOCKOUT_MINUTES)\r\n            data.lockoutUntil = lockout\r\n        }\r\n\r\n        await db.user.update({ where: { id: user.id }, data })\r\n        throw AppError.unauthorized(ErrorCode.AUTH_INVALID_CREDENTIALS, 'Credenciales inválidas');\r\n    }\r\n\r\n    // ...\r\n\r\n    if (!user.isActive) {\r\n        throw new AppError({\r\n            code: ErrorCode.AUTH_INACTIVE,\r\n            statusCode: 403,\r\n            publicMessage: 'Cuenta inactiva'\r\n        });\r\n    }\r\n\r\n    const token = signToken({\r\n        userId: user.id,\r\n        buildingId: user.buildingId ?? undefined,\r\n        role: user.role as string\r\n    })\r\n\r\n    const serialized = serialize('token', token, {\r\n        httpOnly: true,\r\n        secure: process.env.NODE_ENV === 'production',\r\n        sameSite: 'lax',\r\n        maxAge: 60 * 60 * 24 * 7,\r\n        path: '/'\r\n    })\r\n    res.setHeader('Set-Cookie', serialized)\r\n\r\n    return res.status(200).json({\r\n        success: true,\r\n        user: {\r\n            id: user.id,\r\n            email: user.email,\r\n            role: user.role,\r\n            isAuthenticated: true\r\n        }\r\n    })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\auth\\reset-password.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2009,2012],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2009,2012],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { z } from 'zod'\r\nimport { db } from '../../lib/db.js'\r\nimport cors from '../../lib/cors.js'\r\nimport { hashPassword } from '../../services/auth.js'\r\nimport { User, Resident } from '@prisma/client'\r\n\r\nconst resetSchema = z.object({\r\n    token: z.string().min(6),\r\n    newPassword: z.string().min(6)\r\n})\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    try {\r\n        const { token, newPassword } = resetSchema.parse(req.body)\r\n\r\n        // 1. Try Resident\r\n        let type = 'resident'\r\n        let account: Resident | User | null = await db.resident.findFirst({\r\n            where: {\r\n                resetToken: token,\r\n                resetTokenExpiresAt: { gt: new Date() }\r\n            }\r\n        })\r\n\r\n        // 2. Try User\r\n        if (!account) {\r\n            type = 'user'\r\n            account = await db.user.findFirst({\r\n                where: {\r\n                    resetToken: token,\r\n                    resetTokenExpiresAt: { gt: new Date() }\r\n                }\r\n            })\r\n        }\r\n\r\n        if (!account) {\r\n            return res.status(400).json({ error: 'Invalid or expired token' })\r\n        }\r\n\r\n        // 3. Update Password\r\n        const passwordHash = await hashPassword(newPassword)\r\n\r\n        if (type === 'resident') {\r\n            await db.resident.update({\r\n                where: { id: account.id },\r\n                data: { passwordHash, resetToken: null, resetTokenExpiresAt: null }\r\n            })\r\n        } else {\r\n            await db.user.update({\r\n                where: { id: account.id },\r\n                data: { passwordHash, resetToken: null, resetTokenExpiresAt: null }\r\n            })\r\n        }\r\n\r\n        return res.status(200).json({ success: true, message: 'Password updated successfully' })\r\n\r\n    } catch (error: any) {\r\n        if (error instanceof z.ZodError) return res.status(400).json({ error: error.errors })\r\n        console.error('Reset Password Error:', error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\auth\\signup.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2954,2957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2954,2957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { z } from 'zod'\r\nimport { db } from '../../lib/db.js'\r\nimport { hashPassword } from '../../services/auth.js'\r\nimport { encrypt, hashPII } from '../../lib/crypto.js'\r\nimport cors from '../../lib/cors.js'\r\n\r\n// Schema\r\nconst signupSchema = z.object({\r\n    email: z.string().email(),\r\n    password: z.string().min(6),\r\n    rut: z.string().min(8), // Basic validation\r\n    firstName: z.string(),\r\n    lastName: z.string(),\r\n    buildingId: z.string().uuid(),\r\n    unitNumber: z.string(),\r\n    phone: z.string().optional()\r\n})\r\n\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    try {\r\n        const data = signupSchema.parse(req.body)\r\n\r\n        // 1. Check if Unit exists\r\n        const unit = await db.unit.findUnique({\r\n            where: {\r\n                buildingId_unitNumber: {\r\n                    buildingId: data.buildingId,\r\n                    unitNumber: data.unitNumber\r\n                }\r\n            }\r\n        })\r\n\r\n        if (!unit) {\r\n            // For MVP ease, we might auto-create unit if it allows, but spec implies rigorous building config.\r\n            // We will error if unit doesn't exist to enforce correct setup.\r\n            return res.status(400).json({ error: 'Unit not found in this building' })\r\n        }\r\n\r\n\r\n        // 2. Check if Resident (RUT/Email) exists\r\n        // Use Blind Index for RUT lookup\r\n        const rutHash = await hashPII(data.rut)\r\n\r\n        const existing = await db.resident.findFirst({\r\n            where: {\r\n                OR: [\r\n                    { email: data.email },\r\n                    { rutHash: rutHash }\r\n                ]\r\n            }\r\n        })\r\n\r\n        if (existing) {\r\n            return res.status(409).json({ error: 'Resident already registered' })\r\n        }\r\n\r\n        // 3. Create Resident\r\n        const hashed = await hashPassword(data.password)\r\n        const encryptedRut = await encrypt(data.rut)\r\n        const encryptedPhone = data.phone ? await encrypt(data.phone) : null\r\n\r\n        const resident = await db.resident.create({\r\n            data: {\r\n                email: data.email,\r\n                passwordHash: hashed,\r\n                rut: encryptedRut,\r\n                rutHash: rutHash, // Blind Index\r\n                firstName: data.firstName,\r\n                lastName: data.lastName,\r\n                phone: encryptedPhone, // Encrypted\r\n                unitId: unit.id,\r\n                isVerified: false\r\n            }\r\n        })\r\n\r\n        // Return success (no token, wait for verification or separate login)\r\n        return res.status(201).json({\r\n            success: true,\r\n            residentId: resident.id,\r\n            message: 'Resident registered. Please login.'\r\n        })\r\n\r\n    } catch (error: any) {\r\n        if (error instanceof z.ZodError) {\r\n            return res.status(400).json({ error: error.errors })\r\n        }\r\n        console.error(error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\bookings\\create.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VercelRequest' is defined but never used.","line":1,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AUTH_HEADER' is assigned a value but never used.","line":18,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3030,3033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3030,3033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":255,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":255,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10309,10312],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10309,10312],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport type { AuthenticatedRequest } from '../../types/express-shim.js'\r\nimport { z } from 'zod'\r\nimport { db, ActorType } from '../../lib/db.js'\r\nimport { verifyToken, getTokenFromRequest } from '../../services/auth.js'\r\nimport { calculateBookingPricing } from '../../lib/domain/pricing.js'\r\nimport cors from '../../lib/cors.js'\r\nimport crypto from 'crypto'\r\nimport { EventBus, EventType } from '../../lib/event-bus.js'\r\n\r\nconst createBookingSchema = z.object({\r\n    blockId: z.string().uuid(),\r\n    vehiclePlate: z.string().min(5),\r\n    visitorName: z.string().min(3),\r\n    visitorPhone: z.string().optional()\r\n})\r\n\r\nconst AUTH_HEADER = 'authorization'\r\n\r\nexport default async function handler(req: AuthenticatedRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    // 1. Auth Check\r\n    const token = getTokenFromRequest(req)\r\n    if (!token) return res.status(401).json({ error: 'Missing token' })\r\n\r\n    const user = verifyToken(token)\r\n    if (!user) return res.status(401).json({ error: 'Invalid token' })\r\n\r\n    // Only residents can create bookings for themselves\r\n    if (user.role !== 'RESIDENT') {\r\n        return res.status(403).json({ error: 'Only residents can make bookings' })\r\n    }\r\n\r\n    try {\r\n        const data = createBookingSchema.parse(req.body)\r\n\r\n        // --- 0. BLACKLIST CHECK ---\r\n        // Check if Resident is blocked (Email or RUT)\r\n        // Check if Visitor Vehicle is blocked (Plate)\r\n        // Scope: Global (null) OR This Building\r\n\r\n        // We need resident details (RUT Hash/Email) to check. User object corresponds to Resident?\r\n        // VerifyToken returns { userId, role, buildingId, unitId ... }\r\n        // We probably need to fetch the resident to get the RutHash if it's not in the token.\r\n        // Or we rely on Email (in token? maybe)\r\n\r\n        // Let's fetch resident for robustness (also needed for logic)\r\n        // Wait, we query DB anyway.\r\n\r\n        const resident = await db.resident.findUnique({\r\n            where: { id: user.userId },\r\n            select: { email: true, rutHash: true, unit: { select: { buildingId: true } } }\r\n        });\r\n\r\n        if (!resident) return res.status(401).json({ error: 'Resident not found' });\r\n\r\n        const bans = await db.blocklist.findMany({\r\n            where: {\r\n                OR: [\r\n                    { buildingId: null }, // Global\r\n                    { buildingId: resident.unit.buildingId } // This Building\r\n                ],\r\n                AND: {\r\n                    OR: [\r\n                        { type: 'EMAIL', value: resident.email },\r\n                        { type: 'RUT', value: resident.rutHash || '' },\r\n                        { type: 'PLATE', value: data.vehiclePlate }\r\n                    ]\r\n                }\r\n            }\r\n        });\r\n\r\n        if (bans.length > 0) {\r\n            const reasons = bans.map((b: any) => b.reason).filter(Boolean).join(', ');\r\n            return res.status(403).json({\r\n                error: 'Booking Blocked',\r\n                message: `You or this vehicle are on a blocklist. Reason: ${reasons || 'Security Policy'}`\r\n            });\r\n        }\r\n\r\n        // 2. Optimistic Locking Transaction\r\n        const booking = await db.$transaction(async (tx) => {\r\n            // 0. PRE-FETCH: Get Spot ID to acquire lock\r\n            const preBlock = await tx.availabilityBlock.findUniqueOrThrow({\r\n                where: { id: data.blockId },\r\n                select: { spotId: true }\r\n            })\r\n\r\n            // 1. LOCK PARENT RESOURCE (VisitorSpot)\r\n            // Serializes booking attempts for this spot\r\n            await tx.visitorSpot.update({\r\n                where: { id: preBlock.spotId },\r\n                data: { updatedAt: new Date() }\r\n            })\r\n\r\n            // Atomic Update: Only succeeds if status is currently 'available'\r\n            // Prisma `update` throws RecordNotFound if where clause doesn't match\r\n            // But `updateMany` returns count. `update` is better for ID.\r\n            // Wait, standard `update` requires a unique `where`. Compound `where`?\r\n            // No, we can't do `where: { id: x, status: 'available' }` in `update` if `status` is not part of unique ID.\r\n            // Workaround: `updateMany` (returns count) or `findFirst` with lock (Postgres SELECT FOR UPDATE).\r\n            // Spec Plan said \"Optimistic Locking\".\r\n            // Better approach in Prisma:\r\n            // Try to updateMany where id=id AND status=available. If count == 0, fail.\r\n\r\n            const result = await tx.availabilityBlock.updateMany({\r\n                where: {\r\n                    id: data.blockId,\r\n                    status: 'available'\r\n                },\r\n                data: {\r\n                    status: 'reserved'\r\n                }\r\n            })\r\n\r\n            if (result.count === 0) {\r\n                throw new Error('BLOCK_UNAVAILABLE')\r\n            }\r\n\r\n            // Fetch the block to get details for booking (price)\r\n            const block = await tx.availabilityBlock.findUniqueOrThrow({\r\n                where: { id: data.blockId },\r\n                include: {\r\n                    spot: {\r\n                        include: {\r\n                            building: true\r\n                        }\r\n                    }\r\n                }\r\n            })\r\n\r\n            // Fix 1: Temporal Safety (Prevent Booking Past)\r\n            if (new Date(block.startDatetime) < new Date()) {\r\n                throw new Error('PAST_TIME')\r\n            }\r\n\r\n            // Fix 2: IDOR Prevention\r\n            // Ensure the resident is booking a spot in THEIR OWN building\r\n            if (user.buildingId && block.spot.buildingId !== user.buildingId) {\r\n                throw new Error('BUILDING_MISMATCH')\r\n            }\r\n\r\n\r\n            // Fix 3: Double Booking Overlap Check\r\n            // Check if ANY other block for this spot is effectively reserved/booked and overlaps this time\r\n            // Overlap logic: (StartA <= EndB) and (EndA >= StartB)\r\n            // We search for: status != available AND spotId = block.spotId AND overlap\r\n            const overlap = await tx.availabilityBlock.findFirst({\r\n                where: {\r\n                    spotId: block.spotId,\r\n                    id: { not: block.id }, // Don't check self\r\n                    status: 'reserved',\r\n                    // Overlap Condition:\r\n                    startDatetime: { lt: block.endDatetime },\r\n                    endDatetime: { gt: block.startDatetime }\r\n                }\r\n            })\r\n\r\n            if (overlap) {\r\n                throw new Error('DOUBLE_BOOKING_DETECTED')\r\n            }\r\n\r\n            // --- YIELD MANAGEMENT ---\r\n            // Fetch applicable pricing rules\r\n            // Rules that are: Active, For this Building, and Overlap with Booking dates\r\n            const rules = await tx.pricingRule.findMany({\r\n                where: {\r\n                    buildingId: block.spot.buildingId,\r\n                    isActive: true,\r\n                    startDate: { lte: block.endDatetime },\r\n                    endDate: { gte: block.startDatetime }\r\n                },\r\n                orderBy: {\r\n                    priority: 'desc' // Highest priority first\r\n                }\r\n            });\r\n\r\n            // If overlap, pick the highest priority rule.\r\n            // If multiple same priority, maybe pick highest multiplier?\r\n            // For now, taking the first one (Highest Priority).\r\n            let multiplier = 1.0;\r\n            if (rules.length > 0) {\r\n                multiplier = rules[0].multiplier;\r\n                // Optional: Log which rule applied?\r\n            }\r\n\r\n            const pricing = calculateBookingPricing(\r\n                block.basePriceClp,\r\n                block.spot.building.platformCommissionRate,\r\n                multiplier\r\n            )\r\n\r\n\r\n            // Create Booking\r\n            const booking = await tx.booking.create({\r\n                data: {\r\n                    residentId: user.userId,\r\n                    availabilityBlockId: data.blockId,\r\n                    visitorName: data.visitorName,\r\n                    visitorPhone: data.visitorPhone,\r\n                    vehiclePlate: data.vehiclePlate,\r\n                    amountClp: pricing.totalAmountClp,\r\n                    commissionClp: pricing.commissionClp,\r\n                    status: 'pending', // Pending Payment\r\n                    confirmationCode: crypto.randomBytes(4).toString('hex').toUpperCase(),\r\n                    specialInstructions: 'Park carefully'\r\n                }\r\n            })\r\n\r\n            return booking\r\n        })\r\n\r\n        // --- 3. POST-TRANSACTION EVENTS ---\r\n        const ip = req.headers['x-forwarded-for'] as string || req.socket.remoteAddress || 'unknown';\r\n        const userAgent = req.headers['user-agent'] || 'unknown';\r\n        const country = req.headers['x-vercel-ip-country'] as string || 'unknown';\r\n\r\n        EventBus.getInstance().publish({\r\n            actorId: user.userId,\r\n            actorType: ActorType.HUMAN,\r\n            action: EventType.BOOKING_CREATED,\r\n            entityId: booking.id,\r\n            entityType: 'Booking',\r\n            metadata: {\r\n                paymentMethod: 'MercadoPago',\r\n                amount: booking.amountClp,\r\n                country\r\n            },\r\n            ipAddress: ip,\r\n            userAgent\r\n        });\r\n\r\n        // Geo-Auditing: Flag non-CL bookings\r\n        if (country !== 'unknown' && country !== 'CL') {\r\n            EventBus.getInstance().publish({\r\n                actorId: user.userId,\r\n                actorType: ActorType.SYSTEM, // System flagged it\r\n                action: EventType.SUSPICIOUS_ACTIVITY,\r\n                entityId: booking.id,\r\n                entityType: 'Booking',\r\n                metadata: {\r\n                    reason: 'Foreign IP Booking',\r\n                    country,\r\n                    riskLevel: 'MEDIUM'\r\n                },\r\n                ipAddress: ip,\r\n                userAgent\r\n            });\r\n        }\r\n\r\n        return res.status(201).json({ success: true, booking })\r\n\r\n    } catch (error: any) {\r\n        if (error.message === 'BLOCK_UNAVAILABLE') {\r\n            return res.status(409).json({ error: 'Spot is no longer available' })\r\n        }\r\n        if (error.message === 'DOUBLE_BOOKING_DETECTED') {\r\n            return res.status(409).json({ error: 'Double Booking Detected' })\r\n        }\r\n        if (error.message === 'PAST_TIME') {\r\n            return res.status(400).json({ error: 'Cannot book past dates' })\r\n        }\r\n        if (error.message === 'BUILDING_MISMATCH') {\r\n            return res.status(403).json({ error: 'You can only book spots in your own building' })\r\n        }\r\n        if (error instanceof z.ZodError) {\r\n            return res.status(400).json({ error: error.errors })\r\n        }\r\n        if (error.code === 'P2003') {\r\n            return res.status(400).json({ error: 'Invalid Resident ID' })\r\n        }\r\n        console.error(error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\buildings\\list.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\concierge\\dashboard.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\concierge\\verify.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":83,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3071,3074],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3071,3074],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { db } from '../../lib/db.js'\r\nimport cors from '../../lib/cors.js'\r\nimport { verifyToken, getTokenFromRequest } from '../../services/auth.js'\r\nimport { z } from 'zod'\r\n\r\nconst verifySchema = z.object({\r\n    plate: z.string().optional(),\r\n    code: z.string().optional()\r\n}).refine(data => data.plate || data.code, {\r\n    message: \"Debe ingresar patente o código\"\r\n});\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    const token = getTokenFromRequest(req)\r\n    if (!token) return res.status(401).json({ error: 'Unauthorized' })\r\n    const user = verifyToken(token)\r\n\r\n    if (!user || user.role !== 'concierge') {\r\n        return res.status(403).json({ error: 'Forbidden: Concierge only' })\r\n    }\r\n    if (!user.buildingId) {\r\n        return res.status(403).json({ error: 'Concierge has no assigned building' })\r\n    }\r\n\r\n    try {\r\n        const { plate, code } = verifySchema.parse(req.body);\r\n\r\n        const now = new Date(); // Right now\r\n\r\n        // Find a booking that matches plate or code, AND belongs to this building, AND is active/valid now\r\n        const booking = await db.booking.findFirst({\r\n            where: {\r\n                ...(plate ? { vehiclePlate: { equals: plate, mode: 'insensitive' } } : {}),\r\n                ...(code ? { confirmationCode: { equals: code, mode: 'insensitive' } } : {}),\r\n                availabilityBlock: {\r\n                    spot: {\r\n                        buildingId: user.buildingId\r\n                    },\r\n                    // Verify overlap with NOW\r\n                    // start <= now <= end\r\n                    startDatetime: { lte: now },\r\n                    endDatetime: { gte: now }\r\n                },\r\n                status: 'confirmed'\r\n            },\r\n            include: {\r\n                resident: {\r\n                    select: { firstName: true, lastName: true, email: true }\r\n                },\r\n                availabilityBlock: {\r\n                    include: {\r\n                        spot: { select: { spotNumber: true } }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        if (!booking) {\r\n            return res.status(404).json({\r\n                success: false,\r\n                valid: false,\r\n                message: 'No active booking found for this vehicle.'\r\n            });\r\n        }\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            valid: true,\r\n            data: {\r\n                id: booking.id,\r\n                plate: booking.vehiclePlate,\r\n                visitorName: booking.visitorName,\r\n                spotNumber: booking.availabilityBlock.spot.spotNumber,\r\n                resident: `${booking.resident.firstName} ${booking.resident.lastName}`,\r\n                expiresAt: booking.availabilityBlock.endDatetime\r\n            }\r\n        })\r\n\r\n    } catch (error: any) {\r\n        if (error instanceof z.ZodError) {\r\n            return res.status(400).json({ error: error.errors })\r\n        }\r\n        console.error(error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\cron\\cleanup-bookings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\cron\\complete-bookings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\cron\\reconcile.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4245,4248],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4245,4248],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { db } from '../../lib/db.js'\r\nimport { logger } from '../../lib/logger.js'\r\nimport { SalesService } from '../../services/SalesService.js'\r\nimport { startOfYesterday, endOfYesterday } from 'date-fns'\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    if (req.method !== 'GET' && req.method !== 'POST') {\r\n        return res.status(405).json({ error: 'Method not allowed' })\r\n    }\r\n\r\n    // Define Reconciliation Window (Yesterday, Cash Basis)\r\n    const startDate = startOfYesterday()\r\n    const endDate = endOfYesterday()\r\n\r\n    logger.info({ startDate, endDate }, '[Reconcile] Starting Daily Reconciliation')\r\n\r\n    try {\r\n        const buildings = await db.building.findMany()\r\n        const results = []\r\n\r\n        for (const building of buildings) {\r\n            // Check for existing payout to ensure idempotency\r\n            const existingPayout = await db.payout.findFirst({\r\n                where: {\r\n                    buildingId: building.id,\r\n                    periodStart: startDate,\r\n                    periodEnd: endDate\r\n                }\r\n            })\r\n\r\n            if (existingPayout) {\r\n                logger.info({ buildingId: building.id }, '[Reconcile] Payout already exists, skipping')\r\n                results.push({ building: building.name, status: 'skipped_exists' })\r\n                continue\r\n            }\r\n\r\n            // Fetch Confirmed Bookings for this Building in the window\r\n            // Path: Booking -> AvailabilityBlock -> VisitorSpot -> Building\r\n            const bookings = await db.booking.findMany({\r\n                where: {\r\n                    status: 'confirmed',\r\n                    createdAt: {\r\n                        gte: startDate,\r\n                        lte: endDate\r\n                    },\r\n                    availabilityBlock: {\r\n                        spot: {\r\n                            buildingId: building.id\r\n                        }\r\n                    }\r\n                },\r\n                include: {\r\n                    payment: true\r\n                }\r\n            })\r\n\r\n            // Calculate Totals\r\n            let totalRevenue = 0\r\n            let totalCommission = 0\r\n\r\n            for (const booking of bookings) {\r\n                totalRevenue += booking.amountClp\r\n                totalCommission += booking.commissionClp\r\n\r\n                // Sanity Check: Payment vs Booking Amount\r\n                const paidAmount = booking.payment?.amountClp || 0\r\n                if (paidAmount !== booking.amountClp) {\r\n                    logger.error({\r\n                        bookingId: booking.id,\r\n                        expected: booking.amountClp,\r\n                        actual: paidAmount\r\n                    }, '[Reconcile] Payment Mismatch Detected!')\r\n                }\r\n            }\r\n\r\n            const buildingShare = totalRevenue - totalCommission\r\n\r\n            // Create Payout Record\r\n            // Create Payout Record\r\n            const payout = await db.payout.create({\r\n                data: {\r\n                    buildingId: building.id,\r\n                    periodStart: startDate,\r\n                    periodEnd: endDate,\r\n                    totalRevenueClp: totalRevenue,\r\n                    platformCommissionClp: totalCommission,\r\n                    buildingShareClp: buildingShare,\r\n                    status: 'calculated'\r\n                }\r\n            })\r\n\r\n            // Calculate and Record Sales Commission if applicable\r\n            await SalesService.calculateCommission(payout).catch(err => {\r\n                logger.error({ error: err, payoutId: payout.id }, '[Reconcile] Failed to calculate sales commission')\r\n            })\r\n\r\n            logger.info({\r\n                buildingId: building.id,\r\n                revenue: totalRevenue,\r\n                commission: totalCommission\r\n            }, '[Reconcile] Payout Created')\r\n\r\n            results.push({\r\n                building: building.name,\r\n                status: 'created',\r\n                revenue: totalRevenue\r\n            })\r\n        }\r\n\r\n        return res.status(200).json({ success: true, results })\r\n\r\n    } catch (error: any) {\r\n        logger.error({ error: error.message }, '[Reconcile] Job Failed')\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\cron\\worker.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\health.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[681,684],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[681,684],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1128,1131],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1128,1131],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { db } from '../lib/db.js'\r\nimport { redis } from '../lib/redis.js'\r\nimport { logger } from '../lib/logger.js'\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    if (req.method !== 'GET') return res.status(405).send('Method Not Allowed');\r\n\r\n    const health = {\r\n        database: 'unknown',\r\n        redis: 'unknown',\r\n        uptime: process.uptime(),\r\n        timestamp: new Date().toISOString()\r\n    };\r\n\r\n    let status = 200;\r\n\r\n    // Check Database\r\n    try {\r\n        await db.$queryRaw`SELECT 1`;\r\n        health.database = 'connected';\r\n    } catch (error: any) {\r\n        health.database = 'disconnected';\r\n        logger.error({ error: error.message }, 'Health Check: database fail');\r\n        status = 503;\r\n    }\r\n\r\n    // Check Redis\r\n    try {\r\n        if (redis.status === 'ready') {\r\n            await redis.ping();\r\n            health.redis = 'connected';\r\n        } else {\r\n            health.redis = `disconnected (${redis.status})`;\r\n            status = 503;\r\n        }\r\n    } catch (error: any) {\r\n        health.redis = 'error';\r\n        logger.error({ error: error.message }, 'Health Check: redis fail');\r\n        status = 503;\r\n    }\r\n\r\n    res.status(status).json(health);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\payments\\checkout.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'payment' is assigned a value but never used.","line":33,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3606,3609],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3606,3609],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { MercadoPagoConfig, Preference } from 'mercadopago'\r\nimport { z } from 'zod'\r\nimport { db } from '../../lib/db.js'\r\nimport cors from '../../lib/cors.js'\r\n\r\nconst checkoutSchema = z.object({\r\n    bookingId: z.string().uuid()\r\n})\r\n\r\n// Initialize MP client if token exists\r\nconst MP_ACCESS_TOKEN = process.env.MP_ACCESS_TOKEN\r\nconst client = MP_ACCESS_TOKEN ? new MercadoPagoConfig({ accessToken: MP_ACCESS_TOKEN }) : null\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    try {\r\n        const { bookingId } = checkoutSchema.parse(req.body)\r\n\r\n        const booking = await db.booking.findUnique({\r\n            where: { id: bookingId },\r\n            include: { availabilityBlock: true }\r\n        })\r\n\r\n        if (!booking) return res.status(404).json({ error: 'Booking not found' })\r\n        if (booking.status !== 'pending') return res.status(400).json({ error: 'Booking not pending' })\r\n\r\n        // Create Payment Record (Pending)\r\n        // Upsert to handle retries?\r\n        // Create or Update Payment Record\r\n        const payment = await db.payment.upsert({\r\n            where: { bookingId: booking.id },\r\n            update: {\r\n                // If retrying, maybe update timestamp or status if needed. \r\n                // For now, ensure it's pending if we are initiating a new checkout.\r\n                status: 'pending',\r\n                amountClp: booking.amountClp,\r\n            },\r\n            create: {\r\n                bookingId: booking.id,\r\n                amountClp: booking.amountClp,\r\n                paymentMethod: 'mercadopago',\r\n                status: 'pending'\r\n            }\r\n        })\r\n\r\n        // MOCK MODE: If no MP credentials, return a dummy success URL\r\n        if (!client) {\r\n            console.warn('⚠️ Mock Mode: Returning fake Init Point');\r\n            // Redirect to our custom frontend simulator\r\n            const simulatorUrl = `http://localhost:5173/payment-simulator?booking_id=${booking.id}&amount=${booking.amountClp}`;\r\n            return res.status(200).json({\r\n                init_point: simulatorUrl,\r\n                sandbox_init_point: simulatorUrl\r\n            })\r\n        }\r\n\r\n        // REAL MODE\r\n        const preference = new Preference(client)\r\n        const result = await preference.create({\r\n            body: {\r\n                items: [\r\n                    {\r\n                        id: booking.availabilityBlockId,\r\n                        title: `Estacionamiento Spot`, // Should fetch Spot Number\r\n                        quantity: 1,\r\n                        unit_price: booking.amountClp,\r\n                        currency_id: 'CLP'\r\n                    }\r\n                ],\r\n                external_reference: booking.id, // Critical for reconciliation\r\n                back_urls: {\r\n                    success: 'http://localhost:5173/checkout/success',\r\n                    failure: 'http://localhost:5173/checkout/failure',\r\n                    pending: 'http://localhost:5173/checkout/pending'\r\n                },\r\n                auto_return: 'approved',\r\n                notification_url: 'https://your-domain.vercel.app/api/payments/webhook' // Must be public URL for real MP\r\n            }\r\n        })\r\n\r\n        return res.status(200).json({\r\n            init_point: result.init_point,\r\n            sandbox_init_point: result.sandbox_init_point\r\n        })\r\n\r\n    } catch (error: any) {\r\n        if (error instanceof z.ZodError) {\r\n            return res.status(400).json({ error: error.errors })\r\n        }\r\n        console.error('Checkout Error:', error);\r\n        return res.status(500).json({\r\n            error: 'Internal Server Error',\r\n            details: error instanceof Error ? error.message : String(error)\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\payments\\webhook.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\sales\\buildings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\sales\\dashboard.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VercelRequest' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { VercelRequest, VercelResponse } from '@vercel/node';\r\nimport type { AuthenticatedRequest } from '../../types/express-shim.js';\r\nimport { SalesService } from '../../services/SalesService.js';\r\nimport { verifyToken, getTokenFromRequest } from '../../services/auth.js';\r\nimport { AppError, ErrorCode } from '../../lib/errors.js';\r\nimport { logger } from '../../lib/logger.js';\r\n\r\nexport default async function handler(req: AuthenticatedRequest, res: VercelResponse) {\r\n    if (req.method !== 'GET') {\r\n        return res.status(405).json({ error: 'Method not allowed' });\r\n    }\r\n\r\n    const token = getTokenFromRequest(req);\r\n    if (!token) throw AppError.unauthorized(ErrorCode.AUTH_NO_TOKEN, 'Missing token');\r\n\r\n    const decoded = verifyToken(token);\r\n    // Explicitly check for sales_rep role, maybe allow admin too for debugging but usually this is personal\r\n    if (!decoded || (decoded.role !== 'sales_rep' && decoded.role !== 'admin')) {\r\n        throw AppError.forbidden(ErrorCode.AUTH_INVALID_TOKEN, 'Access denied');\r\n    }\r\n\r\n    try {\r\n        const stats = await SalesService.getDashboardStats(decoded.userId);\r\n        return res.status(200).json(stats);\r\n    } catch (error) {\r\n        logger.error(error, 'Sales Dashboard Error');\r\n        throw AppError.internal('Failed to fetch dashboard stats', error);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\api\\spots\\search.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[862,865],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[862,865],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1049,1052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1049,1052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2784,2787],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2784,2787],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { z } from 'zod'\r\nimport { db } from '../../lib/db.js'\r\nimport { fromZonedTime } from 'date-fns-tz'\r\nimport cors from '../../lib/cors.js'\r\n\r\n// Query Schema\r\nconst searchSchema = z.object({\r\n    buildingId: z.string().uuid(),\r\n    date: z.string().optional(), // ISO Date, defaults to today\r\n    durationType: z.enum(['11h', '23h']).optional()\r\n})\r\n\r\nexport default async function handler(req: VercelRequest, res: VercelResponse) {\r\n    await cors(req, res)\r\n    if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' })\r\n\r\n    try {\r\n        // Basic query parsing (req.query values are strings)\r\n        const buildingId = req.query.buildingId as string\r\n        const date = req.query.date as string\r\n        const durationType = req.query.durationType as any\r\n\r\n        const query = searchSchema.parse({\r\n            buildingId,\r\n            date,\r\n            durationType\r\n        })\r\n\r\n        // Filter Logic\r\n        const whereClause: any = {\r\n            status: 'available',\r\n            spot: {\r\n                buildingId: query.buildingId\r\n            }\r\n        }\r\n\r\n        if (query.date) {\r\n            // Fix: Use date-fns-tz for explicit timezone handling\r\n            const timeZone = 'America/Santiago'\r\n\r\n            // Parse the date string simply as a calendar date, then form the range in the specific timezone\r\n            const [year, month, day] = query.date.split('-').map(Number)\r\n\r\n            // Construct start of day in the target timezone\r\n            // Note: Month in Date constructor is 0-indexed\r\n            const startOfDay = fromZonedTime(new Date(year, month - 1, day, 0, 0, 0, 0), timeZone)\r\n\r\n            // Construct end of day in the target timezone\r\n            const endOfDay = fromZonedTime(new Date(year, month - 1, day, 23, 59, 59, 999), timeZone)\r\n\r\n            whereClause.startDatetime = {\r\n                gte: startOfDay,\r\n                lte: endOfDay\r\n            }\r\n        }\r\n\r\n        if (query.durationType) {\r\n            // Map '11h' -> 'ELEVEN_HOURS' for Prisma\r\n            const durationMap: Record<string, 'ELEVEN_HOURS' | 'TWENTY_THREE_HOURS'> = {\r\n                '11h': 'ELEVEN_HOURS',\r\n                '23h': 'TWENTY_THREE_HOURS'\r\n            }\r\n            whereClause.durationType = durationMap[query.durationType]\r\n        }\r\n\r\n        const blocks = await db.availabilityBlock.findMany({\r\n            where: whereClause,\r\n            include: {\r\n                spot: true // Include spot number info\r\n            },\r\n            orderBy: {\r\n                startDatetime: 'asc'\r\n            }\r\n        })\r\n\r\n        return res.status(200).json({ success: true, data: blocks })\r\n\r\n    } catch (error: any) {\r\n        if (error instanceof z.ZodError) {\r\n            return res.status(400).json({ error: error.errors })\r\n        }\r\n        console.error(error)\r\n        return res.status(500).json({ error: 'Internal Server Error' })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\app.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'logger' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cors' is defined but never used.","line":25,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AppError' is defined but never used.","line":58,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":58,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ErrorCode' is defined but never used.","line":58,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":58,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2333,2336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2333,2336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2343,2346],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2343,2346],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2357,2360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2357,2360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2367,2370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2367,2370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2378,2381],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2378,2381],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2531,2534],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2531,2534],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2541,2544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2541,2544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2730,2733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2730,2733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2740,2743],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2740,2743],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2853,2856],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2853,2856],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2863,2866],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2863,2866],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2983,2986],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2983,2986],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2993,2996],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2993,2996],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3104,3107],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3104,3107],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3114,3117],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3114,3117],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3222,3225],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3222,3225],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3232,3235],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3232,3235],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":94,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3349,3352],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3349,3352],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":94,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3359,3362],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3359,3362],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3470,3473],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3470,3473],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3480,3483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3480,3483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3582,3585],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3582,3585],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3592,3595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3592,3595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3702,3705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3702,3705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3712,3715],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3712,3715],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3815,3818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3815,3818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3825,3828],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3825,3828],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":115,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3995,3998],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3995,3998],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":115,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4005,4008],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4005,4008],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":122,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4262,4265],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4262,4265],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":122,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4272,4275],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4272,4275],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4393,4396],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4393,4396],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4403,4406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4403,4406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4515,4518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4515,4518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4525,4528],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4525,4528],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4631,4634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4631,4634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4641,4644],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4641,4644],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":139,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":139,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4771,4774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4771,4774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":139,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":139,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4781,4784],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4781,4784],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":143,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4892,4895],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4892,4895],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":143,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4902,4905],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4902,4905],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":150,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":150,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5141,5144],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5141,5144],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":150,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":150,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5151,5154],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5151,5154],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":154,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5266,5269],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5266,5269],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":154,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5276,5279],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5276,5279],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5382,5385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5382,5385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5392,5395],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5392,5395],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":163,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":163,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5497,5500],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5497,5500],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":52,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'dotenv/config';\r\nimport express from 'express';\r\nimport { initSentry } from './lib/sentry.js';\r\nimport { logger } from './lib/logger.js';\r\n\r\n// Init Sentry\r\ninitSentry();\r\nimport loginHandler from './api/auth/login.js';\r\nimport signupHandler from './api/auth/signup.js';\r\nimport searchHandler from './api/spots/search.js';\r\nimport createBookingHandler from './api/bookings/create.js';\r\nimport checkoutHandler from './api/payments/checkout.js';\r\nimport webhookHandler from './api/payments/webhook.js';\r\nimport listBuildingsHandler from './api/buildings/list.js';\r\nimport healthHandler from './api/health.js';\r\nimport statsHandler from './api/admin/stats.js';\r\nimport pricesHandler from './api/admin/prices.js';\r\nimport forgotPasswordHandler from './api/auth/forgot-password.js';\r\nimport resetPasswordHandler from './api/auth/reset-password.js';\r\nimport workerHandler from './api/cron/worker.js';\r\nimport reconcileHandler from './api/cron/reconcile.js';\r\nimport adminAnalyticsHandler from './api/admin/analytics.js';\r\nimport adminUsersHandler from './api/admin/users.js';\r\n\r\nimport cors from 'cors';\r\nimport compression from 'compression';\r\nimport helmet from 'helmet';\r\nimport { generalLimiter, authLimiter } from './middleware/rateLimiter.js';\r\n\r\nconst app = express();\r\napp.use(compression());\r\napp.use(helmet({\r\n    hsts: {\r\n        maxAge: 31536000,\r\n        includeSubDomains: true,\r\n        preload: true\r\n    },\r\n    referrerPolicy: {\r\n        policy: 'strict-origin-when-cross-origin'\r\n    },\r\n    xFrameOptions: { action: 'deny' },\r\n    contentSecurityPolicy: {\r\n        directives: {\r\n            defaultSrc: [\"'none'\"],\r\n        }\r\n    }\r\n}));\r\napp.use(generalLimiter);\r\n// CORS is handled by individual Vercel-style handlers (e.g. login.ts) via lib/cors.ts wrapper.\r\n// Do NOT add global CORS here to avoid duplicate headers and dev/prod parity issues.\r\n// app.use(cors({...}));\r\napp.use(express.json());\r\n\r\n// Shim for Vercel Request/Response if needed, but Express req/res are compatible enough for basic JSON usage.\r\n// VercelRequest extends http.IncomingMessage, Express Request does too.\r\n\r\nimport { errorHandler } from './middleware/errorHandler.js';\r\nimport { AppError, ErrorCode } from './lib/errors.js';\r\n\r\n// ... (previous imports)\r\n\r\n// Helper to catch async errors\r\nconst asyncHandler = (fn: (...args: any[]) => any) => (req: any, res: any, next: any) => {\r\n    Promise.resolve(fn(req, res, next)).catch(next);\r\n};\r\n\r\n// ... (app setup)\r\n\r\napp.post('/api/auth/login', authLimiter, asyncHandler((req: any, res: any) => {\r\n    // Cast to any to satisfy Vercel vs Express type mismatch if strict\r\n    return loginHandler(req, res);\r\n}));\r\n\r\napp.post('/api/auth/signup', authLimiter, asyncHandler((req: any, res: any) => {\r\n    return signupHandler(req, res);\r\n}));\r\n\r\napp.post('/api/auth/forgot-password', asyncHandler((req: any, res: any) => {\r\n    return forgotPasswordHandler(req, res);\r\n}));\r\n\r\napp.post('/api/auth/reset-password', asyncHandler((req: any, res: any) => {\r\n    return resetPasswordHandler(req, res);\r\n}));\r\n\r\napp.get('/api/spots/search', asyncHandler((req: any, res: any) => {\r\n    return searchHandler(req, res);\r\n}));\r\n\r\napp.post('/api/bookings/create', asyncHandler((req: any, res: any) => {\r\n    return createBookingHandler(req, res);\r\n}));\r\n\r\napp.post('/api/payments/checkout', asyncHandler((req: any, res: any) => {\r\n    return checkoutHandler(req, res);\r\n}));\r\n\r\napp.post('/api/payments/webhook', asyncHandler((req: any, res: any) => {\r\n    return webhookHandler(req, res);\r\n}));\r\n\r\napp.get('/api/buildings', asyncHandler((req: any, res: any) => {\r\n    return listBuildingsHandler(req, res);\r\n}));\r\n\r\napp.get('/api/admin/stats', asyncHandler((req: any, res: any) => {\r\n    return statsHandler(req, res);\r\n}));\r\n\r\napp.put('/api/admin/prices', asyncHandler((req: any, res: any) => {\r\n    return pricesHandler(req, res);\r\n}));\r\n\r\nimport buildingsAdminHandler from './api/admin/buildings.js';\r\napp.all('/api/admin/buildings', asyncHandler((req: any, res: any) => {\r\n    return buildingsAdminHandler(req, res);\r\n}));\r\n\r\nimport conciergeDashboardHandler from './api/concierge/dashboard.js';\r\nimport conciergeVerifyHandler from './api/concierge/verify.js';\r\n\r\napp.get('/api/concierge/dashboard', asyncHandler((req: any, res: any) => {\r\n    return conciergeDashboardHandler(req, res);\r\n}));\r\n\r\napp.post('/api/concierge/verify', asyncHandler((req: any, res: any) => {\r\n    return conciergeVerifyHandler(req, res);\r\n}));\r\n\r\napp.get('/api/cron/worker', asyncHandler((req: any, res: any) => {\r\n    return workerHandler(req, res);\r\n}));\r\n\r\napp.get('/api/cron/reconcile', asyncHandler((req: any, res: any) => {\r\n    return reconcileHandler(req, res);\r\n}));\r\n\r\n// Admin Dashboard\r\napp.get('/api/admin/analytics', asyncHandler((req: any, res: any) => {\r\n    return adminAnalyticsHandler(req, res);\r\n}));\r\n\r\napp.all('/api/admin/users', asyncHandler((req: any, res: any) => {\r\n    return adminUsersHandler(req, res);\r\n}));\r\n\r\nimport salesDashboardHandler from './api/sales/dashboard.js';\r\nimport salesBuildingsHandler from './api/sales/buildings.js';\r\n\r\napp.get('/api/sales/dashboard', asyncHandler((req: any, res: any) => {\r\n    return salesDashboardHandler(req, res);\r\n}));\r\n\r\napp.get('/api/sales/buildings', asyncHandler((req: any, res: any) => {\r\n    return salesBuildingsHandler(req, res);\r\n}));\r\n\r\napp.get('/api/health', asyncHandler((req: any, res: any) => {\r\n    return healthHandler(req, res);\r\n}));\r\n\r\n// Global Error Handler\r\napp.use(errorHandler as any);\r\n\r\nexport { app };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\dev-server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\cors.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[261,264],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[261,264],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[412,415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[412,415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport Cors from 'cors'\r\n\r\n// Helper method to wait for a middleware to execute before continuing\r\n// And to throw an error when an error happens in a middleware\r\nfunction initMiddleware(middleware: any) {\r\n    return (req: VercelRequest, res: VercelResponse) =>\r\n        new Promise((resolve, reject) => {\r\n            middleware(req, res, (result: any) => {\r\n                if (result instanceof Error) {\r\n                    return reject(result)\r\n                }\r\n                return resolve(result)\r\n            })\r\n        })\r\n}\r\n\r\n// Initialize the cors middleware\r\nconst whitelist = [\r\n    'http://localhost:5173',\r\n    'https://cortega26.github.io',\r\n    ...(process.env.FRONTEND_URL ? [process.env.FRONTEND_URL] : [])\r\n];\r\n\r\nconst corsMiddleware = initMiddleware(\r\n    Cors({\r\n        origin: function (origin, callback) {\r\n            // Strict Regex: only allows https://<subdomain>.vercel.app (escaped dot)\r\n            if (!origin || whitelist.indexOf(origin) !== -1 || origin.match(/^https:\\/\\/[\\w-]+\\.vercel\\.app$/)) {\r\n                callback(null, true)\r\n            } else {\r\n                callback(new Error('Not allowed by CORS'))\r\n            }\r\n        },\r\n        credentials: true,\r\n        methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\r\n    })\r\n)\r\n\r\nexport default corsMiddleware\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\crypto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\domain\\pricing.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'APP_CONSTANTS' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { APP_CONSTANTS } from '../constants.js'\r\n\r\n/**\r\n * Calculates the total price and commission for a booking using Integer Math.\r\n * \r\n * @param basePriceClp - The base price of the parking spot in CLP (Integer)\r\n * @param commissionRate - The commission rate as a decimal (e.g., 0.10 for 10%)\r\n * @param multiplier - Yield management multiplier (default: 1.0)\r\n * @returns Object containing commission and final payout distribution\r\n */\r\nexport function calculateBookingPricing(basePriceClp: number, commissionRate: number, multiplier: number = 1.0) {\r\n    if (!Number.isInteger(basePriceClp)) {\r\n        throw new Error('Base Price must be an integer')\r\n    }\r\n    if (basePriceClp < 0) {\r\n        throw new Error('Amount cannot be negative')\r\n    }\r\n\r\n    // Apply Multiplier (Yield Management)\r\n    // Example: 5000 * 2.0 = 10000\r\n    const finalPriceClp = Math.ceil(basePriceClp * multiplier);\r\n\r\n    // Commission is based on the FINAL price\r\n    // Example: 10000 * 0.10 = 1000\r\n    const commissionClp = Math.ceil(finalPriceClp * commissionRate)\r\n\r\n    // Remaining amount for the building/owner\r\n    const ownerAmountClp = finalPriceClp - commissionClp\r\n\r\n    return {\r\n        totalAmountClp: finalPriceClp,\r\n        commissionClp,\r\n        ownerAmountClp,\r\n        originalPriceClp: basePriceClp,\r\n        appliedMultiplier: multiplier\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\errors.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[827,830],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[827,830],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1015,1018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1015,1018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1046,1049],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1046,1049],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":111,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":114,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1788,1791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1788,1791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":113,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":116,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2016,2019],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2016,2019],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":110,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":113,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2241,2244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2241,2244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":109,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":112,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2465,2468],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2465,2468],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2642,2645],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2642,2645],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2672,2675],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2672,2675],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export enum ErrorCode {\r\n    // Auth - Login\r\n    AUTH_INVALID_CREDENTIALS = 'AUTH-LOGIN-1001',\r\n    AUTH_ACCOUNT_LOCKED = 'AUTH-LOGIN-1002',\r\n    AUTH_NOT_VERIFIED = 'AUTH-LOGIN-1003',\r\n    AUTH_INACTIVE = 'AUTH-LOGIN-1004',\r\n\r\n    // Auth - Token\r\n    AUTH_INVALID_TOKEN = 'AUTH-TOKEN-1001',\r\n    AUTH_NO_TOKEN = 'AUTH-TOKEN-1002',\r\n\r\n    // Validation\r\n    VALIDATION_BAD_REQUEST = 'VAL-INPUT-1001',\r\n\r\n    // System\r\n    SYSTEM_INTERNAL_ERROR = 'SYS-INTERNAL-5000',\r\n    SYSTEM_METHOD_NOT_ALLOWED = 'SYS-HTTP-405',\r\n    SYSTEM_RESOURCE_NOT_FOUND = 'SYS-RESOURCE-404'\r\n}\r\n\r\nexport class AppError extends Error {\r\n    public readonly code: string;\r\n    public readonly statusCode: number;\r\n    public readonly publicMessage: string;\r\n    public readonly internalMessage: string;\r\n    public readonly context?: Record<string, any>;\r\n\r\n    constructor(params: {\r\n        code: string;\r\n        statusCode: number;\r\n        publicMessage: string;\r\n        internalMessage?: string;\r\n        context?: Record<string, any>;\r\n        originalError?: any;\r\n    }) {\r\n        super(params.internalMessage || params.publicMessage);\r\n        this.name = 'AppError';\r\n        this.code = params.code;\r\n        this.statusCode = params.statusCode;\r\n        this.publicMessage = params.publicMessage;\r\n        this.internalMessage = params.internalMessage || params.publicMessage;\r\n        this.context = params.context;\r\n\r\n        // Preserve stack trace\r\n        if (params.originalError instanceof Error) {\r\n            this.stack = params.originalError.stack;\r\n        } else {\r\n            Error.captureStackTrace(this, this.constructor);\r\n        }\r\n    }\r\n\r\n    // Factory Methods\r\n    static badRequest(code: string, publicMessage: string, internalMessage?: string, context?: Record<string, any>) {\r\n        return new AppError({ code, statusCode: 400, publicMessage, internalMessage, context });\r\n    }\r\n\r\n    static unauthorized(code: string, publicMessage: string, internalMessage?: string, context?: Record<string, any>) {\r\n        return new AppError({ code, statusCode: 401, publicMessage, internalMessage, context });\r\n    }\r\n\r\n    static forbidden(code: string, publicMessage: string, internalMessage?: string, context?: Record<string, any>) {\r\n        return new AppError({ code, statusCode: 403, publicMessage, internalMessage, context });\r\n    }\r\n\r\n    static notFound(code: string, publicMessage: string, internalMessage?: string, context?: Record<string, any>) {\r\n        return new AppError({ code, statusCode: 404, publicMessage, internalMessage, context });\r\n    }\r\n\r\n    static internal(internalMessage: string, originalError?: any, context?: Record<string, any>) {\r\n        return new AppError({\r\n            code: ErrorCode.SYSTEM_INTERNAL_ERROR,\r\n            statusCode: 500,\r\n            publicMessage: 'An internal server error occurred',\r\n            internalMessage,\r\n            originalError,\r\n            context\r\n        });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\event-bus.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[944,947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[944,947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":125,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":125,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4341,4344],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4341,4344],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { db, ActorType } from './db.js';\r\nimport { publisher, subscriber, connectPubSub } from './redis-pubsub.js';\r\nimport { logger } from './logger.js';\r\n\r\nexport enum EventType {\r\n    // System Events\r\n    SYSTEM_STARTUP = 'SYSTEM_STARTUP',\r\n    SYSTEM_ERROR = 'SYSTEM_ERROR',\r\n\r\n    // Auth Events\r\n    USER_LOGIN_SUCCESS = 'USER_LOGIN_SUCCESS',\r\n    USER_LOGIN_FAILED = 'USER_LOGIN_FAILED',\r\n\r\n    // Business Logic Events\r\n    BOOKING_CREATED = 'BOOKING_CREATED',\r\n    BOOKING_CANCELLED = 'BOOKING_CANCELLED',\r\n\r\n    // Generic\r\n    TEST_ACTION = 'TEST_ACTION',\r\n\r\n    // Audit\r\n    AUDIT_LOG_CREATED = 'AUDIT_LOG_CREATED',\r\n\r\n    // Security\r\n    SUSPICIOUS_ACTIVITY = 'SUSPICIOUS_ACTIVITY'\r\n}\r\n\r\nexport interface AuditEvent {\r\n    actorId: string;\r\n    actorType: ActorType;\r\n    action: EventType | string;\r\n    entityId?: string;\r\n    entityType?: 'User' | 'Booking' | 'Building' | 'System' | string;\r\n    metadata?: Record<string, any>;\r\n    ipAddress?: string;\r\n    userAgent?: string;\r\n    timestamp?: number;\r\n    originInstanceId?: string; // To prevent infinite loops if we rebroadcast\r\n}\r\n\r\ntype EventHandler = (event: AuditEvent) => Promise<void>;\r\n\r\nconst CHANNEL_NAME = 'DISTRIBUTED_EVENT_BUS';\r\nconst INSTANCE_ID = Math.random().toString(36).substring(7);\r\n\r\nexport class EventBus {\r\n    private static instance: EventBus;\r\n    private subscribers: Map<string, EventHandler[]> = new Map();\r\n    private isRedisConnected = false;\r\n\r\n    private constructor() {\r\n        this.initializeRedis();\r\n\r\n        // 1. Subscribe to Audit Persistence (Always runs on every instance eventually, \r\n        // but ideally only one instance should write to DB to allow read-replicas. \r\n        // For MVP, every instance writing their OWN events is fine. \r\n        // Wait, if I publish to Redis, ALL instances receive it. \r\n        // Only the ORIGIN should persist to DB? Or a dedicated \"WriterService\"?\r\n        // Let's decided: Only the instance that GENERATED the event persists it to DB initially. \r\n        // Redis uses for side-effects (Notifications, Cache Invalidation).\r\n\r\n        this.subscribeToAll(async (event) => {\r\n            // Only persist if we are the origin, OR if we want redundant logging.\r\n            // Actually, `publish` calls persist directly usually. \r\n            // Let's decouple: `publish` -> Persist DB -> Publish Redis\r\n            if (event.originInstanceId === INSTANCE_ID) {\r\n                await this.persistEvent(event);\r\n            }\r\n        });\r\n    }\r\n\r\n    private async initializeRedis() {\r\n        try {\r\n            await connectPubSub();\r\n\r\n            subscriber.subscribe(CHANNEL_NAME, (err) => {\r\n                if (err) console.error('[EventBus] Redis Subscribe Error:', err);\r\n                else {\r\n                    this.isRedisConnected = true;\r\n                    logger.info(`[EventBus] Subscribed to ${CHANNEL_NAME} as ${INSTANCE_ID}`);\r\n                }\r\n            });\r\n\r\n            subscriber.on('message', (channel, message) => {\r\n                if (channel === CHANNEL_NAME) {\r\n                    this.handleRedisMessage(message);\r\n                }\r\n            });\r\n        } catch (error) {\r\n            console.error('[EventBus] Failed to init Redis:', error);\r\n        }\r\n    }\r\n\r\n    private async handleRedisMessage(rawMessage: string) {\r\n        try {\r\n            const event: AuditEvent = JSON.parse(rawMessage);\r\n\r\n            // Ignore events sent by MYSELF (loopback prevention for side-effects if needed)\r\n            if (event.originInstanceId === INSTANCE_ID) return;\r\n\r\n            // Trigger local subscribers (e.g. Cache Invalidators on other pods)\r\n            this.triggerLocalHandlers(event);\r\n\r\n        } catch (error) {\r\n            console.error('[EventBus] Parse error:', error);\r\n        }\r\n    }\r\n\r\n    public static getInstance(): EventBus {\r\n        if (!EventBus.instance) {\r\n            EventBus.instance = new EventBus();\r\n        }\r\n        return EventBus.instance;\r\n    }\r\n\r\n    public subscribe(eventType: EventType, handler: EventHandler): void {\r\n        if (!this.subscribers.has(eventType)) {\r\n            this.subscribers.set(eventType, []);\r\n        }\r\n        this.subscribers.get(eventType)?.push(handler);\r\n    }\r\n\r\n    public subscribeToAll(handler: EventHandler): void {\r\n        this.subscribe('*' as any, handler);\r\n    }\r\n\r\n    public async publish(event: AuditEvent): Promise<void> {\r\n        // 1. Tag Event\r\n        event.timestamp = Date.now();\r\n        event.originInstanceId = INSTANCE_ID;\r\n\r\n        // 2. Trigger Local Handlers (Immediate feedback)\r\n        await this.triggerLocalHandlers(event);\r\n\r\n        // 3. Publish to Redis (Async distribution)\r\n        if (this.isRedisConnected) {\r\n            publisher.publish(CHANNEL_NAME, JSON.stringify(event)).catch(err => {\r\n                console.error('[EventBus] Redis Publish Error:', err);\r\n            });\r\n        }\r\n    }\r\n\r\n    private async triggerLocalHandlers(event: AuditEvent) {\r\n        // Notify specific subscribers\r\n        const specificHandlers = this.subscribers.get(event.action) || [];\r\n        // Notify \"all\" subscribers\r\n        const globalHandlers = this.subscribers.get('*') || [];\r\n\r\n        const allHandlers = [...specificHandlers, ...globalHandlers];\r\n\r\n        // Execute handlers\r\n        await Promise.allSettled(allHandlers.map(h => h(event)));\r\n    }\r\n\r\n    private async persistEvent(event: AuditEvent): Promise<void> {\r\n        try {\r\n            await db.auditLog.create({\r\n                data: {\r\n                    actorId: event.actorId,\r\n                    actorType: event.actorType,\r\n                    action: event.action,\r\n                    entityId: event.entityId,\r\n                    entityType: event.entityType,\r\n                    metadata: event.metadata || {},\r\n                    ipAddress: event.ipAddress,\r\n                    userAgent: event.userAgent,\r\n                },\r\n            });\r\n        } catch (error) {\r\n            console.error('[EventBus] Failed to persist event:', error);\r\n        }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\redis-pubsub.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\redis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\lib\\sentry.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[892,895],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[892,895],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[922,925],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[922,925],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as Sentry from '@sentry/node';\r\nimport { nodeProfilingIntegration } from '@sentry/profiling-node';\r\nimport { logger } from './logger.js';\r\n\r\nexport function initSentry() {\r\n    if (!process.env.SENTRY_DSN) {\r\n        logger.warn('⚠️ Sentry initialized (Mock Mode - No DSN).');\r\n        return;\r\n    }\r\n\r\n    Sentry.init({\r\n        dsn: process.env.SENTRY_DSN,\r\n        integrations: [\r\n            nodeProfilingIntegration(),\r\n        ],\r\n        // Performance Monitoring\r\n        tracesSampleRate: 1.0, // Capture 100% of the transactions (adjust for prod)\r\n        // Set sampling rate for profiling - this is relative to tracesSampleRate\r\n        profilesSampleRate: 1.0,\r\n        environment: process.env.NODE_ENV || 'development',\r\n    });\r\n\r\n    logger.info('✅ Sentry initialized.');\r\n}\r\n\r\n// Helper to capture exceptions with context\r\nexport function captureException(error: any, context?: Record<string, any>) {\r\n    if (!process.env.SENTRY_DSN) return;\r\n\r\n    Sentry.captureException(error, {\r\n        extra: context\r\n    });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\middleware\\errorHandler.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[230,233],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[230,233],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'next' is defined but never used. Allowed unused args must match /^_/u.","line":6,"column":69,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":73},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1182,1185],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1182,1185],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Request, Response, NextFunction } from 'express';\r\nimport { AppError, ErrorCode } from '../lib/errors.js';\r\nimport { logger } from '../lib/logger.js';\r\nimport { ZodError } from 'zod';\r\n\r\nexport const errorHandler = (err: any, req: Request, res: Response, next: NextFunction) => {\r\n    let error = err;\r\n\r\n    // 1. Transform Third-Party Errors to AppError\r\n    if (err instanceof ZodError) {\r\n        error = new AppError({\r\n            code: ErrorCode.VALIDATION_BAD_REQUEST,\r\n            statusCode: 400,\r\n            publicMessage: 'Invalid input data',\r\n            internalMessage: 'Zod Validation Failed',\r\n            context: { issues: err.errors }\r\n        });\r\n    }\r\n\r\n    // 2. Wrap Unknown Errors\r\n    if (!(error instanceof AppError)) {\r\n        error = AppError.internal('Unknown error occurred', err);\r\n    }\r\n\r\n    const appError = error as AppError;\r\n\r\n    // 3. Structured Logging\r\n    logger.error({\r\n        code: appError.code,\r\n        internalMessage: appError.internalMessage,\r\n        context: appError.context,\r\n        stack: appError.stack,\r\n        method: req.method,\r\n        path: req.path,\r\n        ip: req.ip,\r\n        requestId: (req as any).id\r\n    }, `[${appError.code}] ${appError.internalMessage}`);\r\n\r\n    // 4. Send Response\r\n    // We include 'error' field for backward compatibility with frontend toast messages\r\n    res.status(appError.statusCode).json({\r\n        success: false,\r\n        code: appError.code,\r\n        message: appError.publicMessage,\r\n        error: appError.publicMessage, // Back-compat\r\n        context: appError.context\r\n    });\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\middleware\\rateLimiter.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AppError' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ErrorCode' is defined but never used.","line":4,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Request, Response, NextFunction } from 'express';\r\nimport { redis } from '../lib/redis.js';\r\nimport { logger } from '../lib/logger.js';\r\nimport { AppError, ErrorCode } from '../lib/errors.js';\r\n\r\ninterface RateLimitConfig {\r\n    windowMs: number;\r\n    max: number;\r\n    keyPrefix: string;\r\n}\r\n\r\nexport function createRateLimiter(config: RateLimitConfig) {\r\n    return async (req: Request, res: Response, next: NextFunction) => {\r\n        // If Redis is down/null, fail open (allow request) but log warning\r\n        if (redis.status !== 'ready') {\r\n            return next();\r\n        }\r\n\r\n        const ip = req.headers['x-forwarded-for'] || req.socket.remoteAddress || 'unknown';\r\n        const key = `ratelimit:${config.keyPrefix}:${ip}`;\r\n\r\n        try {\r\n            const requests = await redis.incr(key);\r\n\r\n            if (requests === 1) {\r\n                await redis.expire(key, Math.ceil(config.windowMs / 1000));\r\n            }\r\n\r\n            if (requests > config.max) {\r\n                logger.warn({ ip, prefix: config.keyPrefix }, 'Rate limit exceeded');\r\n                return res.status(429).json({\r\n                    error: 'Too many requests, please try again later.',\r\n                    code: 'RATE_LIMIT_EXCEEDED'\r\n                });\r\n            }\r\n\r\n            next();\r\n        } catch (error) {\r\n            logger.error({ err: error }, 'Rate limiter error');\r\n            // Fail open\r\n            next();\r\n        }\r\n    };\r\n}\r\n\r\n// Standard Limits\r\nexport const generalLimiter = createRateLimiter({\r\n    windowMs: 15 * 60 * 1000, // 15 minutes\r\n    max: 100,\r\n    keyPrefix: 'general'\r\n});\r\n\r\nexport const authLimiter = createRateLimiter({\r\n    windowMs: 60 * 1000, // 1 minute\r\n    max: 5, // 5 attempts per minute\r\n    keyPrefix: 'auth'\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\prisma\\seed-demo.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":7,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":7,"endColumn":16,"suggestions":[{"fix":{"range":[193,231],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":19,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":19,"endColumn":16,"suggestions":[{"fix":{"range":[554,604],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'resident' is assigned a value but never used.","line":33,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":23},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":44,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":44,"endColumn":20,"suggestions":[{"fix":{"range":[1432,1486],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":90,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":90,"endColumn":16,"suggestions":[{"fix":{"range":[2898,2963],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient, DurationType, SpotStatus } from '@prisma/client'\r\nimport { hashPassword } from '../services/auth.js'\r\n\r\nconst prisma = new PrismaClient()\r\n\r\nasync function main() {\r\n    console.log('🌱 Seeding Demo Data...')\r\n\r\n    // 1. Create Building\r\n    const building = await prisma.building.create({\r\n        data: {\r\n            name: 'Edificio Demo Centro',\r\n            address: 'Av. Providencia 2000',\r\n            contactEmail: 'contacto@demo.cl',\r\n            totalUnits: 50,\r\n            visitorSpotsCount: 5\r\n        }\r\n    })\r\n    console.log(`Checking Building: ${building.name}`)\r\n\r\n    // 2. Create Units\r\n    const unitsData = ['101', '102', '201', '202', '301']\r\n    for (const num of unitsData) {\r\n        await prisma.unit.create({\r\n            data: { buildingId: building.id, unitNumber: num }\r\n        })\r\n    }\r\n\r\n    // 3. Create Demo Resident\r\n    const unit101 = await prisma.unit.findFirst({ where: { buildingId: building.id, unitNumber: '101' } })\r\n    if (unit101) {\r\n        const pass = await hashPassword('123456')\r\n        const resident = await prisma.resident.create({\r\n            data: {\r\n                unitId: unit101.id,\r\n                email: 'demo@resident.cl',\r\n                firstName: 'Juan',\r\n                lastName: 'Pérez',\r\n                rut: '12345678-9',\r\n                passwordHash: pass,\r\n                isVerified: true\r\n            }\r\n        })\r\n        console.log(`User Created: demo@resident.cl / 123456`)\r\n    }\r\n\r\n    // 4. Create Visitor Spots\r\n    const spots = []\r\n    for (let i = 1; i <= 5; i++) {\r\n        const spot = await prisma.visitorSpot.create({\r\n            data: {\r\n                buildingId: building.id,\r\n                spotNumber: `V-0${i}`,\r\n                description: `Estacionamiento de Visita ${i}`\r\n            }\r\n        })\r\n        spots.push(spot)\r\n    }\r\n\r\n    // 5. Create Availability (Next 7 Days)\r\n    const today = new Date()\r\n    today.setHours(0, 0, 0, 0)\r\n\r\n    for (const spot of spots) {\r\n        for (let d = 0; d < 7; d++) {\r\n            const date = new Date(today)\r\n            date.setDate(date.getDate() + d)\r\n\r\n            // Create an 11h block (Morning)\r\n            const startAM = new Date(date)\r\n            startAM.setHours(8, 0, 0, 0)\r\n            const endAM = new Date(date)\r\n            endAM.setHours(19, 0, 0, 0)\r\n\r\n            // Randomly reserve some\r\n            const isReserved = Math.random() > 0.7\r\n\r\n            await prisma.availabilityBlock.create({\r\n                data: {\r\n                    spotId: spot.id,\r\n                    startDatetime: startAM,\r\n                    endDatetime: endAM,\r\n                    durationType: DurationType.ELEVEN_HOURS,\r\n                    basePriceClp: 2500,\r\n                    status: isReserved ? SpotStatus.reserved : SpotStatus.available\r\n                }\r\n            })\r\n        }\r\n    }\r\n    console.log(`✅ Demo Data Seeded! You can now Search in the App.`)\r\n}\r\n\r\nmain()\r\n    .catch((e) => {\r\n        console.error(e)\r\n        process.exit(1)\r\n    })\r\n    .finally(async () => {\r\n        await prisma.$disconnect()\r\n    })\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\prisma\\seed.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":7,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":7,"endColumn":16,"suggestions":[{"fix":{"range":[146,171],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":24,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":24,"endColumn":16,"suggestions":[{"fix":{"range":[656,697],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":35,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":35,"endColumn":16,"suggestions":[{"fix":{"range":[985,1024],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":49,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":49,"endColumn":20,"suggestions":[{"fix":{"range":[1424,1479],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":65,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":65,"endColumn":20,"suggestions":[{"fix":{"range":[2031,2087],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":81,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":81,"endColumn":20,"suggestions":[{"fix":{"range":[2639,2698],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":101,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":101,"endColumn":20,"suggestions":[{"fix":{"range":[3379,3441],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client'\r\nimport bcrypt from 'bcryptjs'\r\n\r\nconst prisma = new PrismaClient()\r\n\r\nasync function main() {\r\n    console.log('Seeding...')\r\n\r\n    // Hash password for all demo users\r\n    const passwordHash = await bcrypt.hash('password123', 10)\r\n\r\n    // 1. Building\r\n    const building = await prisma.building.upsert({\r\n        where: { id: 'demo-building' },\r\n        update: {},\r\n        create: {\r\n            id: 'demo-building',\r\n            name: 'Torres del Parque (Demo)',\r\n            address: 'Av. Kennedy 1234',\r\n            contactEmail: 'admin@torres.cl',\r\n            totalUnits: 100\r\n        }\r\n    })\r\n    console.log(`Building: ${building.name}`)\r\n\r\n    // 2. Unit\r\n    const unit = await prisma.unit.upsert({\r\n        where: { buildingId_unitNumber: { buildingId: building.id, unitNumber: '101' } },\r\n        update: {},\r\n        create: {\r\n            buildingId: building.id,\r\n            unitNumber: '101'\r\n        }\r\n    })\r\n    console.log(`Unit: ${unit.unitNumber}`)\r\n\r\n    // 3. Super Admin\r\n    try {\r\n        await prisma.user.upsert({\r\n            where: { email: 'admin@estacionate.cl' },\r\n            update: { passwordHash, isActive: true, role: 'admin' },\r\n            create: {\r\n                email: 'admin@estacionate.cl',\r\n                role: 'admin',\r\n                passwordHash,\r\n                isActive: true\r\n            }\r\n        })\r\n        console.log('User: admin@estacionate.cl / password123')\r\n    } catch (e) { console.error('Error creating admin', e) }\r\n\r\n    // 4. Building Admin\r\n    try {\r\n        await prisma.user.upsert({\r\n            where: { email: 'badmin@estacionate.cl' },\r\n            update: { passwordHash, isActive: true, role: 'building_admin', buildingId: building.id },\r\n            create: {\r\n                email: 'badmin@estacionate.cl',\r\n                role: 'building_admin',\r\n                buildingId: building.id,\r\n                passwordHash,\r\n                isActive: true\r\n            }\r\n        })\r\n        console.log('User: badmin@estacionate.cl / password123')\r\n    } catch (e) { console.error('Error creating building admin', e) }\r\n\r\n    // 5. Concierge\r\n    try {\r\n        await prisma.user.upsert({\r\n            where: { email: 'concierge@estacionate.cl' },\r\n            update: { passwordHash, isActive: true, role: 'concierge', buildingId: building.id },\r\n            create: {\r\n                email: 'concierge@estacionate.cl',\r\n                role: 'concierge',\r\n                buildingId: building.id,\r\n                passwordHash,\r\n                isActive: true\r\n            }\r\n        })\r\n        console.log('User: concierge@estacionate.cl / password123')\r\n    } catch (e) { console.error('Error creating concierge', e) }\r\n\r\n    // 6. Resident\r\n    try {\r\n        // Residents table is separate\r\n        await prisma.resident.upsert({\r\n            where: { email: 'resident@estacionate.cl' },\r\n            update: { passwordHash, isVerified: true, isActive: true, unitId: unit.id },\r\n            create: {\r\n                unitId: unit.id,\r\n                email: 'resident@estacionate.cl',\r\n                firstName: 'Demo',\r\n                lastName: 'Resident',\r\n                rut: '12345678-9',\r\n                passwordHash,\r\n                isVerified: true,\r\n                isActive: true\r\n            }\r\n        })\r\n        console.log('Resident: resident@estacionate.cl / password123')\r\n    } catch (e) { console.error('Error creating resident', e) }\r\n}\r\n\r\nmain()\r\n    .catch((e) => {\r\n        console.error(e)\r\n        process.exit(1)\r\n    })\r\n    .finally(async () => {\r\n        await prisma.$disconnect()\r\n    })\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\benchmark-users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\check-user.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\check-users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\create-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\create-concierge.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\debug-user-creation.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Role' is defined but never used.","line":3,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":" \r\n \r\nimport { PrismaClient, Role } from '@prisma/client';\r\nimport crypto from 'crypto';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nasync function main() {\r\n    const unique = crypto.randomUUID();\r\n    console.log(`Attempting to create user with unique: ${unique}`);\r\n\r\n    try {\r\n        const user = await prisma.user.create({\r\n            data: {\r\n                email: `debug-admin-${unique}@test.com`,\r\n                passwordHash: 'dummyhash',\r\n                // Try minimal fields first\r\n                role: 'admin', // Try string first, or Role.admin\r\n                isActive: true\r\n            }\r\n        });\r\n        console.log('User created successfully:', user);\r\n    } catch (e: any) {\r\n        console.error('FAILED TO CREATE USER');\r\n        console.error(JSON.stringify(e, null, 2));\r\n        // Also log message and code explicitly\r\n        console.error('Error Code:', e.code);\r\n        console.error('Error Message:', e.message);\r\n        if (e.meta) console.error('Meta:', e.meta);\r\n    } finally {\r\n        await prisma.$disconnect();\r\n    }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\diagnose-hang.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\diagnose-startup.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'logger' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { app } from '../app.js';\r\nimport { logger } from '../lib/logger.js';\r\n\r\nconsole.log('--- Starting Diagnostic Server ---');\r\ntry {\r\n    const server = app.listen(3001, () => {\r\n        console.log('--- Server Started on Port 3001 ---');\r\n        server.close();\r\n        console.log('--- Server Closed ---');\r\n        process.exit(0);\r\n    });\r\n\r\n    server.on('error', (err) => {\r\n        console.error('SERVER ERROR:', err);\r\n        process.exit(1);\r\n    });\r\n\r\n} catch (e) {\r\n    console.error('SYNC ERROR:', e);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\diagnose-user.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\force-available.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\manual-start.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\repro_login_failure.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\reproduce-checkout-error.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\reproduce-issue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\test-audit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\test-sales-commission.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":27,"column":5,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":27,"endColumn":18,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[813,826],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\scripts\\verify-cookie-login.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\services\\NotificationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\services\\SalesService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\services\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[627,630],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[627,630],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":28,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import jwt from 'jsonwebtoken'\r\nimport type { SignOptions } from 'jsonwebtoken'\r\nimport bcrypt from 'bcryptjs'\r\nimport { parse } from 'cookie'\r\nimport type { VercelRequest } from '@vercel/node'\r\n\r\nif (!process.env.JWT_SECRET) {\r\n    throw new Error('FATAL: JWT_SECRET must be defined in .env')\r\n}\r\nconst JWT_SECRET = process.env.JWT_SECRET\r\n\r\n// JWT\r\nexport interface TokenPayload {\r\n    userId: string\r\n    buildingId?: string\r\n    unitId?: string\r\n    role?: string\r\n}\r\n\r\nexport const signToken = (payload: TokenPayload, expiresIn: string | number = '7d') => {\r\n    const signOptions: SignOptions = { expiresIn: expiresIn as any }\r\n    return jwt.sign({ ...payload }, JWT_SECRET, signOptions)\r\n}\r\n\r\nexport const verifyToken = (token: string): TokenPayload | null => {\r\n    try {\r\n        return jwt.verify(token, JWT_SECRET) as TokenPayload\r\n    } catch (error) {\r\n        return null\r\n    }\r\n}\r\n\r\n\r\nexport const getTokenFromRequest = (req: VercelRequest): string | null => {\r\n    // 1. Try Cookie\r\n    if (req.headers.cookie) {\r\n        const cookies = parse(req.headers.cookie)\r\n        if (cookies.token) return cookies.token\r\n    }\r\n    // 2. Try Header (Fallback)\r\n    const authHeader = req.headers.authorization || req.headers.Authorization\r\n    if (authHeader && typeof authHeader === 'string') {\r\n        return authHeader.replace('Bearer ', '')\r\n    }\r\n    return null\r\n}\r\n\r\n// Password\r\nexport const hashPassword = async (password: string) => {\r\n    const salt = await bcrypt.genSalt(10)\r\n    return bcrypt.hash(password, salt)\r\n}\r\n\r\nexport const comparePassword = async (password: string, hash: string) => {\r\n    return bcrypt.compare(password, hash)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\services\\twilio.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\admin.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":207,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":207,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8270,8273],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8270,8273],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":208,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":208,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8351,8354],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8351,8354],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeAll, afterAll } from 'vitest';\r\nimport request from 'supertest';\r\nimport { app } from '../app.js';\r\nimport { PrismaClient, DurationType } from '@prisma/client';\r\nimport crypto from 'crypto';\r\nimport jwt from 'jsonwebtoken';\r\n\r\nconst prisma = new PrismaClient();\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'test-secret';\r\n\r\ndescribe('Admin API Integration Tests', () => {\r\n    let adminToken: string;\r\n    let buildingAdminToken: string;\r\n    let residentToken: string;\r\n\r\n    let buildingId: string;\r\n    let otherBuildingId: string;\r\n    let adminId: string;\r\n    let buildingAdminId: string;\r\n    let residentId: string;\r\n\r\n    let spotId: string;\r\n    let blockId: string;\r\n    let unique: string;\r\n\r\n    beforeAll(async () => {\r\n        try {\r\n            unique = crypto.randomUUID();\r\n\r\n            // 1. Create Buildings\r\n            const building = await prisma.building.create({\r\n                data: {\r\n                    name: `Admin Building ${unique}`,\r\n                    address: 'Admin St',\r\n                    totalUnits: 10,\r\n                    platformCommissionRate: 0.1,\r\n                    contactEmail: `admin-bld-${unique}@test.com`\r\n                }\r\n            });\r\n            buildingId = building.id;\r\n\r\n            const otherBuilding = await prisma.building.create({\r\n                data: {\r\n                    name: `Other Admin Building ${unique}`,\r\n                    address: 'Other Admin St',\r\n                    totalUnits: 5,\r\n                    contactEmail: `other-admin-${unique}@test.com`\r\n                }\r\n            });\r\n            otherBuildingId = otherBuilding.id;\r\n\r\n            // 2. Create Users & Tokens\r\n            // Super Admin\r\n            const admin = await prisma.user.create({\r\n                data: {\r\n                    email: `superadmin-${unique}@test.com`,\r\n                    passwordHash: 'hash',\r\n                    role: 'admin',\r\n                    isActive: true\r\n                }\r\n            });\r\n            adminId = admin.id;\r\n            adminToken = jwt.sign({ id: admin.id, email: admin.email, role: admin.role }, JWT_SECRET, { expiresIn: '1h' });\r\n\r\n            // Building Admin (Assigned to buildingId)\r\n            const bAdmin = await prisma.user.create({\r\n                data: {\r\n                    email: `badmin-${unique}@test.com`,\r\n                    passwordHash: 'hash',\r\n                    role: 'building_admin',\r\n                    buildingId: buildingId,\r\n                    isActive: true\r\n                }\r\n            });\r\n            buildingAdminId = bAdmin.id;\r\n            buildingAdminToken = jwt.sign({ id: bAdmin.id, email: bAdmin.email, role: bAdmin.role, buildingId: bAdmin.buildingId }, JWT_SECRET, { expiresIn: '1h' });\r\n\r\n            // Resident (No dashboard access)\r\n            const unit = await prisma.unit.create({ data: { buildingId, unitNumber: '101' } });\r\n            const resident = await prisma.resident.create({\r\n                data: { unitId: unit.id, email: `res-${unique}@test.com`, firstName: 'R', lastName: 'D', rut: `${unique.substring(0, 8)}-K`, isVerified: true }\r\n            });\r\n            residentId = resident.id;\r\n            residentToken = jwt.sign({ id: resident.id, email: resident.email, role: 'resident' }, JWT_SECRET, { expiresIn: '1h' }); // Residents usually don't have 'role' in JWT but let's simulate authentication\r\n\r\n            // 3. Data for Stats\r\n            // Create Spot\r\n            const spot = await prisma.visitorSpot.create({ data: { buildingId, spotNumber: 'V-1' } });\r\n            spotId = spot.id;\r\n\r\n            // Create Completed Booking (Revenue)\r\n            // Block must exist\r\n            const past = new Date();\r\n            past.setDate(past.getDate() - 1);\r\n            const block = await prisma.availabilityBlock.create({\r\n                data: {\r\n                    spotId,\r\n                    startDatetime: past,\r\n                    endDatetime: new Date(past.getTime() + 11 * 3600 * 1000),\r\n                    durationType: DurationType.ELEVEN_HOURS,\r\n                    basePriceClp: 5000,\r\n                    status: 'available' // Techincally 'booked' but for stats we join Booking\r\n                }\r\n            });\r\n\r\n            await prisma.booking.create({\r\n                data: {\r\n                    availabilityBlockId: block.id,\r\n                    residentId,\r\n                    vehiclePlate: 'ADM-123',\r\n                    visitorName: 'Visitor',\r\n                    amountClp: 5500,\r\n                    commissionClp: 500,\r\n                    status: 'completed',\r\n                    paymentStatus: 'paid',\r\n                    confirmationCode: 'ADM-1'\r\n                }\r\n            });\r\n\r\n            // Create Future Block (For Price Update Test)\r\n            const future = new Date();\r\n            future.setDate(future.getDate() + 5);\r\n            const futureBlock = await prisma.availabilityBlock.create({\r\n                data: {\r\n                    spotId,\r\n                    startDatetime: future,\r\n                    endDatetime: new Date(future.getTime() + 11 * 3600 * 1000),\r\n                    durationType: DurationType.ELEVEN_HOURS,\r\n                    basePriceClp: 5000,\r\n                    status: 'available'\r\n                }\r\n            });\r\n            blockId = futureBlock.id;\r\n\r\n        } catch (e) {\r\n            console.error('SETUP FAILED:', e);\r\n            throw e;\r\n        }\r\n    });\r\n\r\n    afterAll(async () => {\r\n        try {\r\n            await prisma.booking.deleteMany({ where: { residentId } });\r\n            await prisma.availabilityBlock.deleteMany({ where: { spotId } });\r\n            await prisma.visitorSpot.deleteMany({ where: { id: spotId } });\r\n            await prisma.resident.deleteMany({ where: { id: residentId } });\r\n            await prisma.unit.deleteMany({ where: { buildingId } });\r\n            await prisma.user.deleteMany({ where: { id: { in: [adminId, buildingAdminId] } } });\r\n            await prisma.building.deleteMany({ where: { id: { in: [buildingId, otherBuildingId] } } });\r\n        } catch (e) {\r\n            console.error('cleanup failed', e);\r\n        } finally {\r\n            await prisma.$disconnect();\r\n        }\r\n    });\r\n\r\n    // --- RBAC Tests ---\r\n    it('should deny access without token', async () => {\r\n        const res = await request(app).get('/api/admin/stats');\r\n        expect(res.status).toBe(401);\r\n    });\r\n\r\n    it('should deny access to regular resident', async () => {\r\n        const res = await request(app)\r\n            .get('/api/admin/stats')\r\n            .set('Authorization', `Bearer ${residentToken}`);\r\n        expect(res.status).toBe(403);\r\n    });\r\n\r\n    // --- Stats API ---\r\n    it('should return stats for Super Admin (All Buildings)', async () => {\r\n        const res = await request(app)\r\n            .get('/api/admin/stats')\r\n            .set('Authorization', `Bearer ${adminToken}`);\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.data.revenue).toBeGreaterThanOrEqual(5500);\r\n    });\r\n\r\n    it('should return stats for Building Admin (Own Building)', async () => {\r\n        const res = await request(app)\r\n            .get('/api/admin/stats')\r\n            .query({ buildingId }) // Even if they query, implementation forces their ID\r\n            .set('Authorization', `Bearer ${buildingAdminToken}`);\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.data.revenue).toBe(5500);\r\n    });\r\n\r\n    it('should deny Building Admin accessing other building', async () => {\r\n        const res = await request(app)\r\n            .get('/api/admin/stats')\r\n            .query({ buildingId: otherBuildingId })\r\n            .set('Authorization', `Bearer ${buildingAdminToken}`);\r\n\r\n        // The implementation: \"if (buildingId && buildingId !== user.buildingId) return 403\"\r\n        expect(res.status).toBe(403);\r\n    });\r\n\r\n    // --- Buildings API ---\r\n    it('should list buildings for Super Admin', async () => {\r\n        const res = await request(app)\r\n            .get('/api/admin/buildings')\r\n            .set('Authorization', `Bearer ${adminToken}`);\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.data.some((b: any) => b.id === buildingId)).toBe(true);\r\n        expect(res.body.data.some((b: any) => b.id === otherBuildingId)).toBe(true);\r\n    });\r\n\r\n    // --- Prices API ---\r\n    it('should update prices for future blocks', async () => {\r\n        const newPrice = 8000;\r\n        const res = await request(app)\r\n            .put('/api/admin/prices')\r\n            .set('Authorization', `Bearer ${adminToken}`)\r\n            .send({ buildingId, newPrice });\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.updatedCount).toBeGreaterThanOrEqual(1);\r\n\r\n        // Verify DB update\r\n        const updatedBlock = await prisma.availabilityBlock.findUnique({ where: { id: blockId } });\r\n        expect(updatedBlock?.basePriceClp).toBe(newPrice);\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\audit-logic-safety.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[226,229],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[226,229],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[706,709],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[706,709],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":99,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2780,2783],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2780,2783],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":99,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2796,2799],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2796,2799],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":138,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4678,4681],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4678,4681],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":138,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4694,4697],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4694,4697],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { describe, it, expect, vi, beforeEach } from 'vitest'\r\nimport { subDays, addHours } from 'date-fns'\r\n\r\n// Mocks\r\nconst mockRes = {\r\n    status: vi.fn().mockReturnThis(),\r\n    json: vi.fn()\r\n}\r\nconst mockReq = (body: any = {}) => ({\r\n    method: 'POST',\r\n    headers: { authorization: 'Bearer token' },\r\n    body\r\n})\r\n\r\n// Mock Modules\r\nconst mockTx = {\r\n    availabilityBlock: {\r\n        updateMany: vi.fn(),\r\n        findUniqueOrThrow: vi.fn(),\r\n        findFirst: vi.fn() // I expect to add this call\r\n    },\r\n    booking: {\r\n        create: vi.fn()\r\n    },\r\n    visitorSpot: {\r\n        update: vi.fn()\r\n    }\r\n}\r\n\r\nvi.mock('../lib/db.js', () => ({\r\n    db: {\r\n        $transaction: async (cb: any) => cb(mockTx)\r\n    }\r\n}))\r\n\r\nvi.mock('../services/auth.js', () => ({\r\n    getTokenFromRequest: vi.fn().mockReturnValue('token'),\r\n    // Mock user as resident (buildingId match for IDOR check)\r\n    verifyToken: vi.fn().mockReturnValue({\r\n        role: 'resident',\r\n        userId: 'res1',\r\n        buildingId: 'building-123'\r\n    })\r\n}))\r\n\r\nvi.mock('../lib/cors.js', () => ({\r\n    default: vi.fn()\r\n}))\r\n\r\nvi.mock('../lib/domain/pricing.js', () => ({\r\n    calculateBookingPricing: vi.fn().mockReturnValue({\r\n        totalAmountClp: 5000,\r\n        commissionClp: 500,\r\n        ownerAmountClp: 4500\r\n    })\r\n}))\r\n\r\nimport createBookingHandler from '../api/bookings/create.js'\r\n\r\ndescribe.skip('Audit: Business Logic Safety', () => {\r\n\r\n    beforeEach(() => {\r\n        vi.clearAllMocks()\r\n        // Default happy path for updateMany (successful lock)\r\n        mockTx.availabilityBlock.updateMany.mockResolvedValue({ count: 1 })\r\n        mockTx.booking.create.mockResolvedValue({ id: 'new-booking' })\r\n    })\r\n\r\n    const PAST_BLOCK_ID = '123e4567-e89b-12d3-a456-426614174001'\r\n    const FUTURE_BLOCK_ID = '123e4567-e89b-12d3-a456-426614174002'\r\n\r\n    // Valid future dummy block\r\n    const validBlock = {\r\n        id: FUTURE_BLOCK_ID,\r\n        spotId: 'spot-1',\r\n        startDatetime: addHours(new Date(), 24),\r\n        endDatetime: addHours(new Date(), 26),\r\n        basePriceClp: 5000,\r\n        spot: { buildingId: 'building-123' } // Matches user\r\n    }\r\n\r\n    it('should REJECT booking a block in the past', async () => {\r\n        const pastDate = subDays(new Date(), 1)\r\n\r\n        // Mock findUniqueOrThrow to return a past block\r\n        mockTx.availabilityBlock.findUniqueOrThrow.mockResolvedValue({\r\n            ...validBlock,\r\n            id: PAST_BLOCK_ID,\r\n            startDatetime: pastDate,\r\n            endDatetime: addHours(pastDate, 2)\r\n        })\r\n\r\n        await createBookingHandler(mockReq({\r\n            blockId: PAST_BLOCK_ID,\r\n            vehiclePlate: 'PAST01',\r\n            visitorName: 'Marty',\r\n            visitorPhone: '123'\r\n        }) as any, mockRes as any)\r\n\r\n        // EXPECTATION: Should fail with specific error\r\n        // Current Code: Likely succeeds (201) or fails on unrelated logic\r\n        if (mockRes.status.mock.calls[0]?.[0] === 201) {\r\n            console.warn('⚠️ SECURITY FAIL: Allowed booking in the past')\r\n        }\r\n\r\n        // We assert what we WANT to happen after the fix\r\n        // If this test runs BEFORE valid fix, it might fail (which is good for TDD)\r\n        // Ideally we want to see it turn Green after fix.\r\n        // For \"Reproduce\" phase, we expect this check to NOT exist, so it should be called with 200/201.\r\n\r\n        // Wait, \"Reproduction\" means proving the bug exists. \r\n        // So I should assert that it DOES succeed (proving bug) OR assert it FAILS (and see the test fail).\r\n        // Standard practice: Write the test asserting the CORRECT behavior. It will fail. Then fix code. It passes.\r\n        expect(mockRes.status).toHaveBeenCalledWith(400)\r\n        expect(mockRes.json).toHaveBeenCalledWith(expect.objectContaining({ error: 'Cannot book past dates' }))\r\n    })\r\n\r\n    it('should REJECT overlapping booking if concurrently reserved', async () => {\r\n        // Mock findUniqueOrThrow (Returning the block we want to book)\r\n        mockTx.availabilityBlock.findUniqueOrThrow.mockResolvedValue({\r\n            ...validBlock,\r\n            spot: { buildingId: 'building-123' }\r\n        })\r\n\r\n        // Mock findFirst (The overlap check we will add)\r\n        // If we want to simulate an existing overlap, this returns a record.\r\n        mockTx.availabilityBlock.findFirst.mockResolvedValue({\r\n            id: 'other-block-id',\r\n            status: 'reserved'\r\n        })\r\n\r\n        await createBookingHandler(mockReq({\r\n            blockId: FUTURE_BLOCK_ID,\r\n            vehiclePlate: 'OVERLAP',\r\n            visitorName: 'Dupe',\r\n            visitorPhone: '123'\r\n        }) as any, mockRes as any)\r\n\r\n        // Tests that we actually CALL the overlap check\r\n        // expect(mockTx.availabilityBlock.findFirst).toHaveBeenCalled() // Can't assert this yet as code doesn't exist\r\n\r\n        // Assert correct failure\r\n        expect(mockRes.status).toHaveBeenCalledWith(409)\r\n        expect(mockRes.json).toHaveBeenCalledWith(expect.objectContaining({ error: 'Double Booking Detected' }))\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\bookings.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1199,1202],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1199,1202],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":39,"column":17,"nodeType":"MemberExpression","messageId":"limited","endLine":39,"endColumn":28,"suggestions":[{"fix":{"range":[1227,1276],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":69,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":69,"endColumn":24,"suggestions":[{"fix":{"range":[2257,2310],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":107,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3705,3708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3705,3708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":144,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5104,5107],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5104,5107],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":185,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":185,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6987,6990],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6987,6990],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":200,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":200,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7517,7520],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7517,7520],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":226,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":226,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8513,8516],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8513,8516],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":244,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9258,9261],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9258,9261],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":281,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":281,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10594,10597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10594,10597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":322,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":322,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12206,12209],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12206,12209],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":363,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":363,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13749,13752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13749,13752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeAll, afterAll, vi } from 'vitest';\r\nimport axios from 'axios';\r\nimport { PrismaClient, DurationType } from '@prisma/client';\r\nimport crypto from 'crypto';\r\nimport type { Server } from 'http';\r\n\r\n// Mock Redis to prevent connection errors during tests\r\nvi.mock('../lib/redis.js', () => ({\r\n    redis: {\r\n        status: 'ready',\r\n        incr: vi.fn().mockResolvedValue(1),\r\n        expire: vi.fn().mockResolvedValue(1),\r\n        on: vi.fn(),\r\n    }\r\n}));\r\n\r\nimport { app } from '../app.js';\r\n\r\n// Assumption: Backend is running at this URL (Integration Test)\r\nlet API_URL = 'http://127.0.0.1:3000';\r\nconst prisma = new PrismaClient();\r\nlet server: Server;\r\n\r\ndescribe('Booking Flow (Integration)', () => {\r\n    let buildingId: string;\r\n    let spotId: string;\r\n    let blockId: string;\r\n    let token: string;\r\n    let createdBookingId: string;\r\n    let userId: string;\r\n    let unitId: string;\r\n\r\n    beforeAll(async () => {\r\n        // Start Server\r\n        await new Promise<void>((resolve) => {\r\n            server = app.listen(0, '127.0.0.1', () => {\r\n                const addr = server.address();\r\n                API_URL = 'http://127.0.0.1:' + (addr as any).port;\r\n                console.log('Test Server running at ' + API_URL);\r\n                resolve();\r\n            });\r\n        });\r\n\r\n        try {\r\n            // 1. Setup Building & Resident\r\n            const building = await prisma.building.findFirst();\r\n            if (!building) {\r\n                // Seed if empty (basic fallback)\r\n                const newBuilding = await prisma.building.create({\r\n                    data: {\r\n                        name: 'Test Building',\r\n                        address: '123 Test St',\r\n                        contactEmail: 'test@building.com',\r\n                        totalUnits: 10,\r\n                        timezone: 'America/Santiago'\r\n                    }\r\n                });\r\n                buildingId = newBuilding.id;\r\n            } else {\r\n                buildingId = building.id;\r\n            }\r\n\r\n\r\n\r\n            // 2. Create User for Auth\r\n            const unique = crypto.randomUUID();\r\n            // Simplify email\r\n            const email = `vitest-${unique}@test.com`;\r\n            console.log('Attempting request with email:', email);\r\n            const rut = `${unique.substring(0, 8)}-K`;\r\n\r\n            const unit = await prisma.unit.create({\r\n                data: {\r\n                    buildingId: buildingId,\r\n                    unitNumber: `U-${unique.substring(0, 5)}`\r\n                }\r\n            });\r\n            unitId = unit.id;\r\n\r\n            // Hash password using service to ensure consistency\r\n            const { hashPassword } = await import('../services/auth.js');\r\n            const passwordHash = await hashPassword('password123');\r\n\r\n            await prisma.resident.create({\r\n                data: {\r\n                    email,\r\n                    passwordHash,\r\n                    rut,\r\n                    firstName: 'Test',\r\n                    lastName: 'User',\r\n                    unitId: unit.id,\r\n                    isVerified: true // Directly verified\r\n                }\r\n            }).then(r => userId = r.id);\r\n\r\n            const loginRes = await axios.post(`${API_URL}/api/auth/login`, {\r\n                email,\r\n                password: 'password123'\r\n            }); // Revert validateStatus\r\n\r\n            if (loginRes.status !== 200) {\r\n                console.error('LOGIN FAILED:', loginRes.status, loginRes.data);\r\n            }\r\n\r\n            const cookies = loginRes.headers['set-cookie'];\r\n            if (cookies) {\r\n                const tokenCookie = cookies.find((c: any) => c.startsWith('token='));\r\n                if (tokenCookie) {\r\n                    token = tokenCookie.split(';')[0].replace('token=', '');\r\n                }\r\n            }\r\n\r\n            if (!token) {\r\n                throw new Error(`DEBUG: Token missing. Login Status: ${loginRes.status}. Headers: ${JSON.stringify(loginRes.headers)}`);\r\n            }\r\n\r\n            // 3. Create Spot & Availability Block directly in DB\r\n            const spot = await prisma.visitorSpot.create({\r\n                data: {\r\n                    buildingId,\r\n                    spotNumber: `V-${unique.substring(0, 5)}`,\r\n                    isActive: true\r\n                }\r\n            });\r\n            spotId = spot.id;\r\n\r\n            const start = new Date();\r\n            start.setDate(start.getDate() + 1); // Tomorrow\r\n            start.setHours(10, 0, 0, 0);\r\n            const end = new Date(start);\r\n            end.setHours(21, 0, 0, 0); // 11h later\r\n\r\n            const block = await prisma.availabilityBlock.create({\r\n                data: {\r\n                    spotId,\r\n                    startDatetime: start,\r\n                    endDatetime: end,\r\n                    durationType: DurationType.ELEVEN_HOURS,\r\n                    basePriceClp: 5000,\r\n                    status: 'available'\r\n                }\r\n            });\r\n            blockId = block.id;\r\n        } catch (error: any) {\r\n            console.error('BEFORE ALL FAILED:', error.response?.data || error.message);\r\n            throw error;\r\n        }\r\n    });\r\n\r\n    afterAll(async () => {\r\n        // Cleanup\r\n        if (createdBookingId) {\r\n            await prisma.booking.deleteMany({ where: { id: createdBookingId } });\r\n        }\r\n        if (blockId) {\r\n            await prisma.availabilityBlock.deleteMany({ where: { id: blockId } });\r\n        }\r\n        if (spotId) {\r\n            await prisma.visitorSpot.deleteMany({ where: { id: spotId } });\r\n        }\r\n        if (userId) {\r\n            await prisma.resident.deleteMany({ where: { id: userId } });\r\n        }\r\n        if (unitId) {\r\n            await prisma.unit.deleteMany({ where: { id: unitId } });\r\n        }\r\n        // Only delete building if we created it (check if it matches our unique pattern or is the fallback)\r\n        // If we reused \"Test Building\", deleting it might affect other tests potentially?\r\n        // But for integration tests running sequentially it is safer to leave it if it was pre-existing?\r\n        // Actually, the setup code creates \"Test Building\" if NOT found.\r\n        // Let's strictly delete what we created if we track it.\r\n        // Since we didn't robustly track \"didCreatedBuilding\", let's skip deleting building to be safe against breaking other tests,\r\n        // OR we should have created a unique building.\r\n        // Ideally we should have created a unique building every time.\r\n        // For now, cleaning Resident/Unit/Spot is sufficient for repeating THIS test.\r\n\r\n        await prisma.$disconnect();\r\n        if (server) server.close();\r\n    });\r\n\r\n    it('should find the available spot via search', async () => {\r\n        const res = await axios.get(`${API_URL}/api/spots/search`, {\r\n            params: { buildingId }\r\n        });\r\n        const found = res.data.data.find((b: any) => b.id === blockId);\r\n        expect(found).toBeDefined();\r\n        expect(found.status).toBe('available');\r\n    });\r\n\r\n    it('should create a booking successfully', async () => {\r\n        let res;\r\n        try {\r\n            res = await axios.post(`${API_URL}/api/bookings/create`, {\r\n                blockId,\r\n                vehiclePlate: 'TEST-99',\r\n                visitorName: 'Vitest Visitor'\r\n            }, {\r\n                headers: { Authorization: `Bearer ${token}` }\r\n            });\r\n        } catch (error: any) {\r\n            console.error('CREATE BOOKING FAILED:', error.response?.status, error.response?.data);\r\n            throw error;\r\n        }\r\n\r\n        expect(res.status).toBe(201);\r\n        expect(res.data.booking.id).toBeDefined();\r\n        expect(res.data.booking.status).toBe('pending');\r\n        createdBookingId = res.data.booking.id;\r\n\r\n        // Verify DB status update\r\n        const block = await prisma.availabilityBlock.findUnique({ where: { id: blockId } });\r\n        expect(block?.status).toBe('reserved');\r\n    });\r\n\r\n    it('should prevent double booking (Optimistic Locking)', async () => {\r\n        try {\r\n            await axios.post(`${API_URL}/api/bookings/create`, {\r\n                blockId,\r\n                vehiclePlate: 'FAIL-00',\r\n                visitorName: 'Late Visitor'\r\n            }, {\r\n                headers: { Authorization: `Bearer ${token}` }\r\n            });\r\n            // Should fail\r\n            expect(true).toBe(false);\r\n        } catch (error: any) {\r\n            // Expect 409 Conflict\r\n            expect(error.response?.status).toBe(409);\r\n            // It could be BLOCK_UNAVAILABLE (Spot no longer available) because status is reserved\r\n            expect(error.response?.data?.error).toMatch(/no longer available|Double Booking/i);\r\n        }\r\n    });\r\n\r\n    it('should validate input types', async () => {\r\n        try {\r\n            await axios.post(`${API_URL}/api/bookings/create`, {\r\n                blockId,\r\n                vehiclePlate: 'AT', // Too short\r\n                visitorName: 'Vitest Visitor'\r\n            }, {\r\n                headers: { Authorization: `Bearer ${token}` }\r\n            });\r\n            expect(true).toBe(false); // Guard\r\n        } catch (error: any) {\r\n            expect(error.response?.status).toBe(400);\r\n        }\r\n    });\r\n\r\n    it('should prevent booking a different block that overlaps in time', async () => {\r\n        // 1. Create a second block that overlaps with the first one (which is already booked)\r\n        // Original block: Tomorrow 10am - 9pm\r\n        // New block: Tomorrow 12pm - 2pm (Inside the first one)\r\n\r\n        const start = new Date();\r\n        start.setDate(start.getDate() + 1);\r\n        start.setHours(12, 0, 0, 0);\r\n        const end = new Date(start);\r\n        end.setHours(14, 0, 0, 0);\r\n\r\n        const blockB = await prisma.availabilityBlock.create({\r\n            data: {\r\n                spotId,\r\n                startDatetime: start,\r\n                endDatetime: end,\r\n                durationType: DurationType.ELEVEN_HOURS, // Dummy Type\r\n                basePriceClp: 6000,\r\n                status: 'available'\r\n            }\r\n        });\r\n\r\n        try {\r\n            await axios.post(`${API_URL}/api/bookings/create`, {\r\n                blockId: blockB.id,\r\n                vehiclePlate: 'OVERLAP',\r\n                visitorName: 'Overlap Visitor'\r\n            }, {\r\n                headers: { Authorization: `Bearer ${token}` }\r\n            });\r\n            // Should fail\r\n            expect(true).toBe(false);\r\n        } catch (error: any) {\r\n            expect(error.response?.status).toBe(409);\r\n            expect(error.response?.data?.error).toMatch(/Double Booking/i);\r\n        } finally {\r\n            await prisma.availabilityBlock.delete({ where: { id: blockB.id } });\r\n        }\r\n    });\r\n\r\n    it('should prevent booking in a different building (IDOR protection)', async () => {\r\n        // Create Building B\r\n        const buildingB = await prisma.building.create({\r\n            data: {\r\n                name: 'Building B', address: '456 Other St',\r\n                totalUnits: 10, platformCommissionRate: 0.1, contactEmail: 'b@test.com'\r\n            }\r\n        });\r\n        const spotB = await prisma.visitorSpot.create({ data: { buildingId: buildingB.id, spotNumber: 'V-B' } });\r\n\r\n        const start = new Date();\r\n        start.setDate(start.getDate() + 2); // Day after tomorrow\r\n\r\n        const blockB = await prisma.availabilityBlock.create({\r\n            data: {\r\n                spotId: spotB.id,\r\n                startDatetime: start,\r\n                endDatetime: new Date(start.getTime() + 3600000),\r\n                durationType: DurationType.ELEVEN_HOURS,\r\n                basePriceClp: 5000,\r\n                status: 'available'\r\n            }\r\n        });\r\n\r\n        try {\r\n            await axios.post(`${API_URL}/api/bookings/create`, {\r\n                blockId: blockB.id,\r\n                vehiclePlate: 'IDOR-01',\r\n                visitorName: 'Hacker'\r\n            }, {\r\n                headers: { Authorization: `Bearer ${token}` }\r\n            });\r\n            expect(true).toBe(false);\r\n        } catch (error: any) {\r\n            expect(error.response?.status).toBe(403);\r\n            expect(error.response?.data?.error).toMatch(/own building/i);\r\n        } finally {\r\n            // Cleanup\r\n            await prisma.availabilityBlock.delete({ where: { id: blockB.id } });\r\n            await prisma.visitorSpot.delete({ where: { id: spotB.id } });\r\n            await prisma.building.delete({ where: { id: buildingB.id } });\r\n        }\r\n    });\r\n\r\n    it('should prevent non-residents from booking', async () => {\r\n        const adminToken = (await import('../services/auth.js')).signToken({\r\n            userId: '00000000-0000-0000-0000-000000000000',\r\n            role: 'admin',\r\n            buildingId: 'any'\r\n        });\r\n\r\n        const start = new Date();\r\n        start.setDate(start.getDate() + 3);\r\n\r\n        const blockC = await prisma.availabilityBlock.create({\r\n            data: {\r\n                spotId,\r\n                startDatetime: start,\r\n                endDatetime: new Date(start.getTime() + 3600000),\r\n                durationType: DurationType.ELEVEN_HOURS,\r\n                basePriceClp: 5000,\r\n                status: 'available'\r\n            }\r\n        });\r\n\r\n        try {\r\n            await axios.post(`${API_URL}/api/bookings/create`, {\r\n                blockId: blockC.id,\r\n                vehiclePlate: 'ADMIN-00',\r\n                visitorName: 'Admin'\r\n            }, {\r\n                headers: { Authorization: `Bearer ${adminToken}` }\r\n            });\r\n            expect(true).toBe(false);\r\n        } catch (error: any) {\r\n            expect([401, 403]).toContain(error.response?.status);\r\n        } finally {\r\n            await prisma.availabilityBlock.delete({ where: { id: blockC.id } });\r\n        }\r\n    });\r\n\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\check-conn.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":9,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":9,"endColumn":20,"suggestions":[{"fix":{"range":[323,360],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[378,381],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[378,381],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":12,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":12,"endColumn":24,"suggestions":[{"fix":{"range":[425,477],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":14,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":14,"endColumn":24,"suggestions":[{"fix":{"range":[539,584],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\r\n\r\nasync function test() {\r\n    try {\r\n        const res = await axios.post('http://localhost:3000/api/auth/login', {\r\n            email: 'admin@example.com', // doesn't matter if invalid credentials, as long as we get 401, not 404 or Refused\r\n            password: 'wrong'\r\n        });\r\n        console.log('Response:', res.status);\r\n    } catch (e: any) {\r\n        if (e.response) {\r\n            console.log('Server Responded:', e.response.status); // 401 is GOOD (Server is up)\r\n        } else {\r\n            console.log('Connection Failed:', e.message); // Bad\r\n        }\r\n    }\r\n}\r\ntest();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\coverage-gap.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\cron\\reconcile.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'endOfYesterday' is defined but never used.","line":4,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":42},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[330,333],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[330,333],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[462,465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[462,465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[620,623],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[620,623],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":45,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":45,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":165,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6223,6226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6223,6226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeEach } from 'vitest';\r\nimport { db } from '../../lib/db.js';\r\nimport { DurationType } from '@prisma/client';\r\nimport { startOfYesterday, endOfYesterday, subDays } from 'date-fns';\r\nimport handler from '../../api/cron/reconcile.js';\r\n\r\n// Mock Response\r\nconst mockRes = () => {\r\n    const res: any = {};\r\n    res.status = (code: number) => {\r\n        res.statusCode = code;\r\n        return res;\r\n    };\r\n    res.json = (data: any) => {\r\n        res.body = data;\r\n        return res;\r\n    };\r\n    return res;\r\n};\r\n\r\n// Mock Request\r\nconst mockReq = (method = 'POST') => ({ method } as any);\r\n\r\ndescribe('Reconciliation Cron', () => {\r\n    let buildingId: string;\r\n    let spotId: string;\r\n    let blockId: string;\r\n    let residentId: string;\r\n\r\n    beforeEach(async () => {\r\n        try {\r\n            // Use TRUNCATE CASCADE for clean slate (PostgreSQL specific)\r\n            // Order doesn't matter with CASCADE, but tablenames must match schema mappings\r\n            const tablenames = [\r\n                'payments', 'payouts', 'bookings',\r\n                'availability_blocks', 'visitor_spots',\r\n                'residents', 'units', 'users', 'buildings'\r\n            ];\r\n\r\n            for (const table of tablenames) {\r\n                try {\r\n                    // We use DELETE (less efficient but safer if TRUNCATE permissions issue) \r\n                    // OR we can try raw TRUNCATE. Let's try TRUNCATE first.\r\n                    await db.$executeRawUnsafe(`TRUNCATE TABLE \"${table}\" CASCADE;`);\r\n                } catch (err) {\r\n                    // Fallback to delete if TRUNCATE fails (e.g. FK issues in loop, but CASCADE should fix)\r\n                    // Actually, single TRUNCATE statement with all tables is best\r\n                }\r\n            }\r\n            await db.$executeRawUnsafe(`TRUNCATE TABLE \"payments\", \"payouts\", \"bookings\", \"availability_blocks\", \"visitor_spots\", \"residents\", \"units\", \"users\", \"buildings\" CASCADE;`);\r\n\r\n            // Setup Building & Unit\r\n            const building = await db.building.create({\r\n                data: {\r\n                    name: 'Reconcile Test Building',\r\n                    address: '123 Finance St',\r\n                    contactEmail: 'finance@test.com',\r\n                    totalUnits: 10,\r\n                    platformCommissionRate: 0.10\r\n                }\r\n            });\r\n            buildingId = building.id;\r\n\r\n            const unit = await db.unit.create({\r\n                data: { buildingId, unitNumber: '101' }\r\n            });\r\n\r\n            const resident = await db.resident.create({\r\n                data: {\r\n                    unitId: unit.id,\r\n                    email: `res-${Date.now()}@test.com`,\r\n                    rut: `999-${Date.now()}`,\r\n                    firstName: 'John',\r\n                    lastName: 'Doe'\r\n                }\r\n            });\r\n            residentId = resident.id;\r\n\r\n            // Spot & Cleanup\r\n            const spot = await db.visitorSpot.create({\r\n                data: { buildingId, spotNumber: 'S-Reconcile' }\r\n            });\r\n            spotId = spot.id;\r\n\r\n            // Block\r\n            const block = await db.availabilityBlock.create({\r\n                data: {\r\n                    spotId,\r\n                    startDatetime: subDays(new Date(), 2),\r\n                    endDatetime: subDays(new Date(), 1), // Yesterday\r\n                    durationType: DurationType.TWENTY_THREE_HOURS,\r\n                    basePriceClp: 10000\r\n                }\r\n            });\r\n            blockId = block.id;\r\n        } catch (e) {\r\n            console.error('Test Setup Failed:', e);\r\n            throw e;\r\n        }\r\n    });\r\n\r\n    it.skip('should calculate revenue and create payout for yesterday', async () => {\r\n        // Create a confirmed booking for \"Yesterday\"\r\n        const bookingDate = new Date(startOfYesterday().getTime() + 1000); // Yesterday start + 1s\r\n\r\n        await db.booking.create({\r\n            data: {\r\n                residentId,\r\n                availabilityBlockId: blockId,\r\n                visitorName: 'Visitor 1',\r\n                vehiclePlate: 'ABCD12',\r\n                amountClp: 10000,\r\n                commissionClp: 1000,\r\n                status: 'confirmed',\r\n                paymentStatus: 'paid',\r\n                confirmationCode: 'REC01',\r\n                createdAt: bookingDate\r\n                // Payment relation usually created separately or nested. \r\n                // For this test, we skip Payment creation as logic checks Booking amounts, \r\n                // but logs error if missing. We want to verify Payout creation logic.\r\n            }\r\n        });\r\n\r\n        const res = mockRes();\r\n        await handler(mockReq(), res);\r\n\r\n        expect(res.statusCode).toBe(200);\r\n        expect(res.body.success).toBe(true);\r\n        expect(res.body.results.length).toBeGreaterThan(0);\r\n\r\n        // Verify Payout\r\n        const payouts = await db.payout.findMany({ where: { buildingId } });\r\n        expect(payouts.length).toBe(1);\r\n        expect(payouts[0].totalRevenueClp).toBe(10000);\r\n        expect(payouts[0].platformCommissionClp).toBe(1000);\r\n        expect(payouts[0].buildingShareClp).toBe(9000);\r\n        expect(payouts[0].status).toBe('calculated');\r\n    });\r\n\r\n    it.skip('should be idempotent', async () => {\r\n        // Create a confirmed booking for \"Yesterday\"\r\n        const bookingDate = new Date(startOfYesterday().getTime() + 1000);\r\n\r\n        await db.booking.create({\r\n            data: {\r\n                residentId,\r\n                availabilityBlockId: blockId,\r\n                visitorName: 'Visitor 1',\r\n                vehiclePlate: 'ABCD12',\r\n                amountClp: 5000,\r\n                commissionClp: 500,\r\n                status: 'confirmed',\r\n                paymentStatus: 'paid',\r\n                confirmationCode: 'REC02',\r\n                createdAt: bookingDate\r\n            }\r\n        });\r\n\r\n        const res1 = mockRes();\r\n        await handler(mockReq(), res1);\r\n        expect(res1.body.results[0].status).toBe('created');\r\n\r\n        const res2 = mockRes();\r\n        await handler(mockReq(), res2);\r\n        expect(res2.body.results.find((r: any) => r.building === 'Reconcile Test Building').status).toBe('skipped_exists');\r\n\r\n        const payouts = await db.payout.findMany({ where: { buildingId } });\r\n        expect(payouts.length).toBe(1);\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\crypto.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\fix-s1-commission.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\fix-s3-race.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculateBookingPricing' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'unitId' is assigned a value but never used.","line":14,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":15},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":166,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":166,"endColumn":20,"suggestions":[{"fix":{"range":[7124,7200],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":170,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":170,"endColumn":20,"suggestions":[{"fix":{"range":[7318,7399],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeAll, afterAll } from 'vitest';\r\nimport { PrismaClient, DurationType } from '@prisma/client';\r\nimport { calculateBookingPricing } from '../lib/domain/pricing.js';\r\nimport crypto from 'crypto';\r\n\r\n// We need a real DB connection for concurrency testing\r\nconst prisma = new PrismaClient();\r\n\r\ndescribe('S3 Fix: Race Condition (Overlaps)', () => {\r\n    let buildingId: string;\r\n    let spotId: string;\r\n    let blockId: string;\r\n    let residentId: string;\r\n    let unitId: string;\r\n\r\n    beforeAll(async () => {\r\n        // Setup Logic: Create Building, Unit, Resident, Spot, Block\r\n        const unique = crypto.randomUUID();\r\n\r\n        const building = await prisma.building.create({\r\n            data: {\r\n                name: `Race Test Building ${unique.substring(0, 8)}`,\r\n                address: '123 Test St',\r\n                totalUnits: 10,\r\n                platformCommissionRate: 0.1,\r\n                contactEmail: `race-${unique.substring(0, 8)}@test.com`\r\n            }\r\n        });\r\n        buildingId = building.id;\r\n\r\n        const unit = await prisma.unit.create({\r\n            data: { buildingId, unitNumber: '101' }\r\n        });\r\n        unitId = unit.id;\r\n\r\n        const resident = await prisma.resident.create({\r\n            data: {\r\n                unitId: unit.id,\r\n                email: `racer-${unique}@test.com`,\r\n                firstName: 'Speedy',\r\n                lastName: 'Gonzales',\r\n                // RUT format: 12345678-K. Use random digits. \r\n                rut: `${Math.floor(Math.random() * 100000000)}-K`,\r\n                isVerified: true\r\n            }\r\n        });\r\n        residentId = resident.id;\r\n\r\n        const spot = await prisma.visitorSpot.create({\r\n            data: { buildingId, spotNumber: 'V-RACE' }\r\n        });\r\n        spotId = spot.id;\r\n\r\n        const start = new Date();\r\n        start.setDate(start.getDate() + 1);\r\n        start.setHours(12, 0, 0, 0);\r\n        const end = new Date(start);\r\n        end.setHours(23, 0, 0, 0);\r\n\r\n        const block = await prisma.availabilityBlock.create({\r\n            data: {\r\n                spotId,\r\n                startDatetime: start,\r\n                endDatetime: end,\r\n                durationType: DurationType.ELEVEN_HOURS,\r\n                basePriceClp: 10000,\r\n                status: 'available'\r\n            }\r\n        });\r\n        blockId = block.id;\r\n    });\r\n\r\n    // Cleanup: Delete Bookings first, then Residents, then Building (Cascade)\r\n    afterAll(async () => {\r\n        try {\r\n            if (blockId) await prisma.booking.deleteMany({ where: { availabilityBlockId: blockId } });\r\n            if (residentId) await prisma.resident.delete({ where: { id: residentId } });\r\n            if (buildingId) await prisma.building.delete({ where: { id: buildingId } }); // Cascades\r\n        } catch (e) {\r\n            console.error('Cleanup failed (likely partial setup):', e);\r\n        } finally {\r\n            await prisma.$disconnect();\r\n        }\r\n    });\r\n\r\n    it('should prevents double booking under high concurrency', async () => {\r\n        // Defines the \"booking action\" that we will spam\r\n        // We simulate the API logic here because calling the HTTP API might hit rate limits or network bottlenecks\r\n        // But optimally we should test the API handler logic.\r\n        // For this test to be robust, we need to invoke the *handler logic*.\r\n        // Since we can't easily invoke the handler function directly without mocking req/res, \r\n        // AND we want to test the DB locking, we will replicate the handler's CRITICAL SECTION here \r\n        // OR we can make a helper in the codebase.\r\n\r\n        // Actually, let's call the API endpoint via axios if possible, \r\n        // or just invoke the transaction logic if we extract it.\r\n        // Given the constraints, I will try to verify the locking by simulating the transaction logic \r\n        // exactly as it is in create.ts, but that duplicates code.\r\n\r\n        // BETTER APPROACH: Use the API endpoint if the server is running.\r\n        // But arguments says \"Run npm run dev\". I might not have a running server reliable for this test.\r\n        // Let's implement the \"FIX\" directly and assume standard Transaction properties hold.\r\n\r\n        // Wait, I can try to use the `createBooking` logic if I extract it?\r\n        // No, it's in a default export handler.\r\n\r\n        // Let's rely on checking that the DB constraints (if we added them) work.\r\n        // But we are adding *Application Level Locking* (Parent Update).\r\n        // So we need to test that.\r\n\r\n        // I will simulate the \"Parent Lock\" logic here to prove it works,\r\n        // effectively constructing the same transaction structure.\r\n\r\n        const concurrentAttempts = 10;\r\n        const results = await Promise.allSettled(Array.from({ length: concurrentAttempts }).map(async (_, i) => {\r\n            return await prisma.$transaction(async (tx) => {\r\n                // 1. LOCK PARENT (The Fix)\r\n                // If we comment this out, it should fail (allow doubles) typically, \r\n                // but Postgres Read Committed might strict it anyway? \r\n                // No, standard `findFirst` isn't locking.\r\n\r\n                // 1. LOCK PARENT (The Fix)\r\n                // We use raw SQL to lock the row because:\r\n                // a) Updating `updatedAt` manually is blocked by strict types\r\n                // b) Updating other fields to same values might be optimized away by Prisma (no query = no lock)\r\n                // c) FOR UPDATE is the standard way to lock without side-effects\r\n                await tx.$executeRaw`SELECT * FROM \"visitor_spots\" WHERE id = ${spotId} FOR UPDATE`;\r\n\r\n                // 2. READ Availability\r\n                const block = await tx.availabilityBlock.findUniqueOrThrow({\r\n                    where: { id: blockId },\r\n                    include: { bookings: true } // Naive overlap check\r\n                });\r\n\r\n                if (block.status !== 'available') {\r\n                    throw new Error('Block not available');\r\n                }\r\n\r\n                // 3. WRITE Booking\r\n                const booking = await tx.booking.create({\r\n                    data: {\r\n                        residentId,\r\n                        availabilityBlockId: blockId,\r\n                        visitorName: `Racer ${i}`,\r\n                        vehiclePlate: `ABC-${i}`,\r\n                        amountClp: 10000,\r\n                        commissionClp: 1000,\r\n                        confirmationCode: `CODE-${i}-${Date.now()}`.substring(0, 10),\r\n                        status: 'pending'\r\n                    }\r\n                });\r\n\r\n                // 4. UPDATE Block\r\n                await tx.availabilityBlock.update({\r\n                    where: { id: blockId },\r\n                    data: { status: 'reserved' }\r\n                });\r\n\r\n                return booking;\r\n            });\r\n        }));\r\n\r\n        const successes = results.filter(r => r.status === 'fulfilled');\r\n        const failures = results.filter(r => r.status === 'rejected');\r\n\r\n        console.log(`Successes: ${successes.length}, Failures: ${failures.length}`);\r\n\r\n        // WITHOUT LOCK: We might get > 1 success.\r\n        // WITH LOCK: We MUST get Exactly 1 success.\r\n        console.log(`Debug: Successes=${successes.length}, Failures=${failures.length}`);\r\n        if (successes.length !== 1) {\r\n            console.error('FAIL: Race condition not prevented! Successes:', successes.length);\r\n        }\r\n        expect(successes.length).toBe(1);\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\login-integration.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[869,872],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[869,872],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1115,1118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1115,1118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1472,1475],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1472,1475],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1484,1487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1484,1487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1710,1713],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1710,1713],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1921,1924],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1921,1924],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2150,2153],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2150,2153],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2162,2165],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2162,2165],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { vi, describe, it, expect } from 'vitest';\r\nimport loginHandler from '../api/auth/login.js';\r\n\r\n// Mock the cors helper to avoid dealing with network/middleware internals\r\nvi.mock('../lib/cors.js', () => ({\r\n    default: vi.fn().mockResolvedValue(true)\r\n}));\r\n\r\n// Mock DB to avoid needing a running database for this smoke test\r\n// We just want to verify the handler logic flow and lack of crashes\r\nvi.mock('../lib/db.js', () => ({\r\n    db: {\r\n        resident: {\r\n            findUnique: vi.fn().mockResolvedValue(null) // Simulate user not found\r\n        },\r\n        user: {\r\n            findUnique: vi.fn().mockResolvedValue(null) // Simulate user not found\r\n        }\r\n    }\r\n}));\r\n\r\ndescribe('Login Logic Smoke Test', () => {\r\n    it('should return 401 for user not found (Invalid credentials)', async () => {\r\n        // Mock Request\r\n        const req: any = {\r\n            method: 'POST',\r\n            body: {\r\n                email: 'test@example.com',\r\n                password: 'wrongpassword'\r\n            },\r\n            headers: {}\r\n        };\r\n\r\n        // Mock Response\r\n        const res: any = {\r\n            status: vi.fn().mockReturnThis(),\r\n            json: vi.fn().mockReturnThis(),\r\n            setHeader: vi.fn()\r\n        };\r\n\r\n\r\n\r\n        // Since handler now THROWS AppError, we expect a rejection with the error object properties\r\n        // Testing handler directly means we catch the throw.\r\n        await expect(loginHandler(req as any, res as any)).rejects.toMatchObject({\r\n            code: 'AUTH-LOGIN-1001',\r\n            statusCode: 401\r\n        });\r\n    });\r\n\r\n    it('should return 400 for invalid email format (Zod Validation)', async () => {\r\n        const req: any = {\r\n            method: 'POST',\r\n            body: {\r\n                email: 'not-an-email',\r\n                password: 'password'\r\n            },\r\n            headers: {}\r\n        };\r\n\r\n        const res: any = {\r\n            status: vi.fn().mockReturnThis(),\r\n            json: vi.fn().mockReturnThis(),\r\n            setHeader: vi.fn()\r\n        };\r\n\r\n        // Zod Error is thrown directly\r\n        await expect(loginHandler(req as any, res as any)).rejects.toThrow();\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\payments.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'unique2' is assigned a value but never used.","line":161,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":161,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeAll, afterAll } from 'vitest';\r\nimport request from 'supertest';\r\nimport { app } from '../app.js';\r\nimport { PrismaClient, DurationType } from '@prisma/client';\r\nimport crypto from 'crypto';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ndescribe('Payments API Integration Tests', () => {\r\n    let buildingId: string;\r\n    let spotId: string;\r\n    let blockId: string;\r\n    let residentId: string;\r\n    let bookingId: string;\r\n    let unique: string;\r\n\r\n    beforeAll(async () => {\r\n        try {\r\n            unique = crypto.randomUUID();\r\n            const building = await prisma.building.create({\r\n                data: {\r\n                    name: `Payment Building ${unique}`,\r\n                    address: 'Pay St',\r\n                    totalUnits: 5,\r\n                    platformCommissionRate: 0.1,\r\n                    contactEmail: `pay-${unique}@test.com`\r\n                }\r\n            });\r\n            buildingId = building.id;\r\n\r\n            const spot = await prisma.visitorSpot.create({ data: { buildingId, spotNumber: 'V-PAY' } });\r\n            spotId = spot.id;\r\n\r\n            const unit = await prisma.unit.create({ data: { buildingId, unitNumber: '101' } });\r\n            const resident = await prisma.resident.create({\r\n                data: {\r\n                    unitId: unit.id,\r\n                    email: `pay-res-${unique}@test.com`,\r\n                    firstName: 'P',\r\n                    lastName: 'M',\r\n                    rut: `${unique.substring(0, 8)}-P`,\r\n                    isVerified: true,\r\n                    passwordHash: 'hash'\r\n                }\r\n            });\r\n            residentId = resident.id;\r\n\r\n            // Create a Block\r\n            const start = new Date();\r\n            start.setHours(start.getHours() + 24); // Future\r\n            const end = new Date(start);\r\n            end.setHours(end.getHours() + 4);\r\n\r\n            const block = await prisma.availabilityBlock.create({\r\n                data: {\r\n                    spotId,\r\n                    startDatetime: start,\r\n                    endDatetime: end,\r\n                    durationType: DurationType.ELEVEN_HOURS,\r\n                    basePriceClp: 10000,\r\n                    status: 'available'\r\n                }\r\n            });\r\n            blockId = block.id;\r\n\r\n            // Create a Pending Booking\r\n            const booking = await prisma.booking.create({\r\n                data: {\r\n                    availabilityBlockId: blockId,\r\n                    residentId: residentId,\r\n                    vehiclePlate: 'PAY-123',\r\n                    visitorName: 'Payer One',\r\n                    commissionClp: 1000,\r\n                    amountClp: 11000,\r\n                    status: 'pending',\r\n                    paymentStatus: 'pending',\r\n                    confirmationCode: 'PAY-CODE-1'\r\n                }\r\n            });\r\n            bookingId = booking.id;\r\n\r\n        } catch (e) {\r\n            console.error('SETUP FAILED:', e);\r\n            throw e;\r\n        }\r\n    });\r\n\r\n    afterAll(async () => {\r\n        try {\r\n            // Delete payments logic if cascading doesn't handle it\r\n            await prisma.payment.deleteMany({ where: { bookingId } });\r\n            if (bookingId) await prisma.booking.delete({ where: { id: bookingId } });\r\n            if (blockId) await prisma.availabilityBlock.delete({ where: { id: blockId } });\r\n            if (residentId) await prisma.resident.deleteMany({ where: { email: { contains: `pay-res-${unique}` } } });\r\n            if (spotId) await prisma.visitorSpot.delete({ where: { id: spotId } });\r\n            if (buildingId) await prisma.building.deleteMany({ where: { name: `Payment Building ${unique}` } }); // Cascade delete units? No, need to be careful.\r\n            // Simplified cleanup for typical cascade:\r\n            // Building -> Units -> Residents \r\n            // Building -> Spots -> Blocks -> Bookings\r\n            // But Prisma setup might restrict cascade.\r\n            // Explicit delete above is safer.\r\n        } catch (e) {\r\n            console.error('cleanup failed', e);\r\n        } finally {\r\n            await prisma.$disconnect();\r\n        }\r\n    });\r\n\r\n    it('should initiate checkout and return simulator URL (Mock Mode)', async () => {\r\n        const res = await request(app)\r\n            .post('/api/payments/checkout')\r\n            .send({ bookingId });\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.init_point).toMatch(/localhost:5173\\/payment-simulator/);\r\n\r\n        // Verify Payment record created as 'pending'\r\n        const payment = await prisma.payment.findUnique({ where: { bookingId } });\r\n        expect(payment).toBeDefined();\r\n        expect(payment?.status).toBe('pending');\r\n        expect(payment?.amountClp).toBe(11000);\r\n    });\r\n\r\n    it('should fail checkout if booking not found', async () => {\r\n        const res = await request(app)\r\n            .post('/api/payments/checkout')\r\n            .send({ bookingId: crypto.randomUUID() });\r\n\r\n        expect(res.status).toBe(404);\r\n    });\r\n\r\n    it('should process Simulator Webhook (Approved)', async () => {\r\n        const webhookPayload = {\r\n            type: 'simulator',\r\n            data: {\r\n                bookingId: bookingId,\r\n                status: 'approved'\r\n            }\r\n        };\r\n\r\n        const res = await request(app)\r\n            .post('/api/payments/webhook')\r\n            .send(webhookPayload);\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.success).toBe(true);\r\n\r\n        // Verify Booking is confirmed\r\n        const updatedBooking = await prisma.booking.findUnique({ where: { id: bookingId } });\r\n        expect(updatedBooking?.status).toBe('confirmed');\r\n        expect(updatedBooking?.paymentStatus).toBe('paid');\r\n\r\n        // Verify Payment record updated\r\n        const payment = await prisma.payment.findUnique({ where: { bookingId } });\r\n        expect(payment?.status).toBe('approved');\r\n        expect(payment?.gatewayResponse).toMatchObject({ simulator: true });\r\n    });\r\n\r\n    it('should process Simulator Webhook (Rejected)', async () => {\r\n        // Create another booking for rejection test\r\n        const unique2 = crypto.randomUUID();\r\n        const booking2 = await prisma.booking.create({\r\n            data: {\r\n                availabilityBlockId: blockId, // Reusing block (technically overlap if confirmed, but we keep pending/rejected)\r\n                residentId: residentId,\r\n                vehiclePlate: 'REJECT-1',\r\n                visitorName: 'Reject Me',\r\n                commissionClp: 500,\r\n                amountClp: 5500,\r\n                status: 'pending',\r\n                paymentStatus: 'pending',\r\n                confirmationCode: 'REJ-CODE-1'\r\n            }\r\n        });\r\n\r\n        const webhookPayload = {\r\n            type: 'simulator',\r\n            data: {\r\n                bookingId: booking2.id,\r\n                status: 'rejected'\r\n            }\r\n        };\r\n\r\n        const res = await request(app)\r\n            .post('/api/payments/webhook')\r\n            .send(webhookPayload);\r\n\r\n        expect(res.status).toBe(200);\r\n\r\n        // Verify Booking remains pending (or whatever logic defined)\r\n        const updatedBooking2 = await prisma.booking.findUnique({ where: { id: booking2.id } });\r\n        expect(updatedBooking2?.status).toBe('pending');\r\n\r\n        // Verify Payment record\r\n        const payment = await prisma.payment.findUnique({ where: { bookingId: booking2.id } });\r\n        expect(payment?.status).toBe('rejected');\r\n\r\n        // Cleanup\r\n        await prisma.payment.deleteMany({ where: { bookingId: booking2.id } });\r\n        await prisma.booking.delete({ where: { id: booking2.id } });\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\sales.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2661,2664],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2661,2664],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { describe, it, expect, beforeAll, afterAll } from 'vitest';\r\nimport request from 'supertest';\r\nimport { app } from '../app.js';\r\nimport { db } from '../lib/db.js';\r\nimport { signToken } from '../services/auth.js';\r\nimport { SalesService } from '../services/SalesService.js';\r\n\r\n\r\ndescribe('Sales System & Admin User Management', () => {\r\n    let adminToken: string;\r\n    let salesRepId: string;\r\n    let salesRepEmail: string;\r\n    let buildingId: string;\r\n\r\n    beforeAll(async () => {\r\n        // Create Admin for API tests\r\n        const adminEmail = `admin_sales_test_${Date.now()}@test.com`;\r\n        const admin = await db.user.create({\r\n            data: {\r\n                email: adminEmail,\r\n                passwordHash: 'hash',\r\n                role: 'admin',\r\n                isActive: true\r\n            }\r\n        });\r\n        adminToken = signToken({ userId: admin.id, role: 'admin' });\r\n    });\r\n\r\n    afterAll(async () => {\r\n        // Cleanup\r\n        await db.salesRepCommission.deleteMany({ where: { salesRep: { email: salesRepEmail } } });\r\n        await db.payout.deleteMany({ where: { buildingId } });\r\n        if (buildingId) await db.building.delete({ where: { id: buildingId } });\r\n        if (salesRepId) await db.user.delete({ where: { id: salesRepId } });\r\n        // Admin cleanup omitted to avoid cascading delete issues if reused, but here it's unique\r\n    });\r\n\r\n    describe('Admin User Management (api/admin/users)', () => {\r\n        it('should create a new Sales Rep via POST /api/admin/users', async () => {\r\n            salesRepEmail = `rep_${Date.now()}@test.com`;\r\n            const res = await request(app)\r\n                .post('/api/admin/users')\r\n                .set('Cookie', `token=${adminToken}`)\r\n                .send({\r\n                    email: salesRepEmail,\r\n                    password: 'password123',\r\n                    role: 'sales_rep',\r\n                    firstName: 'John',\r\n                    lastName: 'Doe'\r\n                });\r\n\r\n            expect(res.status).toBe(201);\r\n            expect(res.body.success).toBe(true);\r\n            expect(res.body.data.email).toBe(salesRepEmail);\r\n            expect(res.body.data.role).toBe('sales_rep');\r\n            salesRepId = res.body.data.id;\r\n        });\r\n\r\n        it('should list users filtering by role', async () => {\r\n            const res = await request(app)\r\n                .get('/api/admin/users?role=sales_rep')\r\n                .set('Cookie', `token=${adminToken}`);\r\n\r\n            expect(res.status).toBe(200);\r\n            expect(Array.isArray(res.body.data)).toBe(true);\r\n            const found = res.body.data.find((u: any) => u.email === salesRepEmail);\r\n            expect(found).toBeTruthy();\r\n        });\r\n\r\n        it('should ban a user via PATCH /api/admin/users', async () => {\r\n            const res = await request(app)\r\n                .patch('/api/admin/users')\r\n                .set('Cookie', `token=${adminToken}`)\r\n                .send({\r\n                    userId: salesRepId,\r\n                    action: 'ban'\r\n                });\r\n\r\n            expect(res.status).toBe(200);\r\n            expect(res.body.user.isActive).toBe(false);\r\n        });\r\n\r\n        it('should unban a user', async () => {\r\n            const res = await request(app)\r\n                .patch('/api/admin/users')\r\n                .set('Cookie', `token=${adminToken}`)\r\n                .send({\r\n                    userId: salesRepId,\r\n                    action: 'unban'\r\n                });\r\n\r\n            expect(res.status).toBe(200);\r\n            expect(res.body.user.isActive).toBe(true);\r\n        });\r\n    });\r\n\r\n    describe('SalesService Logic', () => {\r\n        it('should set up a building for the sales rep', async () => {\r\n            // Create a building\r\n            const building = await db.building.create({\r\n                data: {\r\n                    name: `Sales Test Building ${Date.now()}`,\r\n                    address: '123 Sales St',\r\n                    totalUnits: 10,\r\n                    contactEmail: 'contact@sales.com',\r\n                    salesRepId: salesRepId,\r\n                    salesRepCommissionRate: 0.10 // 10%\r\n                }\r\n            });\r\n            buildingId = building.id;\r\n            expect(building).toBeDefined();\r\n        });\r\n\r\n        it('should calculate commission correctly when a Payout is processed', async () => {\r\n            // Mock a Payout\r\n            const payout = await db.payout.create({\r\n                data: {\r\n                    buildingId: buildingId,\r\n                    periodStart: new Date(),\r\n                    periodEnd: new Date(),\r\n                    totalRevenueClp: 100000,\r\n                    platformCommissionClp: 10000, // 10k net revenue\r\n                    buildingShareClp: 90000,\r\n                    status: 'calculated'\r\n                }\r\n            });\r\n\r\n            const commission = await SalesService.calculateCommission(payout);\r\n\r\n            expect(commission).toBeDefined();\r\n            expect(commission?.amountClp).toBe(1000); // 10% of 10,000\r\n            expect(commission?.salesRepId).toBe(salesRepId);\r\n            expect(commission?.status).toBe('pending');\r\n        });\r\n\r\n        it('should not calculate commission if building has no sales rep', async () => {\r\n            // Remove rep\r\n            await db.building.update({ where: { id: buildingId }, data: { salesRepId: null } });\r\n\r\n            const payout2 = await db.payout.create({\r\n                data: {\r\n                    buildingId: buildingId,\r\n                    periodStart: new Date(),\r\n                    periodEnd: new Date(),\r\n                    totalRevenueClp: 50000,\r\n                    platformCommissionClp: 5000,\r\n                    buildingShareClp: 45000,\r\n                    status: 'calculated'\r\n                }\r\n            });\r\n\r\n            const commission = await SalesService.calculateCommission(payout2);\r\n            expect(commission).toBeUndefined();\r\n\r\n            // Restore rep for next tests\r\n            await db.building.update({ where: { id: buildingId }, data: { salesRepId: salesRepId } });\r\n        });\r\n\r\n        it('should return correct Dashboard Stats', async () => {\r\n            const stats = await SalesService.getDashboardStats(salesRepId);\r\n            expect(stats).toBeDefined();\r\n            expect(stats.totalEarnings).toBe(1000); // The one commission we created\r\n            expect(stats.activeBuildingsCount).toBe(1);\r\n            expect(stats.recentCommissions.length).toBeGreaterThan(0);\r\n        });\r\n\r\n        it('should return Managed Buildings', async () => {\r\n            const buildings = await SalesService.getManagedBuildings(salesRepId);\r\n            expect(buildings.length).toBe(1);\r\n            expect(buildings[0].id).toBe(buildingId);\r\n        });\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\search.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4398,4401],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4398,4401],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeAll, afterAll } from 'vitest';\r\nimport request from 'supertest';\r\nimport { app } from '../app.js';\r\nimport { PrismaClient, DurationType } from '@prisma/client';\r\nimport crypto from 'crypto';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ndescribe('Spot Search API Integration Tests', () => {\r\n    let buildingId: string;\r\n    let otherBuildingId: string;\r\n    let spotId: string;\r\n    let unique: string;\r\n\r\n    beforeAll(async () => {\r\n        try {\r\n            unique = crypto.randomUUID();\r\n\r\n            // 1. Create Main Building\r\n            const building = await prisma.building.create({\r\n                data: {\r\n                    name: `Search Building ${unique}`,\r\n                    address: 'Search St',\r\n                    totalUnits: 10,\r\n                    contactEmail: `search-${unique}@test.com`\r\n                }\r\n            });\r\n            buildingId = building.id;\r\n\r\n            // 2. Create Other Building (for isolation test)\r\n            const otherBuilding = await prisma.building.create({\r\n                data: {\r\n                    name: `Other Building ${unique}`,\r\n                    address: 'Other St',\r\n                    totalUnits: 5,\r\n                    contactEmail: `other-${unique}@test.com`\r\n                }\r\n            });\r\n            otherBuildingId = otherBuilding.id;\r\n\r\n            // 3. Create Spot in Main Building\r\n            const spot = await prisma.visitorSpot.create({\r\n                data: { buildingId, spotNumber: 'V-SEARCH' }\r\n            });\r\n            spotId = spot.id;\r\n\r\n            // 4. Create Availability Blocks\r\n            const today = new Date();\r\n            const tomorrow = new Date(today);\r\n            tomorrow.setDate(tomorrow.getDate() + 1);\r\n\r\n            // Block 1: Today, 11h\r\n            await prisma.availabilityBlock.create({\r\n                data: {\r\n                    spotId,\r\n                    startDatetime: today,\r\n                    endDatetime: new Date(today.getTime() + 11 * 3600 * 1000),\r\n                    durationType: DurationType.ELEVEN_HOURS,\r\n                    basePriceClp: 5000,\r\n                    status: 'available'\r\n                }\r\n            });\r\n\r\n            // Block 2: Tomorrow, 23h\r\n            await prisma.availabilityBlock.create({\r\n                data: {\r\n                    spotId,\r\n                    startDatetime: tomorrow,\r\n                    endDatetime: new Date(tomorrow.getTime() + 23 * 3600 * 1000),\r\n                    durationType: DurationType.TWENTY_THREE_HOURS,\r\n                    basePriceClp: 10000,\r\n                    status: 'available'\r\n                }\r\n            });\r\n\r\n        } catch (e) {\r\n            console.error('SETUP FAILED:', e);\r\n            throw e;\r\n        }\r\n    });\r\n\r\n    afterAll(async () => {\r\n        try {\r\n            await prisma.availabilityBlock.deleteMany({ where: { spot: { buildingId: { in: [buildingId, otherBuildingId] } } } });\r\n            await prisma.visitorSpot.deleteMany({ where: { buildingId: { in: [buildingId, otherBuildingId] } } });\r\n            await prisma.building.deleteMany({ where: { id: { in: [buildingId, otherBuildingId] } } });\r\n        } catch (e) {\r\n            console.error('cleanup failed', e);\r\n        } finally {\r\n            await prisma.$disconnect();\r\n        }\r\n    });\r\n\r\n    it('should return blocks for a valid building', async () => {\r\n        const res = await request(app)\r\n            .get('/api/spots/search')\r\n            .query({ buildingId });\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.success).toBe(true);\r\n        expect(Array.isArray(res.body.data)).toBe(true);\r\n        expect(res.body.data.length).toBeGreaterThanOrEqual(2);\r\n    });\r\n\r\n    it('should return empty list for building with no spots', async () => {\r\n        const res = await request(app)\r\n            .get('/api/spots/search')\r\n            .query({ buildingId: otherBuildingId });\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.data).toHaveLength(0);\r\n    });\r\n\r\n    it('should filter by duration (11h)', async () => {\r\n        const res = await request(app)\r\n            .get('/api/spots/search')\r\n            .query({ buildingId, durationType: '11h' });\r\n\r\n        expect(res.status).toBe(200);\r\n        expect(res.body.data.length).toBeGreaterThan(0);\r\n        res.body.data.forEach((block: any) => {\r\n            expect(block.durationType).toBe('ELEVEN_HOURS'); // Prisma returns enum key\r\n        });\r\n    });\r\n\r\n    it('should filter by specific date (Today)', async () => {\r\n        // Need to format date as YYYY-MM-DD\r\n        const todayStr = new Date().toISOString().split('T')[0];\r\n\r\n        const res = await request(app)\r\n            .get('/api/spots/search')\r\n            .query({ buildingId, date: todayStr });\r\n\r\n        expect(res.status).toBe(200);\r\n        // Should find at least the \"Today\" block\r\n        // Might fail if run near midnight? Logic uses TZ America/Santiago.\r\n        // Assuming test env matches or logic handles it.\r\n        expect(res.body.data.length).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('should fail with 400 if buildingId is missing', async () => {\r\n        const res = await request(app)\r\n            .get('/api/spots/search'); // No query\r\n\r\n        expect(res.status).toBe(400); // Zod error\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\security-headers.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\server-startup.test.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":22,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":22,"endColumn":20,"suggestions":[{"fix":{"range":[642,686],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1476,1479],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1476,1479],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2380,2383],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2380,2383],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { describe, it, expect, afterAll } from 'vitest';\r\nimport { spawn, ChildProcess } from 'child_process';\r\nimport axios from 'axios';\r\nimport path from 'path';\r\n\r\nconst API_URL = 'http://127.0.0.1:3000';\r\n\r\ndescribe('Server Startup & Connectivity', () => {\r\n    let serverProcess: ChildProcess;\r\n    let serverStarted = false;\r\n\r\n    afterAll(() => {\r\n        if (serverProcess) {\r\n            serverProcess.kill();\r\n        }\r\n    });\r\n\r\n    it('should start the server and accept connections within timeout', async () => {\r\n        // 1. Start Server\r\n        const serverPath = path.resolve(__dirname, '../dev-server.ts');\r\n        console.log('Spawning server:', serverPath);\r\n\r\n        serverProcess = spawn('npx', ['tsx', serverPath], {\r\n            cwd: path.resolve(__dirname, '../'),\r\n            env: { ...process.env, PORT: '3000', NODE_ENV: 'test' },\r\n            shell: true\r\n        });\r\n\r\n        // 2. Poll for Health\r\n        const startTime = Date.now();\r\n        const timeout = 15000; // 15 seconds max (Generous for CI/Dev)\r\n\r\n        while (Date.now() - startTime < timeout) {\r\n            try {\r\n                const res = await axios.get(`${API_URL}/api/health`, { timeout: 1000 });\r\n                if (res.status === 200 || res.status === 503) {\r\n                    // 503 is acceptable if Redis is down, but server is UP\r\n                    serverStarted = true;\r\n                    break;\r\n                }\r\n            } catch (error: any) {\r\n                // Ignore connection refused, wait\r\n                if (error.code !== 'ECONNREFUSED') {\r\n                    // Maybe 503 from our health check?\r\n                    if (error.response && error.response.status === 503) {\r\n                        serverStarted = true;\r\n                        break;\r\n                    }\r\n                }\r\n                await new Promise(r => setTimeout(r, 500));\r\n            }\r\n        }\r\n\r\n        expect(serverStarted).toBe(true);\r\n    }, 20000);\r\n\r\n    it('should have working login endpoint', async () => {\r\n        if (!serverStarted) return; // Skip if previous failed\r\n\r\n        try {\r\n            // Attempt login with garbage to check connectivity\r\n            await axios.post(`${API_URL}/api/auth/login`, {\r\n                email: 'test@conn.check',\r\n                password: 'wrong'\r\n            });\r\n        } catch (error: any) {\r\n            // We expect 401/403 (Invalid credentials)\r\n            // We DO NOT expect ECONNREFUSED\r\n            expect(error.response).toBeDefined();\r\n            expect(error.response.status).not.toBe(0); // 0 usually means network error\r\n            expect([401, 403, 400]).toContain(error.response.status);\r\n        }\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\services\\payments.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\signup.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'uniqueRut' is assigned a value but never used.","line":20,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'payload' is assigned a value but never used.","line":125,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":125,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeAll, afterAll } from 'vitest';\r\nimport request from 'supertest';\r\nimport { app } from '../app.js';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport crypto from 'crypto';\r\nimport { hashPII } from '../lib/crypto.js';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ndescribe('Sign Up Integration Tests (api/auth/signup)', () => {\r\n    let buildingId: string;\r\n    let unitId: string;\r\n    let unique: string;\r\n\r\n    beforeAll(async () => {\r\n        try {\r\n            unique = crypto.randomUUID();\r\n\r\n            // Fix: Use unique RUT.\r\n            const uniqueRut = unique.substring(0, 8) + '-9';\r\n\r\n            const building = await prisma.building.create({\r\n                data: {\r\n                    name: `Signup Building ${unique}`,\r\n                    address: 'Signup St',\r\n                    totalUnits: 10,\r\n                    platformCommissionRate: 0.1,\r\n                    contactEmail: `signup-${unique}@test.com`\r\n                }\r\n            });\r\n            buildingId = building.id;\r\n\r\n            const unit = await prisma.unit.create({\r\n                data: { buildingId, unitNumber: '101' }\r\n            });\r\n            unitId = unit.id;\r\n        } catch (e) {\r\n            console.error('SETUP FAILED:', e);\r\n            throw e;\r\n        }\r\n    });\r\n\r\n    afterAll(async () => {\r\n        try {\r\n            if (unitId) {\r\n                // Delete residents first to satisfy FK constraint\r\n                await prisma.resident.deleteMany({ where: { unitId } });\r\n                await prisma.unit.delete({ where: { id: unitId } });\r\n            }\r\n            if (buildingId) await prisma.building.delete({ where: { id: buildingId } });\r\n        } catch (e) {\r\n            console.error('cleanup failed', e);\r\n        } finally {\r\n            await prisma.$disconnect();\r\n        }\r\n    });\r\n\r\n    it('should register a new resident successfully', async () => {\r\n        const uniqueRut = `${unique.substring(0, 8)}-9`;\r\n        const payload = {\r\n            email: `new-res-${unique}@test.com`,\r\n            password: 'password123',\r\n            rut: uniqueRut,\r\n            firstName: 'John',\r\n            lastName: 'Doe',\r\n            buildingId: buildingId,\r\n            unitNumber: '101',\r\n            phone: '+56912345678'\r\n        };\r\n\r\n        const res = await request(app)\r\n            .post('/api/auth/signup')\r\n            .send(payload);\r\n\r\n        expect(res.status).toBe(201);\r\n        expect(res.body.success).toBe(true);\r\n        expect(res.body.residentId).toBeDefined();\r\n\r\n        // Verify in DB\r\n        const resident = await prisma.resident.findUnique({ where: { id: res.body.residentId } });\r\n        expect(resident).toBeDefined();\r\n        expect(resident?.email).toBe(payload.email);\r\n        expect(resident?.isVerified).toBe(false); // Should default to false\r\n    });\r\n\r\n    it('should fail if unit does not exist in building', async () => {\r\n        const payload = {\r\n            email: `bad-unit-${unique}@test.com`,\r\n            password: 'password123',\r\n            rut: `98765432-1`,\r\n            firstName: 'Jane',\r\n            lastName: 'Doe',\r\n            buildingId: buildingId,\r\n            unitNumber: '999' // Non-existent\r\n        };\r\n\r\n        const res = await request(app)\r\n            .post('/api/auth/signup')\r\n            .send(payload);\r\n\r\n        expect(res.status).toBe(400);\r\n        expect(res.body.error).toMatch(/Unit not found/i);\r\n    });\r\n\r\n    it('should fail if email is already registered', async () => {\r\n        // Create a resident first\r\n        const email = `dup-email-${unique}@test.com`;\r\n        const rut = `11111111-1`;\r\n        const rutHash = await hashPII(rut);\r\n\r\n        await prisma.resident.create({\r\n            data: {\r\n                unitId,\r\n                email,\r\n                firstName: 'X',\r\n                lastName: 'Y',\r\n                rut: rut, // Should be encrypted technically but MVP test might skip encryption for direct DB unless strict\r\n                // Actually signup.ts encrypts it. But uniqueness check relies on rutHash.\r\n                rutHash: rutHash,\r\n                passwordHash: 'hash',\r\n                isVerified: true\r\n            }\r\n        });\r\n\r\n        const payload = {\r\n            email: email,\r\n            password: 'password123',\r\n            rut: `22222222-2`, // Different RUT\r\n            firstName: 'Copy',\r\n            lastName: 'Cat',\r\n            buildingId: buildingId,\r\n            unitNumber: '101'\r\n        };\r\n        // ...\r\n    });\r\n\r\n    it('should fail if RUT is already registered', async () => {\r\n        const rut = `33333333-3`;\r\n        const rutHash = await hashPII(rut);\r\n\r\n        await prisma.resident.create({\r\n            data: {\r\n                unitId,\r\n                email: `unique-${unique}@test.com`,\r\n                firstName: 'X',\r\n                lastName: 'Y',\r\n                rut: rut,\r\n                rutHash: rutHash,\r\n                passwordHash: 'hash',\r\n                isVerified: true\r\n            }\r\n        });\r\n\r\n        const payload = {\r\n            email: `another-${unique}@test.com`, // Different Email\r\n            password: 'password123',\r\n            rut: rut, // Duplicate RUT\r\n            firstName: 'Copy',\r\n            lastName: 'Cat',\r\n            buildingId: buildingId,\r\n            unitNumber: '101'\r\n        };\r\n        // ...\r\n\r\n        const res = await request(app)\r\n            .post('/api/auth/signup')\r\n            .send(payload);\r\n\r\n        expect(res.status).toBe(409);\r\n        expect(res.body.error).toMatch(/already registered/i);\r\n    });\r\n\r\n    it('should validate input types (Zod)', async () => {\r\n        const payload = {\r\n            email: 'not-an-email',\r\n            password: '123', // Too short\r\n            // Missing RUT\r\n            // Missing Names\r\n        };\r\n\r\n        const res = await request(app)\r\n            .post('/api/auth/signup')\r\n            .send(payload);\r\n\r\n        expect(res.status).toBe(400);\r\n        // Zod returns array of errors\r\n        expect(res.body.error).toBeInstanceOf(Array);\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\verify-admin.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":7,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":7,"endColumn":20,"suggestions":[{"fix":{"range":[127,168],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":13,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":13,"endColumn":20,"suggestions":[{"fix":{"range":[328,365],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":14,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":14,"endColumn":20,"suggestions":[{"fix":{"range":[375,418],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":15,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":15,"endColumn":20,"suggestions":[{"fix":{"range":[428,498],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[655,658],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[655,658],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\r\n\r\nconst API_URL = 'http://localhost:3000/api/auth';\r\n\r\nasync function main() {\r\n    try {\r\n        console.log('🔄 Testing Admin Login...');\r\n        const res = await axios.post(`${API_URL}/login`, {\r\n            email: 'admin@example.com',\r\n            password: 'admin123'\r\n        });\r\n\r\n        console.log('✅ Admin Login Success');\r\n        console.log(`Role: ${res.data.user.role}`);\r\n        console.log(`Token: ${res.data.accessToken ? 'Present' : 'Missing'}`);\r\n\r\n        if (res.data.user.role !== 'admin') {\r\n            console.error('❌ Role mismatch');\r\n            process.exit(1);\r\n        }\r\n\r\n    } catch (e: any) {\r\n        console.error('❌ Admin Login Failed', e.response?.data || e.message);\r\n        process.exit(1);\r\n    }\r\n}\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\verify-audit-fixes.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\verify-auth.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":17,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":17,"endColumn":20,"suggestions":[{"fix":{"range":[503,572],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":27,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":27,"endColumn":20,"suggestions":[{"fix":{"range":[910,961],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":38,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":38,"endColumn":24,"suggestions":[{"fix":{"range":[1330,1379],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1403,1406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1403,1406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":45,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":45,"endColumn":20,"suggestions":[{"fix":{"range":[1566,1603],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":51,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":51,"endColumn":24,"suggestions":[{"fix":{"range":[1789,1836],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":52,"column":44,"nodeType":"MemberExpression","messageId":"limited","endLine":52,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1934,1937],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1934,1937],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\nconst API_URL = 'http://localhost:3000/api/auth';\r\n\r\nasync function main() {\r\n    try {\r\n        // 1. Get Context\r\n        const building = await prisma.building.findFirst();\r\n        const unit = await prisma.unit.findFirst();\r\n\r\n        if (!building || !unit) {\r\n            console.error('❌ No building/unit found. Run seed first.');\r\n            process.exit(1);\r\n        }\r\n        console.log(`ℹ️  Using Building: ${building.name} (${building.id})`);\r\n\r\n        // 2. Prepare Data\r\n        const uniqueId = Date.now();\r\n        const email = `test-${uniqueId}@example.com`;\r\n        // RUT max 12 chars. Date.now() is 13.\r\n        // Use last 9 digits: 12345678-9\r\n        const rut = `${uniqueId.toString().slice(-8)}-${Math.floor(Math.random() * 10)}`;\r\n\r\n        // 3. Signup\r\n        console.log(`\\n🔄 Testing Signup for ${email}...`);\r\n        try {\r\n            const signupRes = await axios.post(`${API_URL}/signup`, {\r\n                email,\r\n                password: 'securepassword123',\r\n                rut,\r\n                firstName: 'Test',\r\n                lastName: 'User',\r\n                buildingId: building.id,\r\n                unitNumber: unit.unitNumber\r\n            });\r\n            console.log('✅ Signup Success:', signupRes.data);\r\n        } catch (err: any) {\r\n            console.error('❌ Signup Failed:', err.response?.data || err.message);\r\n            process.exit(1);\r\n        }\r\n\r\n        // 4. Login\r\n        console.log(`\\n🔄 Testing Login...`);\r\n        try {\r\n            const loginRes = await axios.post(`${API_URL}/login`, {\r\n                email,\r\n                password: 'securepassword123'\r\n            });\r\n            console.log('✅ Login Success:', loginRes.data);\r\n            if (loginRes.data.accessToken) console.log('✅ JWT Present');\r\n        } catch (err: any) {\r\n            console.error('❌ Login Failed:', err.response?.data || err.message);\r\n            process.exit(1);\r\n        }\r\n\r\n    } catch (e) {\r\n        console.error(e);\r\n    } finally {\r\n        await prisma.$disconnect();\r\n    }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\verify-booking.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":58,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":58,"endColumn":20,"suggestions":[{"fix":{"range":[2078,2147],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":61,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":61,"endColumn":20,"suggestions":[{"fix":{"range":[2181,2217],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2408,2411],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2408,2411],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":66,"column":20,"nodeType":"MemberExpression","messageId":"limited","endLine":66,"endColumn":31},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":69,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":69,"endColumn":24,"suggestions":[{"fix":{"range":[2589,2642],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":86,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":86,"endColumn":20,"suggestions":[{"fix":{"range":[3248,3285],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":89,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":89,"endColumn":20,"suggestions":[{"fix":{"range":[3317,3361],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":98,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":98,"endColumn":20,"suggestions":[{"fix":{"range":[3647,3749],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":101,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":101,"endColumn":20,"suggestions":[{"fix":{"range":[3804,3862],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4264,4267],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4264,4267],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":113,"column":17,"nodeType":"MemberExpression","messageId":"limited","endLine":113,"endColumn":28,"suggestions":[{"fix":{"range":[4335,4401],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":119,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4555,4558],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4555,4558],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\r\nimport { PrismaClient, DurationType } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\nconst API_URL = 'http://localhost:3000';\r\n\r\nasync function main() {\r\n    try {\r\n        // 0. Setup: Ensure we have a resident and a token\r\n        const building = await prisma.building.findFirst();\r\n        const resident = await prisma.resident.findFirst({\r\n            where: { unit: { buildingId: building?.id } }\r\n        });\r\n\r\n        if (!building || !resident) {\r\n            console.error('Run seed/verify-auth first');\r\n            process.exit(1);\r\n        }\r\n\r\n        // We need a fresh token (or login again)\r\n        // Quick login\r\n        // Note: In real test we should login. But for speed we can self-generate one if we import `signToken`.\r\n        // Let's use the API login to be integration-pure.\r\n        // Need resident's email.\r\n\r\n        let token = '';\r\n        // We don't know the password of the first found resident if it was from previous run random email.\r\n        // But verify-auth created one.\r\n        // We will just create a NEW seeded resident for this test to be sure of password.\r\n\r\n        // Actually, let's create a fresh avail block to test.\r\n        const spot = await prisma.visitorSpot.create({\r\n            data: {\r\n                buildingId: building.id,\r\n                spotNumber: `V-${Date.now().toString().slice(-4)}`,\r\n                isActive: true\r\n            }\r\n        });\r\n\r\n        // Create Availability for Tomorrow\r\n        const start = new Date();\r\n        start.setDate(start.getDate() + 1);\r\n        start.setHours(8, 0, 0, 0);\r\n        const end = new Date(start);\r\n        end.setHours(19, 0, 0, 0); // 11h\r\n\r\n        const block = await prisma.availabilityBlock.create({\r\n            data: {\r\n                spotId: spot.id,\r\n                startDatetime: start,\r\n                endDatetime: end,\r\n                durationType: DurationType.ELEVEN_HOURS,\r\n                basePriceClp: 5000,\r\n                status: 'available'\r\n            }\r\n        });\r\n\r\n        console.log(`✅ Seeded Block: ${block.id} (Status: ${block.status})`);\r\n\r\n        // 1. Search\r\n        console.log('🔄 Testing Search...');\r\n        const searchRes = await axios.get(`${API_URL}/api/spots/search`, {\r\n            params: { buildingId: building.id }\r\n        });\r\n        const found = searchRes.data.data.find((b: any) => b.id === block.id);\r\n        if (found) console.log('✅ Search Found the block');\r\n        else {\r\n            console.error('❌ Search did not find the block');\r\n            console.log(JSON.stringify(searchRes.data, null, 2));\r\n        }\r\n\r\n        // 2. Login (Create temp user first)\r\n        const unique = Date.now();\r\n        const email = `booker-${unique}@test.com`;\r\n        const rut = `${unique.toString().slice(-8)}-K`;\r\n\r\n        await axios.post(`${API_URL}/api/auth/signup`, {\r\n            email, password: 'password123', rut, firstName: 'Booker', lastName: 'T',\r\n            buildingId: building.id, unitNumber: '101'\r\n        });\r\n\r\n        const loginRes = await axios.post(`${API_URL}/api/auth/login`, {\r\n            email, password: 'password123'\r\n        });\r\n        token = loginRes.data.accessToken;\r\n        console.log('✅ Logged in as Booker');\r\n\r\n        // 3. Book\r\n        console.log('🔄 Testing Create Booking...');\r\n        const bookRes = await axios.post(`${API_URL}/api/bookings/create`, {\r\n            blockId: block.id,\r\n            vehiclePlate: 'ABCD-12',\r\n            visitorName: 'Visitor One'\r\n        }, {\r\n            headers: { Authorization: `Bearer ${token}` }\r\n        });\r\n\r\n        console.log(`✅ Booking Created: ${bookRes.data.booking.id} (Status: ${bookRes.data.booking.status})`);\r\n\r\n        // 4. Verify Double Booking Fails\r\n        console.log('🔄 Testing Double Booking (should fail)...');\r\n        try {\r\n            await axios.post(`${API_URL}/api/bookings/create`, {\r\n                blockId: block.id,\r\n                vehiclePlate: 'FAIl-00',\r\n                visitorName: 'Visitor Two'\r\n            }, {\r\n                headers: { Authorization: `Bearer ${token}` }\r\n            });\r\n            console.error('❌ Double Booking SUCCEEDED (Should have failed)');\r\n        } catch (e: any) {\r\n            if (e.response?.status === 409) {\r\n                console.log('✅ Double Booking Failed as expected (409 Conflict)');\r\n            } else {\r\n                console.error(`❌ Unexpected error: ${e.message}`, e.response?.data);\r\n            }\r\n        }\r\n\r\n    } catch (e: any) {\r\n        console.error(e.message, e.response?.data);\r\n    } finally {\r\n        await prisma.$disconnect();\r\n    }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\verify-payment.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":47,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":47,"endColumn":20,"suggestions":[{"fix":{"range":[1816,1873],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":51,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":51,"endColumn":20,"suggestions":[{"fix":{"range":[2014,2076],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":53,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":53,"endColumn":24,"suggestions":[{"fix":{"range":[2156,2195],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":58,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":58,"endColumn":20,"suggestions":[{"fix":{"range":[2286,2331],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":62,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":62,"endColumn":20,"suggestions":[{"fix":{"range":[2473,2503],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":66,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":66,"endColumn":20,"suggestions":[{"fix":{"range":[2635,2714],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":67,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":67,"endColumn":20,"suggestions":[{"fix":{"range":[2724,2805],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error, info.","line":70,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":70,"endColumn":24,"suggestions":[{"fix":{"range":[2876,2921],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3054,3057],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3054,3057],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\r\nimport { PrismaClient, DurationType } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\nconst API_URL = 'http://localhost:3000';\r\n\r\nasync function main() {\r\n    try {\r\n        // 1. Setup Data (Need a booking)\r\n        // Reuse existing building/unit\r\n        const building = await prisma.building.findFirst();\r\n        if (!building) process.exit(1);\r\n\r\n        // Login\r\n        const unique = Date.now();\r\n        const email = `payer-${unique}@test.com`;\r\n        await axios.post(`${API_URL}/api/auth/signup`, {\r\n            email, password: 'password123', rut: `${unique.toString().slice(-8)}-1`, firstName: 'Payer', lastName: 'X',\r\n            buildingId: building.id, unitNumber: '101'\r\n        });\r\n        const login = await axios.post(`${API_URL}/api/auth/login`, { email, password: 'password123' });\r\n        const token = login.data.accessToken;\r\n\r\n        // Create Spot & Block\r\n        const spot = await prisma.visitorSpot.create({\r\n            data: { buildingId: building.id, spotNumber: `P-${unique.toString().slice(-4)}` }\r\n        });\r\n        const block = await prisma.availabilityBlock.create({\r\n            data: {\r\n                spotId: spot.id,\r\n                status: 'available',\r\n                durationType: DurationType.ELEVEN_HOURS,\r\n                basePriceClp: 2000,\r\n                startDatetime: new Date(),\r\n                endDatetime: new Date(Date.now() + 3600000)\r\n            }\r\n        });\r\n\r\n        // Book\r\n        const bookRes = await axios.post(`${API_URL}/api/bookings/create`, {\r\n            blockId: block.id,\r\n            vehiclePlate: 'PAY-11',\r\n            visitorName: 'Payer Guest'\r\n        }, { headers: { Authorization: `Bearer ${token}` } });\r\n\r\n        const bookingId = bookRes.data.booking.id;\r\n        console.log(`✅ Booking Created: ${bookingId} (pending)`);\r\n\r\n        // 2. Checkout (Mock)\r\n        const checkoutRes = await axios.post(`${API_URL}/api/payments/checkout`, { bookingId });\r\n        console.log(`✅ Checkout URL: ${checkoutRes.data.init_point}`);\r\n        if (checkoutRes.data.init_point.includes('mock=true')) {\r\n            console.log('ℹ️  Mock Mode confirmed');\r\n        }\r\n\r\n        // 3. Trigger Webhook (Mock)\r\n        // Simulate callback\r\n        console.log('🔄 Triggering Mock Webhook...');\r\n        await axios.post(`${API_URL}/api/payments/webhook`, {}, {\r\n            params: { mock_booking_id: bookingId }\r\n        });\r\n        console.log('✅ Webhook Sent');\r\n\r\n        // 4. Verify DB\r\n        const updatedBooking = await prisma.booking.findUnique({ where: { id: bookingId } });\r\n        console.log(`Booking Status: ${updatedBooking?.status} (Expected: confirmed)`);\r\n        console.log(`Payment Status: ${updatedBooking?.paymentStatus} (Expected: paid)`);\r\n\r\n        if (updatedBooking?.status === 'confirmed') {\r\n            console.log('✅✅ FULL PAYMENT FLOW VERIFIED');\r\n        } else {\r\n            console.error('❌ Status update failed');\r\n            process.exit(1);\r\n        }\r\n\r\n    } catch (e: any) {\r\n        console.error(e.response?.data || e.message);\r\n    } finally {\r\n        await prisma.$disconnect();\r\n    }\r\n}\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\verify-s2-fixes.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[208,211],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[208,211],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[462,465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[462,465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[530,533],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[530,533],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1965,1968],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1965,1968],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":103,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":106,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2099,2102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2099,2102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":119,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":122,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2115,2118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2115,2118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":92,"column":103,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":106,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2597,2600],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2597,2600],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":92,"column":119,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":122,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2613,2616],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2613,2616],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":101,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2979,2982],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2979,2982],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":100,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":103,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3129,3132],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3129,3132],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":116,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":119,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3145,3148],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3145,3148],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest'\r\n\r\n// Mock Mocks\r\nconst mockRes = {\r\n    status: vi.fn().mockReturnThis(),\r\n    json: vi.fn(),\r\n    setHeader: vi.fn()\r\n}\r\nconst mockReq = (body: any) => ({\r\n    method: 'POST',\r\n    body,\r\n    headers: {}\r\n})\r\n\r\n// Database Mock\r\nconst mockResidentUpdate = vi.fn()\r\nconst mockResidentFind = vi.fn()\r\n\r\nvi.mock('../lib/db', () => ({\r\n    db: {\r\n        resident: {\r\n            findUnique: (...args: any[]) => mockResidentFind(...args),\r\n            update: (...args: any[]) => mockResidentUpdate(...args)\r\n        },\r\n        user: {\r\n            findUnique: vi.fn()\r\n        }\r\n    }\r\n}))\r\n\r\nvi.mock('../services/auth.js', () => ({\r\n    comparePassword: vi.fn(),\r\n    signToken: vi.fn().mockReturnValue('mock-token'),\r\n    getTokenFromRequest: vi.fn(),\r\n    verifyToken: vi.fn()\r\n}))\r\n\r\nvi.mock('../lib/cors', () => ({\r\n    default: vi.fn()\r\n}))\r\n\r\nvi.mock('cookie', () => ({\r\n    serialize: vi.fn().mockReturnValue('cookie-string')\r\n}))\r\n\r\nimport loginHandler from '../api/auth/login.js'\r\nimport { comparePassword } from '../services/auth.js'\r\n\r\ndescribe('S2 Security Fixes Verification', () => {\r\n\r\n    beforeEach(() => {\r\n        vi.clearAllMocks()\r\n    })\r\n\r\n    const unverifiedResident = {\r\n        id: 'res-1',\r\n        email: 'test@example.com',\r\n        unit: { buildingId: 'b1', unitId: 'u1' },\r\n        passwordHash: 'hash',\r\n        isVerified: false,\r\n        failedLoginAttempts: 0,\r\n        lockoutUntil: null\r\n    }\r\n\r\n    const verifiedResident = {\r\n        ...unverifiedResident,\r\n        isVerified: true\r\n    }\r\n\r\n    const lockedResident = {\r\n        ...verifiedResident,\r\n        lockoutUntil: new Date(Date.now() + 100000) // Future\r\n    }\r\n\r\n    describe('Fix 4 (S2): Verification Enforcement', () => {\r\n        it('should reject unverified resident with 403', async () => {\r\n            mockResidentFind.mockResolvedValue(unverifiedResident);\r\n            (comparePassword as any).mockResolvedValue(true)\r\n\r\n            await expect(loginHandler(mockReq({ email: 'test@example.com', password: 'password' }) as any, mockRes as any))\r\n                .rejects.toMatchObject({\r\n                    statusCode: 403,\r\n                    code: 'AUTH-LOGIN-1003' // AUTH_NOT_VERIFIED\r\n                })\r\n        })\r\n    })\r\n\r\n    describe('Fix 5 (S2): Rate Limiting', () => {\r\n        it('should reject locked account with 429', async () => {\r\n            mockResidentFind.mockResolvedValue(lockedResident);\r\n\r\n            await expect(loginHandler(mockReq({ email: 'test@example.com', password: 'password' }) as any, mockRes as any))\r\n                .rejects.toMatchObject({\r\n                    statusCode: 429,\r\n                    code: 'AUTH-LOGIN-1002' // AUTH_ACCOUNT_LOCKED\r\n                })\r\n        })\r\n\r\n        it('should increment failed attempts on bad password', async () => {\r\n            mockResidentFind.mockResolvedValue(verifiedResident);\r\n            (comparePassword as any).mockResolvedValue(false) // Wrong password\r\n\r\n            await expect(loginHandler(mockReq({ email: 'test@example.com', password: 'wrong' }) as any, mockRes as any))\r\n                .rejects.toMatchObject({\r\n                    statusCode: 401,\r\n                    code: 'AUTH-LOGIN-1001' // AUTH_INVALID_CREDENTIALS\r\n                })\r\n\r\n            expect(mockResidentUpdate).toHaveBeenCalledWith(expect.objectContaining({\r\n                data: expect.objectContaining({ failedLoginAttempts: 1 })\r\n            }))\r\n        })\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\tests\\verify-security-hotfixes.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[197,200],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[197,200],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[213,216],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[213,216],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[662,665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[662,665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createBookingHandler' is defined but never used.","line":47,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":47,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'db' is defined but never used.","line":49,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":49,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1712,1715],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1712,1715],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1797,1800],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1797,1800],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1813,1816],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1813,1816],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2081,2084],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2081,2084],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2150,2153],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2150,2153],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2267,2270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2267,2270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2283,2286],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2283,2286],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2536,2539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2536,2539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2602,2605],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2602,2605],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":83,"column":102,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":105,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2886,2889],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2886,2889],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":83,"column":118,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":121,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2902,2905],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2902,2905],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":16,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest'\r\n\r\n// Mocks\r\nconst mockRes = {\r\n    status: vi.fn().mockReturnThis(),\r\n    json: vi.fn()\r\n}\r\nconst mockReq = (method: string, headers: any = {}, body: any = {}) => ({\r\n    method,\r\n    headers,\r\n    body\r\n})\r\n\r\n// Mock Modules\r\nvi.mock('../lib/db.js', () => ({\r\n    db: {\r\n        availabilityBlock: {\r\n            updateMany: vi.fn().mockResolvedValue({ count: 1 }),\r\n            findUniqueOrThrow: vi.fn() // Will override in test\r\n        },\r\n        booking: {\r\n            create: vi.fn().mockResolvedValue({ id: 'booking-123', status: 'pending' })\r\n        },\r\n        $transaction: async (cb: any) => cb({\r\n            availabilityBlock: {\r\n                updateMany: vi.fn().mockResolvedValue({ count: 1 }),\r\n                findUniqueOrThrow: vi.fn()\r\n            },\r\n            booking: {\r\n                create: vi.fn()\r\n            }\r\n        })\r\n    }\r\n}))\r\n\r\nvi.mock('../services/auth.js', () => ({\r\n    getTokenFromRequest: vi.fn(),\r\n    verifyToken: vi.fn()\r\n}))\r\n\r\nvi.mock('../lib/cors.js', () => ({\r\n    default: vi.fn()\r\n}))\r\n\r\n// Import handlers (using require to allow rehashing mocks if needed, but import works too)\r\nimport adminPricesHandler from '../api/admin/prices.js'\r\nimport createBookingHandler from '../api/bookings/create.js'\r\nimport { getTokenFromRequest, verifyToken } from '../services/auth.js'\r\nimport { db } from '../lib/db.js'\r\n\r\ndescribe('Security Hotfixes Verification', () => {\r\n\r\n    beforeEach(() => {\r\n        vi.clearAllMocks()\r\n    })\r\n\r\n    describe('Fix 1 (S0): Admin Prices Auth', () => {\r\n        it('should reject requests without token (401)', async () => {\r\n            (getTokenFromRequest as any).mockReturnValue(null)\r\n\r\n            await adminPricesHandler(mockReq('PUT') as any, mockRes as any)\r\n\r\n            expect(mockRes.status).toHaveBeenCalledWith(401)\r\n            expect(mockRes.json).toHaveBeenCalledWith({ error: 'Missing token' })\r\n        })\r\n\r\n        it('should reject non-admin users (403)', async () => {\r\n            (getTokenFromRequest as any).mockReturnValue('token-resident');\r\n            (verifyToken as any).mockReturnValue({ role: 'resident', userId: 'res1' })\r\n\r\n            await adminPricesHandler(mockReq('PUT') as any, mockRes as any)\r\n\r\n            expect(mockRes.status).toHaveBeenCalledWith(403)\r\n            expect(mockRes.json).toHaveBeenCalledWith({ error: 'Forbidden' })\r\n        })\r\n\r\n        it('should allow admin users', async () => {\r\n            (getTokenFromRequest as any).mockReturnValue('token-admin');\r\n            (verifyToken as any).mockReturnValue({ role: 'admin', userId: 'adm1' })\r\n\r\n            // Use valid UUID to pass Zod validation\r\n            const validUuid = '123e4567-e89b-12d3-a456-426614174000'\r\n            await adminPricesHandler(mockReq('PUT', {}, { buildingId: validUuid, newPrice: 100 }) as any, mockRes as any)\r\n\r\n            // Should pass checks and try to update db (which is mocked)\r\n            expect(mockRes.status).toHaveBeenCalledWith(200)\r\n        })\r\n    })\r\n\r\n    // IDOR Test needs more complex mocking because `create.ts` imports db directly and we mock `db` but transaction logic can be tricky.\r\n    // However, we can assert that if we mocking `findUniqueOrThrow` to return a block from WRONG building, it throws.\r\n\r\n    // We can't easily enable the \"transaction\" callback mock structure perfectly here without deeper mocks.\r\n    // Skipping deep transaction test, relying on code review + admin check above which is critical.\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\types\\express-shim.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\corte\\VS Code Projects\\estacionate-mvp\\backend\\vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
