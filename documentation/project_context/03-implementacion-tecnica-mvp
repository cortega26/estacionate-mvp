<!-- filename: 03-implementacion-tecnica-mvp.md -->

# Implementaci√≥n T√©cnica MVP

## 3.1 Supuestos T√©cnicos y Alcance

### Supuestos de Volumen Inicial
- **Edificios piloto:** 2-3 edificios con 40-60 unidades cada uno
- **Usuarios activos:** 50-100 residentes verificados en 3 meses
- **Reservas/mes:** 100-300 transacciones (2-3% volumen target)
- **Picos de tr√°fico:** 10x normal durante fines de semana y feriados

### SLOs (Service Level Objectives)
- **Disponibilidad:** 99.5% (permitiendo 3.6h downtime/mes)
- **Latencia API:** p95 < 500ms para endpoints cr√≠ticos
- **Tiempo de respuesta b√∫squeda:** < 2s para consultas de disponibilidad
- **Pagos:** 99.9% de transacciones procesadas exitosamente

### Restricciones CLP Enteros
- Todos los montos almacenados y mostrados en pesos chilenos sin decimales
- C√°lculos de comisiones redondeados hacia arriba (ceil) para evitar p√©rdidas
- Conciliaci√≥n simplificada al eliminar diferencias por centavos

### Zonas Horarias y Feriados Chile
- **Timezone:** America/Santiago con manejo autom√°tico DST
- **Ventanas horarias:** 11h (08:00-19:00) y 23h (06:00-05:00 d√≠a siguiente)
- **Feriados:** Integraci√≥n con API feriados Chile para bloqueos autom√°ticos

## 3.2 Pasos Concretos para Lanzar V1

### Semana 1: Descubrimiento y Validaci√≥n

**Entrevistas de Validaci√≥n (5-10 administradoras)**
```
Gui√≥n de Entrevista:
1. ¬øCu√°ntos espacios de visita tienen disponibles diariamente?
2. ¬øQu√© problemas enfrentan con estacionamientos para invitados?
3. ¬øEstar√≠an dispuestos a compartir 20% de ingresos por digitalizaci√≥n?
4. ¬øC√≥mo valida actualmente la conserjer√≠a las visitas?
5. ¬øQu√© resistencias esperan de residentes por cobro de estacionamiento?
```

**Piloto de Edificios (1-2 seleccionados)**
- [ ] Edificio A: >40 unidades, conserjer√≠a 24/7, administradora innovadora
- [ ] Edificio B: >30 unidades, perfil socioecon√≥mico medio-alto, d√©ficit parking
- [ ] Acordar prueba gratuita por 4 semanas con m√©tricas espec√≠ficas

**KPIs Piloto Objetivo:**
- Conversi√≥n b√∫squeda ‚Üí reserva: 25%+
- Cancelaci√≥n: <10%
- NPS residentes: 7.0+
- NPS administradora: 8.0+
- Ocupaci√≥n promedio: 15%+ de capacidad disponible

### Semana 2: Dise√±o UX M√≥vil-first (PWA)

**Wireframes Esenciales**
1. **Landing/Login:** Verificaci√≥n residente con email edificio + RUT
2. **B√∫squeda:** Calendario con disponibilidad 11h/23h, precios din√°micos  
3. **Checkout:** Resumen reserva, datos visitante, pago MercadoPago
4. **Confirmaci√≥n:** QR/c√≥digo acceso, instrucciones llegada, contacto conserjer√≠a
5. **Historial:** Reservas pasadas/futuras, reembolsos, soporte

**Microcopy Chile-espec√≠fico**
- "Reservar cupo de estacionamiento" vs "parking slot"
- "Medio d√≠a (11 horas)" / "D√≠a completo (23 horas)"  
- "Patente del veh√≠culo" vs "placa"
- "Conserje" vs "portero" o "vigilante"

### Semana 3: Implementaci√≥n Backend + Infraestructura

**Configuraci√≥n Repositorios**
```bash
# Frontend est√°tico
github.com/estaci√≥nate/web-app
- React + Vite + TailwindCSS
- PWA manifest + service worker
- GitHub Actions ‚Üí GitHub Pages

# Backend API
github.com/estaci√≥nate/api
- TypeScript + Node.js
- Vercel Functions
- GitHub Actions ‚Üí Vercel
```

**CI/CD Pipeline**
- Tests automatizados (Jest + Supertest)
- Linting (ESLint + Prettier)  
- Security scanning (Snyk + Dependabot)
- Deployment staging + production

**Dominios y SSL**
- `app.estacionate.cl` (frontend)
- `api.estacionate.cl` (backend)
- Certificados SSL autom√°ticos via Vercel

**Anal√≠tica y Monitoreo**
- Google Analytics 4 para frontend
- Vercel Analytics para performance
- Sentry para error tracking
- Uptime monitoring (UptimeRobot)

### Semana 4: Integraci√≥n Pagos y Testing

**MercadoPago Sandbox Setup**
```javascript
// Configuraci√≥n inicial SDK
import { MercadoPagoConfig, Payment, Preference } from 'mercadopago';

const client = new MercadoPagoConfig({ 
  accessToken: process.env.MP_ACCESS_TOKEN,
  options: { timeout: 5000, integratorId: 'dev_24c65fb163bf11ea96500242ac130004' }
});
```

**Flujo de Checkout Completo**
1. Crear preferencia con items, payer info, external_reference
2. Redirect a Checkout Pro con success/failure URLs  
3. Webhook validation con firma HMAC-SHA256
4. Actualizaci√≥n estado reserva + notificaci√≥n usuario
5. Conciliaci√≥n diaria automated

**Testing Integral**
- Unit tests: 80%+ cobertura funciones cr√≠ticas
- Integration tests: flujo completo reserva + pago
- E2E tests: Playwright con escenarios principales
- Load testing: Artillery.js simulando 100 usuarios concurrentes

## 3.3 Arquitectura T√©cnica

### Frontend: React SPA + PWA
**Stack T√©cnico:**
- **React 18** con hooks para estado local
- **Vite** para bundling optimizado y fast refresh
- **TailwindCSS** para styling responsive
- **Tanstack Query** para cache y sync estado servidor
- **React Router** para navegaci√≥n SPA

**PWA Caracter√≠sticas:**
```json
// manifest.json
{
  "name": "Estaci√≥nate",
  "short_name": "Estaci√≥nate",
  "display": "standalone",
  "start_url": "/",
  "theme_color": "#1f2937",
  "icons": [
    { "src": "/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

**Estado Ligero (Zustand)**
```javascript
const useAppStore = create((set, get) => ({
  user: null,
  building: null,
  currentReservation: null,
  setUser: (user) => set({ user }),
  clearSession: () => set({ user: null, building: null })
}));
```

### Backend: Vercel Functions + TypeScript
**Estructura Proyecto:**
```
/api
‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îú‚îÄ‚îÄ login.ts
‚îÇ   ‚îú‚îÄ‚îÄ signup.ts  
‚îÇ   ‚îî‚îÄ‚îÄ verify-resident.ts
‚îú‚îÄ‚îÄ spots/
‚îÇ   ‚îú‚îÄ‚îÄ search.ts
‚îÇ   ‚îî‚îÄ‚îÄ [id]/availability.ts
‚îú‚îÄ‚îÄ bookings/
‚îÇ   ‚îú‚îÄ‚îÄ create.ts
‚îÇ   ‚îî‚îÄ‚îÄ [id]/cancel.ts
‚îú‚îÄ‚îÄ payments/
‚îÇ   ‚îú‚îÄ‚îÄ checkout.ts
‚îÇ   ‚îú‚îÄ‚îÄ webhook.ts
‚îÇ   ‚îî‚îÄ‚îÄ refund.ts
‚îî‚îÄ‚îÄ lib/
    ‚îú‚îÄ‚îÄ db.ts
    ‚îú‚îÄ‚îÄ auth.ts
    ‚îî‚îÄ‚îÄ payments.ts
```

**Control de Concurrencia**
```javascript
// Prevenir doble-reserva con locks optimistas
export async function reserveSpot(spotId: string, bookingData: BookingCreate) {
  const result = await db.transaction(async (tx) => {
    // Verificar disponibilidad con lock
    const spot = await tx.select().from(availabilityBlocks)
      .where(eq(availabilityBlocks.id, spotId))
      .where(eq(availabilityBlocks.status, 'available'))
      .for('update');
    
    if (!spot.length) throw new Error('SPOT_UNAVAILABLE');
    
    // Crear reserva at√≥mica
    return tx.insert(bookings).values(bookingData).returning();
  });
  
  return result[0];
}
```

### Base de Datos: PostgreSQL (Neon)
**Configuraci√≥n Connection Pool**
```javascript
import { drizzle } from 'drizzle-orm/neon-http';
import { neon, neonConfig } from '@neondatabase/serverless';

neonConfig.fetchConnectionCache = true;
const sql = neon(process.env.DATABASE_URL!);
export const db = drizzle(sql);
```

**Migraciones Automatizadas**
- Drizzle ORM con schema TypeScript
- GitHub Actions ejecuta migraciones en deploy
- Rollback autom√°tico si migraci√≥n falla

### Autenticaci√≥n: JWT + Verificaci√≥n Residentes
**Flujo de Verificaci√≥n:**
1. Usuario ingresa email edificio (ej: `juan.perez@edificio-sanmartin.cl`)
2. Validaci√≥n formato email + dominio vs. whitelist edificios
3. C√≥digo verificaci√≥n SMS/email + validaci√≥n RUT chileno
4. Admin edificio confirma residencia manualmente (primera vez)
5. JWT issued con claims: `userId`, `buildingId`, `unitNumber`, `role`
```javascript
// Middleware autenticaci√≥n
export function withAuth(handler: ApiHandler): ApiHandler {
  return async (req, res) => {
    const token = req.headers.authorization?.replace('Bearer ', '');
    if (!token) return res.status(401).json({ error: 'UNAUTHORIZED' });
    
    try {
      const decoded = jwt.verify(token, process.env.JWT_SECRET!) as JWTPayload;
      req.user = await getUserById(decoded.userId);
      return handler(req, res);
    } catch (error) {
      return res.status(401).json({ error: 'TOKEN_INVALID' });
    }
  };
}
```

### Pagos: MercadoPago + Fintoc Dual Setup
**MercadoPago Preferences:**
```javascript
export async function createPaymentPreference(booking: Booking) {
  const preference = new Preference(mpClient);
  
  return await preference.create({
    body: {
      items: [{
        id: booking.id,
        title: `Estacionamiento ${booking.building.name} - ${booking.duration}`,
        quantity: 1,
        unit_price: booking.amount, // CLP enteros
        currency_id: 'CLP'
      }],
      payer: {
        email: booking.resident.email,
        identification: {
          type: 'RUT',
          number: booking.resident.rut
        }
      },
      external_reference: booking.id,
      notification_url: `${process.env.API_URL}/payments/webhook`,
      back_urls: {
        success: `${process.env.WEB_URL}/booking/${booking.id}/success`,
        failure: `${process.env.WEB_URL}/booking/${booking.id}/failure`,
        pending: `${process.env.WEB_URL}/booking/${booking.id}/pending`
      },
      auto_return: 'approved'
    }
  });
}
```

**Webhook Validation:**
```javascript
export default withRateLimit(async (req: NextApiRequest, res: NextApiResponse) => {
  // Validar firma HMAC
  const signature = req.headers['x-signature'] as string;
  const expectedSignature = crypto
    .createHmac('sha256', process.env.MP_WEBHOOK_SECRET!)
    .update(JSON.stringify(req.body))
    .digest('hex');
  
  if (signature !== expectedSignature) {
    return res.status(401).json({ error: 'INVALID_SIGNATURE' });
  }
  
  const { action, data } = req.body;
  
  if (action === 'payment.updated') {
    await handlePaymentUpdate(data.id);
  }
  
  res.status(200).json({ received: true });
});
```

### Observabilidad y Monitoreo
**Logs Estructurados:**
```javascript
import winston from 'winston';

const logger = winston.createLogger({
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'app.log' })
  ]
});

// Usage en endpoints
logger.info('Booking created', {
  bookingId: booking.id,
  buildingId: booking.buildingId,
  amount: booking.amount,
  duration: booking.duration
});
```

**M√©tricas de Negocio:**
- `bookings_created_total` (counter)
- `payment_success_rate` (gauge) 
- `spot_occupancy_rate` (gauge)
- `api_request_duration_seconds` (histogram)
- `websocket_connections_active` (gauge)

**Alertas Cr√≠ticas:**
- Error rate > 5% por 5 minutos
- Response time p95 > 1s por 10 minutos  
- Payment webhook failures > 3 en 1 hora
- Database connection pool exhaustion

### Seguridad
**Rate Limiting:**
```javascript
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '1 m'), // 10 requests per minute
});

export function withRateLimit(handler: ApiHandler) {
  return async (req: NextApiRequest, res: NextApiResponse) => {
    const ip = req.headers['x-forwarded-for'] || req.connection.remoteAddress;
    const { success } = await ratelimit.limit(ip as string);
    
    if (!success) {
      return res.status(429).json({ error: 'RATE_LIMIT_EXCEEDED' });
    }
    
    return handler(req, res);
  };
}
```

**Security Headers:**
```javascript
// next.config.js
const securityHeaders = [
  { key: 'X-DNS-Prefetch-Control', value: 'on' },
  { key: 'Strict-Transport-Security', value: 'max-age=63072000' },
  { key: 'X-Content-Type-Options', value: 'nosniff' },
  { key: 'X-Frame-Options', value: 'DENY' },
  { key: 'X-XSS-Protection', value: '1; mode=block' },
  { key: 'Referrer-Policy', value: 'origin-when-cross-origin' }
];
```

**Gesti√≥n de Secretos:**
```bash
# Vercel Environment Variables
DATABASE_URL=postgresql://...
JWT_SECRET=...
MP_ACCESS_TOKEN=...
MP_WEBHOOK_SECRET=...
SENTRY_DSN=...
```

### Diagrama de Arquitectura (ASCII)
```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   React PWA     ‚îÇ
                    ‚îÇ  (GitHub Pages) ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ HTTPS/JWT
                             ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  Vercel Edge    ‚îÇ
                    ‚îÇ   Functions     ‚îÇ
                    ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
                    ‚îÇ ‚îÇ    Auth     ‚îÇ ‚îÇ
                    ‚îÇ ‚îÇ   Spots     ‚îÇ ‚îÇ
                    ‚îÇ ‚îÇ  Bookings   ‚îÇ ‚îÇ
                    ‚îÇ ‚îÇ  Payments   ‚îÇ ‚îÇ
                    ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ     ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚ñº                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PostgreSQL    ‚îÇ                   ‚îÇ  MercadoPago    ‚îÇ
‚îÇ     (Neon)      ‚îÇ                   ‚îÇ     API         ‚îÇ
‚îÇ                 ‚îÇ                   ‚îÇ                 ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ                   ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  Buildings  ‚îÇ ‚îÇ                   ‚îÇ ‚îÇ  Payments   ‚îÇ ‚îÇ
‚îÇ ‚îÇ  Residents  ‚îÇ ‚îÇ                   ‚îÇ ‚îÇ  Webhooks   ‚îÇ ‚îÇ
‚îÇ ‚îÇ  Bookings   ‚îÇ ‚îÇ                   ‚îÇ ‚îÇ Preferences ‚îÇ ‚îÇ
‚îÇ ‚îÇ  Payments   ‚îÇ ‚îÇ                   ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## 3.4 Modelo de Datos + SQL

### Tablas Core con Relaciones
```sql
-- Edificios y administradoras
CREATE TABLE buildings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  address TEXT NOT NULL,
  admin_company VARCHAR(255),
  contact_email VARCHAR(255) NOT NULL,
  phone VARCHAR(20),
  total_units INTEGER NOT NULL,
  visitor_spots_count INTEGER NOT NULL DEFAULT 0,
  timezone VARCHAR(50) DEFAULT 'America/Santiago',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Unidades habitacionales
CREATE TABLE units (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  building_id UUID REFERENCES buildings(id) ON DELETE CASCADE,
  unit_number VARCHAR(10) NOT NULL,
  floor INTEGER,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(building_id, unit_number)
);

-- Residentes verificados
CREATE TABLE residents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  unit_id UUID REFERENCES units(id) ON DELETE CASCADE,
  email VARCHAR(255) UNIQUE NOT NULL,
  rut VARCHAR(12) UNIQUE NOT NULL,
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100) NOT NULL,
  phone VARCHAR(20),
  is_verified BOOLEAN DEFAULT false,
  verified_at TIMESTAMP,
  verification_code VARCHAR(10),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Espacios de estacionamiento
CREATE TABLE visitor_spots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  building_id UUID REFERENCES buildings(id) ON DELETE CASCADE,
  spot_number VARCHAR(10) NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(building_id, spot_number)
);

-- Bloques de disponibilidad (inventario din√°mico)
CREATE TABLE availability_blocks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  spot_id UUID REFERENCES visitor_spots(id) ON DELETE CASCADE,
  start_datetime TIMESTAMP NOT NULL,
  end_datetime TIMESTAMP NOT NULL,
  duration_type VARCHAR(10) CHECK (duration_type IN ('11h', '23h')),
  base_price_clp INTEGER NOT NULL, -- CLP sin centavos
  status VARCHAR(20) DEFAULT 'available' CHECK (status IN ('available', 'reserved', 'blocked')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Reservas de estacionamiento
CREATE TABLE bookings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  resident_id UUID REFERENCES residents(id) ON DELETE RESTRICT,
  availability_block_id UUID REFERENCES availability_blocks(id) ON DELETE RESTRICT,
  visitor_name VARCHAR(255) NOT NULL,
  visitor_phone VARCHAR(20),
  vehicle_plate VARCHAR(10) NOT NULL,
  amount_clp INTEGER NOT NULL,
  commission_clp INTEGER NOT NULL, -- Take rate calculado
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'cancelled', 'completed', 'no_show')),
  payment_status VARCHAR(20) DEFAULT 'pending' CHECK (payment_status IN ('pending', 'paid', 'failed', 'refunded')),
  confirmation_code VARCHAR(10) UNIQUE NOT NULL,
  special_instructions TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Pagos y transacciones
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  booking_id UUID REFERENCES bookings(id) ON DELETE RESTRICT,
  external_payment_id VARCHAR(255), -- MercadoPago payment ID
  payment_method VARCHAR(50), -- 'mercadopago', 'fintoc'
  amount_clp INTEGER NOT NULL,
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'cancelled', 'refunded')),
  gateway_response JSONB, -- Respuesta completa del gateway
  processed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Distribuci√≥n de ingresos
CREATE TABLE payouts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  building_id UUID REFERENCES buildings(id) ON DELETE RESTRICT,
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  total_revenue_clp INTEGER NOT NULL,
  platform_commission_clp INTEGER NOT NULL,
  building_share_clp INTEGER NOT NULL,
  status VARCHAR(20) DEFAULT 'calculated' CHECK (status IN ('calculated', 'paid', 'disputed')),
  paid_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Usuarios sistema (admin, soporte)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(20) DEFAULT 'admin' CHECK (role IN ('admin', 'support', 'building_admin')),
  building_id UUID REFERENCES buildings(id), -- NULL para admins globales
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Auditor√≠a de acciones cr√≠ticas
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  table_name VARCHAR(50) NOT NULL,
  record_id UUID NOT NULL,
  action VARCHAR(20) NOT NULL, -- 'CREATE', 'UPDATE', 'DELETE'
  old_values JSONB,
  new_values JSONB,
  user_id UUID REFERENCES users(id),
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Diagrama ER (ASCII)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    1:N    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    1:N    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  buildings  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    units    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  residents  ‚îÇ
‚îÇ             ‚îÇ           ‚îÇ             ‚îÇ           ‚îÇ             ‚îÇ
‚îÇ - id        ‚îÇ           ‚îÇ - id        ‚îÇ           ‚îÇ - id        ‚îÇ
‚îÇ - name      ‚îÇ           ‚îÇ - building_id‚îÇ          ‚îÇ - unit_id   ‚îÇ
‚îÇ - address   ‚îÇ           ‚îÇ - unit_number‚îÇ          ‚îÇ - email     ‚îÇ
‚îÇ - contact   ‚îÇ           ‚îÇ - floor     ‚îÇ           ‚îÇ - rut       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ1:N                                                ‚îÇ1:N
       ‚ñº                                                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    1:N    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    1:1    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇvisitor_spots‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇavailability ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   bookings  ‚îÇ
‚îÇ             ‚îÇ           ‚îÇ   _blocks   ‚îÇ           ‚îÇ             ‚îÇ
‚îÇ - id        ‚îÇ           ‚îÇ             ‚îÇ           ‚îÇ - id        ‚îÇ
‚îÇ - building_id‚îÇ          ‚îÇ - id        ‚îÇ           ‚îÇ - resident_id‚îÇ
‚îÇ - spot_number‚îÇ          ‚îÇ - spot_id   ‚îÇ           ‚îÇ - block_id  ‚îÇ
‚îÇ - description‚îÇ          ‚îÇ - start/end ‚îÇ           ‚îÇ - amount    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ - price_clp ‚îÇ           ‚îÇ - status    ‚îÇ
                          ‚îÇ - status    ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ1:1
                                                           ‚ñº
                                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                    ‚îÇ   payments  ‚îÇ
                                                    ‚îÇ             ‚îÇ
                                                    ‚îÇ - id        ‚îÇ
                                                    ‚îÇ - booking_id‚îÇ
                                                    ‚îÇ - amount    ‚îÇ
                                                    ‚îÇ - status    ‚îÇ
                                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Consultas SQL Cr√≠ticas

**1. B√∫squeda de Disponibilidad**
```sql
-- Encontrar espacios disponibles para fecha/duraci√≥n espec√≠fica
SELECT 
  vs.id as spot_id,
  vs.spot_number,
  ab.id as availability_id,
  ab.start_datetime,
  ab.end_datetime,
  ab.base_price_clp,
  b.name as building_name
FROM visitor_spots vs
JOIN availability_blocks ab ON vs.id = ab.spot_id
JOIN buildings b ON vs.building_id = b.id
WHERE vs.building_id = $1
  AND ab.status = 'available'
  AND ab.duration_type = $2  -- '11h' or '23h'
  AND ab.start_datetime >= $3
  AND ab.end_datetime <= $4
ORDER BY ab.base_price_clp ASC, ab.start_datetime ASC;
```

**2. Ocupaci√≥n por Edificio**
```sql
-- Calcular ocupaci√≥n promedio √∫ltimos 30 d√≠as
WITH occupancy_stats AS (
  SELECT 
    b.id,
    b.name,
    COUNT(DISTINCT vs.id) as total_spots,
    COUNT(CASE WHEN ab.status = 'reserved' 
          AND ab.start_datetime >= NOW() - INTERVAL '30 days' 
          THEN 1 END) as reserved_blocks,
    COUNT(CASE WHEN ab.status = 'available'
          AND ab.start_datetime >= NOW() - INTERVAL '30 days'
          THEN 1 END) as available_blocks
  FROM buildings b
  LEFT JOIN visitor_spots vs ON b.id = vs.building_id
  LEFT JOIN availability_blocks ab ON vs.id = ab.spot_id
  WHERE b.is_active = true
  GROUP BY b.id, b.name
)
SELECT 
  name as building,
  total_spots,
  ROUND(
    (reserved_blocks::decimal / NULLIF(reserved_blocks + available_blocks, 0)) * 100, 
    2
  ) as occupancy_percentage
FROM occupancy_stats
ORDER BY occupancy_percentage DESC;
```

**3. Conciliaci√≥n Pagos B√°sica**
```sql
-- Verificar consistencia pagos vs reservas √∫ltimo mes
SELECT 
  DATE(b.created_at) as date,
  COUNT(*) as total_bookings,
  COUNT(CASE WHEN b.payment_status = 'paid' THEN 1 END) as paid_bookings,
  SUM(b.amount_clp) as total_amount_clp,
  SUM(CASE WHEN p.status = 'approved' THEN p.amount_clp ELSE 0 END) as confirmed_payments_clp,
  SUM(b.amount_clp) - SUM(CASE WHEN p.status = 'approved' THEN p.amount_clp ELSE 0 END) as discrepancy_clp
FROM bookings b
LEFT JOIN payments p ON b.id = p.booking_id
WHERE b.created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE(b.created_at)
HAVING ABS(SUM(b.amount_clp) - SUM(CASE WHEN p.status = 'approved' THEN p.amount_clp ELSE 0 END)) > 100
ORDER BY date DESC;
```

## 3.5 Endpoints M√≠nimos con Ejemplos

### Autenticaci√≥n

**POST /api/auth/signup**
```json
// Request
{
  "email": "maria.gonzalez@torres-del-parque.cl",
  "rut": "12345678-9",
  "firstName": "Mar√≠a",
  "lastName": "Gonz√°lez",
  "unitNumber": "1205",
  "phone": "+56912345678"
}

// Response 201
{
  "success": true,
  "data": {
    "userId": "uuid-123",
    "verificationRequired": true,
    "message": "C√≥digo enviado por SMS"
  }
}

// Error 400
{
  "error": "INVALID_EMAIL_DOMAIN",
  "message": "Email debe pertenecer al dominio del edificio"
}
```

**POST /api/auth/login**
```json
// Request
{
  "email": "maria.gonzalez@torres-del-parque.cl",
  "password": "opcional-si-usa-codigo",
  "verificationCode": "123456"
}

// Response 200
{
  "success": true,
  "data": {
    "accessToken": "jwt-token...",
    "refreshToken": "refresh-token...",
    "user": {
      "id": "uuid-123",
      "email": "maria.gonzalez@torres-del-parque.cl",
      "firstName": "Mar√≠a",
      "building": {
        "id": "building-uuid",
        "name": "Torres del Parque"
      },
      "unitNumber": "1205"
    }
  }
}
```

**Rate Limit:** 5 requests/minute per IP  
**JWT Claims:** `{ userId, buildingId, unitNumber, role, exp }`

### Disponibilidad

**GET /api/spots/search?buildingId=uuid&date=2024-10-15&duration=11h**
```json
// Response 200
{
  "success": true,
  "data": {
    "availableSpots": [
      {
        "spotId": "spot-uuid-1",
        "spotNumber": "V-01",
        "availabilityId": "avail-uuid-1",
        "startTime": "2024-10-15T08:00:00-03:00",
        "endTime": "2024-10-15T19:00:00-03:00",
        "priceClp": 4500,
        "duration": "11h"
      },
      {
        "spotId": "spot-uuid-2", 
        "spotNumber": "V-02",
        "availabilityId": "avail-uuid-2",
        "startTime": "2024-10-15T08:00:00-03:00",
        "endTime": "2024-10-15T19:00:00-03:00",
        "priceClp": 5000,
        "duration": "11h"
      }
    ],
    "searchParams": {
      "buildingName": "Torres del Parque",
      "requestedDate": "2024-10-15",
      "duration": "11h",
      "totalFound": 2
    }
  }
}
```

**GET /api/spots/{spotId}/availability?startDate=2024-10-15&endDate=2024-10-30**
```json
// Response 200
{
  "success": true,
  "data": {
    "spotInfo": {
      "id": "spot-uuid-1",
      "number": "V-01",
      "building": "Torres del Parque"
    },
    "calendar": [
      {
        "date": "2024-10-15",
        "slots": [
          {
            "availabilityId": "avail-uuid-1",
            "duration": "11h",
            "startTime": "08:00",
            "endTime": "19:00", 
            "priceClp": 4500,
            "status": "available"
          },
          {
            "availabilityId": "avail-uuid-2",
            "duration": "23h",
            "startTime": "06:00",
            "endTime": "05:00+1",
            "priceClp": 7000,
            "status": "reserved"
          }
        ]
      }
    ]
  }
}
```

**Headers:** `Authorization: Bearer jwt-token`  
**Rate Limit:** 30 requests/minute per user

### Reservas

**POST /api/bookings/create** (Idempotente con `idempotencyKey`)
```json
// Request
{
  "availabilityBlockId": "avail-uuid-1",
  "visitorName": "Carlos Mendoza",
  "visitorPhone": "+56987654321",
  "vehiclePlate": "ABCD-12",
  "specialInstructions": "Veh√≠culo SUV grande",
  "idempotencyKey": "uuid-idempotency"
}

// Response 201
{
  "success": true,
  "data": {
    "bookingId": "booking-uuid-123",
    "confirmationCode": "EST-4529",
    "status": "pending_payment",
    "amountClp": 4500,
    "paymentDeadline": "2024-10-14T23:59:59-03:00",
    "spotDetails": {
      "number": "V-01",
      "building": "Torres del Parque",
      "startTime": "2024-10-15T08:00:00-03:00",
      "endTime": "2024-10-15T19:00:00-03:00"
    },
    "nextStep": {
      "action": "redirect_to_payment",
      "paymentUrl": "https://checkout-pro.mercadopago.cl/...",
      "timeoutMinutes": 15
    }
  }
}

// Error 409 - Conflicto (spot ya reservado)
{
  "error": "SPOT_UNAVAILABLE",
  "message": "Este espacio ya ha sido reservado por otro usuario"
}
```

**PUT /api/bookings/{bookingId}/cancel**
```json
// Request
{
  "reason": "change_of_plans",
  "requestRefund": true
}

// Response 200
{
  "success": true,
  "data": {
    "bookingId": "booking-uuid-123",
    "status": "cancelled",
    "refundStatus": "processing",
    "refundAmountClp": 4050, // Menos fee de cancelaci√≥n
    "estimatedRefundDays": "3-5 d√≠as h√°biles"
  }
}
```

**Headers:** `Authorization: Bearer jwt-token`  
**Idempotency:** Header `Idempotency-Key` para operaciones cr√≠ticas  
**Rate Limit:** 10 requests/minute per user

### Pagos

**POST /api/payments/checkout**
```json
// Request
{
  "bookingId": "booking-uuid-123",
  "paymentMethod": "mercadopago"
}

// Response 200
{
  "success": true,
  "data": {
    "checkoutUrl": "https://checkout-pro.mercadopago.cl/preferences/123456789-abcd-1234",
    "preferenceId": "123456789-abcd-1234",
    "qrCodeData": "00020101021243650016COM.MERCADOLIBRE...",
    "expiration": "2024-10-14T16:30:00-03:00"
  }
}
```

**POST /api/payments/webhook** (MercadoPago)
```json
// Request (Webhook de MercadoPago)
{
  "action": "payment.updated",
  "api_version": "v1",
  "date_created": "2024-10-14T15:45:30.000-03:00",
  "id": 12345678,
  "live_mode": false,
  "type": "payment",
  "user_id": "987654321",
  "data": {
    "id": "98765432101"
  }
}

// Response 200
{
  "received": true
}
```

**POST /api/payments/refund**
```json
// Request
{
  "bookingId": "booking-uuid-123",
  "amountClp": 4050,
  "reason": "user_cancellation"
}

// Response 200
{
  "success": true,
  "data": {
    "refundId": "refund-uuid-456",
    "status": "processing",
    "originalAmountClp": 4500,
    "refundAmountClp": 4050,
    "processingTimeEstimate": "3-5 d√≠as h√°biles"
  }
}
```

**Security:** HMAC-SHA256 signature validation para webhooks  
**Idempotency:** Refunds son idempotentes por `bookingId`  
**Rate Limit:** Webhooks sin l√≠mite, otros endpoints 20/minute

### Admin Edificio

**GET /api/admin/spots?buildingId=uuid**
```json
// Response 200
{
  "success": true,
  "data": {
    "building": {
      "id": "building-uuid",
      "name": "Torres del Parque",
      "totalSpots": 4
    },
    "spots": [
      {
        "id": "spot-uuid-1",
        "number": "V-01",
        "description": "Primer nivel, cerca ascensor",
        "isActive": true,
        "currentMonth": {
          "totalReservations": 18,
          "occupancyRate": "62%",
          "revenueClp": 81000
        }
      }
    ]
  }
}
```

**PUT /api/admin/pricing**
```json
// Request
{
  "buildingId": "building-uuid", 
  "priceAdjustments": [
    {
      "durationType": "11h",
      "basePriceClp": 4500,
      "weekendMultiplier": 1.2
    },
    {
      "durationType": "23h", 
      "basePriceClp": 7000,
      "weekendMultiplier": 1.3
    }
  ]
}

// Response 200
{
  "success": true,
  "data": {
    "effectiveDate": "2024-10-15T00:00:00-03:00",
    "updatedPrices": [
      {
        "duration": "11h",
        "weekdayPriceClp": 4500,
        "weekendPriceClp": 5400
      }
    ]
  }
}
```

**GET /api/admin/reports?buildingId=uuid&period=month&year=2024&month=10**
```json
// Response 200
{
  "success": true,
  "data": {
    "period": "Octubre 2024",
    "summary": {
      "totalReservations": 87,
      "totalRevenueClp": 425600,
      "averageOccupancyRate": "58%",
      "topSpot": "V-01",
      "buildingShareClp": 340480,
      "platformCommissionClp": 85120
    },
    "daily": [
      {
        "date": "2024-10-01",
        "reservations": 3,
        "revenueClp": 13500,
        "occupancyRate": "75%"
      }
    ]
  }
}
```

**Authorization:** JWT con role `building_admin` o `admin`  
**Rate Limit:** 60 requests/minute para admins

## 3.6 Flujo B√°sico de Usuario

### Secuencia Completa: Registro ‚Üí Reserva ‚Üí Pago ‚Üí Uso
```
Residente                PWA              API              MercadoPago    Conserjer√≠a
    ‚îÇ                    ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ 1. Accede app       ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ 2. POST /auth/signup                 ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ 3. SMS c√≥digo   ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ 4. Ingresa c√≥digo  ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ 5. POST /auth/login                 ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ 6. JWT + perfil ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ 7. Busca espacios  ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ 8. GET /spots/search                ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ 9. Lista disponible                  ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ 10. Selecciona spot‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ 11. POST /bookings/create           ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ 12. Booking pending                  ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ 13. POST /payments/checkout          ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ 14. Crear preferencia            ‚îÇ
    ‚îÇ                    ‚îÇ                ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ                ‚îÇ 15. Checkout URL    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ 16. Redirect    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ             ‚îÇ
    ‚îÇ 17. Pago en MP     ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ                ‚îÇ 18. Webhook confirmaci√≥n        ‚îÇ
    ‚îÇ                    ‚îÇ                ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ 19. Update booking                   ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ 20. Confirmaci√≥n   ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ QR: EST-4529       ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ D√çA DE LA RESERVA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ             ‚îÇ
    ‚îÇ                    ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ 21. Llegada edificio (08:00)        ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
    ‚îÇ                    ‚îÇ                ‚îÇ                    ‚îÇ 22. Valida QR‚îÇ
    ‚îÇ                    ‚îÇ                ‚îÇ                    ‚îÇ Patente ABCD-12
    ‚îÇ 23. Acceso autorizado                                    ‚îÇ             ‚îÇ
    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
    ‚îÇ ... usa espacio ...‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ 24. Checkout (19:00)                 ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
    ‚îÇ                    ‚îÇ 25. POST /bookings/uuid/complete     ‚îÇ             ‚îÇ
    ‚îÇ                    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ 26. SMS: "Gracias  ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ     por usar       ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ     Estaci√≥nate    ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ     NPS: 8/10"     ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
    ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ                ‚îÇ                    ‚îÇ             ‚îÇ
```

### Pantallas Clave y Microcopy

**1. Landing + Registro**
- **T√≠tulo:** "Reserva tu espacio de estacionamiento para visitas"
- **Subt√≠tulo:** "Solo para residentes verificados de tu edificio"
- **CTA:** "Crear cuenta con email del edificio"
- **Inputs:** Email edificio, RUT, nombre completo, departamento
- **Footer:** "Al registrarte aceptas t√©rminos y condiciones"

**2. Verificaci√≥n**
- **T√≠tulo:** "Confirma tu c√≥digo de verificaci√≥n"
- **Instrucci√≥n:** "Enviamos un c√≥digo SMS al +56987654321"
- **Input:** C√≥digo 6 d√≠gitos con auto-focus
- **Enlaces:** "Reenviar c√≥digo (en 60s)" | "Cambiar n√∫mero"

**3. B√∫squeda de Espacios**
- **Header:** "Torres del Parque - Depto 1205"
- **Filtros:** Calendario fecha | Duraci√≥n (11h/23h) | "Buscar"
- **Resultados:** Cards con "V-01 | $4.500 | 08:00-19:00 | Reservar"
- **Empty state:** "No hay espacios disponibles para esta fecha. Prueba otro d√≠a."

**4. Checkout**
- **T√≠tulo:** "Confirma tu reserva"
- **Resumen:** Espacio V-01 | 15 Oct 08:00-19:00 | $4.500
- **Formulario:** Nombre visitante, tel√©fono, patente veh√≠culo
- **Instrucciones:** "El c√≥digo de acceso se enviar√° tras confirmar el pago"
- **CTA:** "Pagar con MercadoPago"

**5. Confirmaci√≥n**
- **Success:** "¬°Reserva confirmada! ‚úÖ"
- **C√≥digo:** "EST-4529" (grande, copiable)
- **Detalles:** Fecha, hora, espacio, instrucciones llegada
- **Acciones:** "Agregar al calendario" | "Ver instrucciones" | "Contactar conserjer√≠a"

**6. Historial**
- **Tabs:** "Pr√≥ximas" | "Pasadas" | "Canceladas"
- **Cards:** Fecha | Espacio | Estado | Bot√≥n acci√≥n
- **Estados:** "Confirmada" (verde) | "Pendiente pago" (amarillo) | "Cancelada" (gris)

### Toasts y Mensajes de Error

**√âxito:**
- "Reserva creada exitosamente üéâ"
- "Pago confirmado. C√≥digo EST-4529 enviado por SMS"
- "Cancelaci√≥n procesada. Reembolso en 3-5 d√≠as"

**Errores t√©cnicos:**
- "Error al procesar el pago. Intenta nuevamente"
- "Espacio no disponible. Actualiza la p√°gina"
- "Problema de conexi√≥n. Verifica tu internet"

**Errores de validaci√≥n:**
- "Ingresa una patente v√°lida (ej: ABCD-12)"
- "El RUT ingresado no es v√°lido"
- "Email debe ser del dominio @torres-del-parque.cl"

**Informaci√≥n:**
- "El pago expira en 15 minutos"
- "C√≥digo de acceso v√°lido desde las 07:45"
- "Recuerda llegar puntual para evitar multas"

## 3.7 Integraci√≥n de Pagos y Conciliaci√≥n

### MercadoPago: Flujo Completo

**Configuraci√≥n SDK**
```javascript
import { MercadoPagoConfig, Preference, Payment } from 'mercadopago';

const client = new MercadoPagoConfig({
  accessToken: process.env.MP_ACCESS_TOKEN,
  options: { 
    timeout: 5000,
    integratorId: 'dev_24c65fb163bf11ea96500242ac130004' 
  }
});

const preference = new Preference(client);
const payment = new Payment(client);
```

**Crear Preferencia de Pago**
```javascript
export async function createBookingPreference(booking: BookingWithDetails) {
  const preferenceData = {
    items: [{
      id: booking.id,
      title: `Estacionamiento ${booking.building.name} - ${booking.duration}`,
      description: `Espacio ${booking.spot.number} | ${formatDate(booking.startTime)}`,
      quantity: 1,
      unit_price: booking.amountClp,
      currency_id: 'CLP'
    }],
    payer: {
      email: booking.resident.email,
      name: booking.resident.firstName,
      surname: booking.resident.lastName,
      identification: {
        type: 'RUT',
        number: booking.resident.rut.replace('-', '')
      },
      phone: {
        area_code: '56',
        number: booking.resident.phone.replace('+56', '')
      },
      address: {
        street_name: booking.building.address,
        zip_code: '7500000' // Santiago default
      }
    },
    back_urls: {
      success: `${process.env.WEB_URL}/booking/${booking.id}/success`,
      failure: `${process.env.WEB_URL}/booking/${booking.id}/failure`, 
      pending: `${process.env.WEB_URL}/booking/${booking.id}/pending`
    },
    auto_return: 'approved',
    external_reference: booking.id,
    notification_url: `${process.env.API_URL}/payments/webhook`,
    expires: true,
    expiration_date_from: new Date().toISOString(),
    expiration_date_to: new Date(Date.now() + 15 * 60 * 1000).toISOString(), // 15 min
    payment_methods: {
      excluded_payment_types: [
        { id: 'ticket' }, // Sin efectivo
        { id: 'bank_transfer' } // Sin transferencias
      ],
      installments: 1 // Solo pago al contado
    }
  };
  
  const response = await preference.create({ body: preferenceData });
  
  // Guardar preferencia en DB para tracking
  await db.insert(mpPreferences).values({
    id: response.id,
    bookingId: booking.id,
    initPoint: response.init_point,
    sandboxInitPoint: response.sandbox_init_point,
    expiresAt: new Date(Date.now() + 15 * 60 * 1000)
  });
  
  return response;
}
```

**Webhook Handler con Validaci√≥n Firma**
```javascript
import crypto from 'crypto';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'METHOD_NOT_ALLOWED' });
  }
  
  // Validar firma HMAC-SHA256
  const signature = req.headers['x-signature'] as string;
  const requestId = req.headers['x-request-id'] as string;
  
  if (!signature || !requestId) {
    return res.status(400).json({ error: 'MISSING_HEADERS' });
  }
  
  const [tsSignature, v1Signature] = signature.split(',').map(s => s.split('=')[1]);
  
  const manifest = `id:${req.body.data.id};request-id:${requestId};ts:${tsSignature};`;
  const expectedSignature = crypto
    .createHmac('sha256', process.env.MP_WEBHOOK_SECRET!)
    .update(manifest)
    .digest('hex');
  
  if (expectedSignature !== v1Signature) {
    console.error('Invalid webhook signature', { expectedSignature, v1Signature });
    return res.status(401).json({ error: 'INVALID_SIGNATURE' });
  }
  
  try {
    const { action, data, date_created, id } = req.body;
    
    // Log webhook recibido
    console.info('MercadoPago webhook received', {
      action,
      dataId: data.id,
      webhookId: id,
      dateCreated: date_created
    });
    
    if (action === 'payment.created' || action === 'payment.updated') {
      await processPaymentWebhook(data.id);
    }
    
    res.status(200).json({ received: true });
  } catch (error) {
    console.error('Webhook processing error:', error);
    res.status(500).json({ error: 'WEBHOOK_ERROR' });
  }
}

async function processPaymentWebhook(paymentId: string) {
  // Obtener detalles del pago desde MercadoPago
  const paymentDetails = await payment.get({ id: paymentId });
  const { status, external_reference, transaction_amount } = paymentDetails;
  
  if (!external_reference) {
    throw new Error(`Payment ${paymentId} missing external_reference`);
  }
  
  // Actualizar booking y payment en transacci√≥n
  await db.transaction(async (tx) => {
    // Buscar booking
    const booking = await tx.select()
      .from(bookings)
      .where(eq(bookings.id, external_reference))
      .limit(1);
    
    if (!booking.length) {
      throw new Error(`Booking ${external_reference} not found`);
    }
    
    // Mapear estado MercadoPago ‚Üí interno
    const mappedStatus = mapMercadoPagoStatus(status);
    
    // Actualizar payment record
    await tx.insert(payments).values({
      bookingId: external_reference,
      externalPaymentId: paymentId,
      paymentMethod: 'mercadopago',
      amountClp: Math.round(transaction_amount),
      status: mappedStatus,
      gatewayResponse: paymentDetails,
      processedAt: new Date()
    }).onConflictDoUpdate({
      target: [payments.externalPaymentId],
      set: {
        status: mappedStatus,
        gatewayResponse: paymentDetails,
        processedAt: new Date()
      }
    });
    
    // Actualizar booking status
    if (mappedStatus === 'approved') {
      await tx.update(bookings)
        .set({ 
          paymentStatus: 'paid',
          status: 'confirmed',
          updatedAt: new Date()
        })
        .where(eq(bookings.id, external_reference));
      
      // Generar c√≥digo acceso y enviar SMS
      await generateAccessCodeAndNotify(external_reference);
    }
  });
}

function mapMercadoPagoStatus(mpStatus: string): PaymentStatus {
  const statusMap: Record<string, PaymentStatus> = {
    'approved': 'approved',
    'pending': 'pending', 
    'authorized': 'pending',
    'in_process': 'pending',
    'in_mediation': 'pending',
    'rejected': 'rejected',
    'cancelled': 'cancelled',
    'refunded': 'refunded',
    'charged_back': 'rejected'
  };
  
  return statusMap[mpStatus] || 'pending';
}
```

### Conciliaci√≥n Diaria Automatizada

**Cron Job - Vercel Cron Functions**
```javascript
// api/cron/daily-reconciliation.ts
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  // Verificar auth token de Vercel Cron
  if (req.headers.authorization !== `Bearer ${process.env.CRON_SECRET}`) {
    return res.status(401).json({ error: 'UNAUTHORIZED' });
  }
  
  try {
    const reconciliationDate = new Date();
    reconciliationDate.setDate(reconciliationDate.getDate() - 1); // Ayer
    
    const result = await performDailyReconciliation(reconciliationDate);
    
    res.status(200).json({ 
      success: true, 
      date: reconciliationDate.toISOString().split('T')[0],
      ...result 
    });
  } catch (error) {
    console.error('Reconciliation failed:', error);
    res.status(500).json({ error: 'RECONCILIATION_FAILED' });
  }
}

async function performDailyReconciliation(date: Date) {
  const startOfDay = new Date(date);
  startOfDay.setHours(0, 0, 0, 0);
  
  const endOfDay = new Date(date);
  endOfDay.setHours(23, 59, 59, 999);
  
  // 1. Obtener todos los bookings del d√≠a
  const bookings = await db.select({
    id: bookings.id,
    amountClp: bookings.amountClp,
    paymentStatus: bookings.paymentStatus,
    externalPaymentId: payments.externalPaymentId,
    gatewayStatus: payments.status,
    gatewayAmount: payments.amountClp
  })
  .from(bookings)
  .leftJoin(payments, eq(bookings.id, payments.bookingId))
  .where(
    and(
      gte(bookings.createdAt, startOfDay),
      lte(bookings.createdAt, endOfDay)
    )
  );
  
  // 2. Verificar discrepancias
  const discrepancies = [];
  
  for (const booking of bookings) {
    // Discrepancia de monto
    if (booking.gatewayAmount && booking.gatewayAmount !== booking.amountClp) {
      discrepancies.push({
        type: 'AMOUNT_MISMATCH',
        bookingId: booking.id,
        expectedAmount: booking.amountClp,
        gatewayAmount: booking.gatewayAmount,
        difference: booking.amountClp - booking.gatewayAmount
      });
    }
    
    // Status inconsistente
    if (booking.paymentStatus === 'paid' && booking.gatewayStatus !== 'approved') {
      discrepancies.push({
        type: 'STATUS_MISMATCH',
        bookingId: booking.id,
        internalStatus: booking.paymentStatus,
        gatewayStatus: booking.gatewayStatus
      });
    }
    
    // Pagos faltantes
    if (booking.paymentStatus === 'paid' && !booking.externalPaymentId) {
      discrepancies.push({
        type: 'MISSING_PAYMENT_RECORD',
        bookingId: booking.id,
        amountClp: booking.amountClp
      });
    }
  }
  
  // 3. Obtener settlements de MercadoPago para validation extra
  const settlements = await getSettlements(startOfDay, endOfDay);
  
  // 4. Generar reporte
  const report = {
    date: date.toISOString().split('T')[0],
    totalBookings: bookings.length,
    totalAmount: bookings.reduce((sum, b) => sum + b.amountClp, 0),
    paidBookings: bookings.filter(b => b.paymentStatus === 'paid').length,
    discrepancies: discrepancies.length,
    details: discrepancies
  };
  
  // 5. Guardar reporte en DB
  await db.insert(reconciliationReports).values({
    date: startOfDay,
    totalBookings: report.totalBookings,
    totalAmountClp: report.totalAmount,
    discrepancies: discrepancies.length,
    reportData: report,
    status: discrepancies.length > 0 ? 'has_issues' : 'clean'
  });
  
  // 6. Alertar si hay discrepancias cr√≠ticas
  if (discrepancies.length > 0) {
    await sendReconciliationAlert(report);
  }
  
  return report;
}

async function getSettlements(startDate: Date, endDate: Date) {
  // Llamada a MercadoPago Search API para settlements
  const searchParams = {
    operation_type: 'regular_payment',
    begin_date: startDate.toISOString(),
    end_date: endDate.toISOString(),
    limit: 1000
  };
  
  // Implementaci√≥n espec√≠fica depende de MercadoPago Settlements API
  return [];
}
```

### Pol√≠ticas de Reembolso y Cancelaci√≥n

**Reglas de Negocio CLP Enteros**
```javascript
export function calculateRefundAmount(booking: BookingWithPayment, cancellationTime: Date): RefundCalculation {
  const bookingStart = new Date(booking.startTime);
  const hoursUntilStart = (bookingStart.getTime() - cancellationTime.getTime()) / (1000 * 60 * 60);
  
  let refundRate: number;
  let cancellationFee: number;
  
  // Pol√≠tica escalonada
  if (hoursUntilStart >= 24) {
    refundRate = 1.0; // 100%
    cancellationFee = 0;
  } else if (hoursUntilStart >= 4) {
    refundRate = 0.9; // 90%
    cancellationFee = Math.ceil(booking.amountClp * 0.1);
  } else if (hoursUntilStart >= 1) {
    refundRate = 0.5; // 50%
    cancellationFee = Math.ceil(booking.amountClp * 0.5);
  } else {
    refundRate = 0; // No refund
    cancellationFee = booking.amountClp;
  }
  
  const refundAmount = Math.max(0, Math.floor(booking.amountClp * refundRate));
  
  return {
    originalAmount: booking.amountClp,
    refundAmount,
    cancellationFee,
    refundRate,
    hoursUntilStart: Math.floor(hoursUntilStart)
  };
}

export async function processRefund(bookingId: string, reason: string) {
  return await db.transaction(async (tx) => {
    const booking = await getBookingWithPayment(bookingId);
    
    if (!booking || booking.paymentStatus !== 'paid') {
      throw new Error('BOOKING_NOT_ELIGIBLE_FOR_REFUND');
    }
    
    const refundCalc = calculateRefundAmount(booking, new Date());
    
    if (refundCalc.refundAmount === 0) {
      throw new Error('NO_REFUND_AVAILABLE');
    }
    
    // Crear refund en MercadoPago
    const mpRefund = await payment.refund({
      id: booking.externalPaymentId,
      body: {
        amount: refundCalc.refundAmount
      }
    });
    
    // Actualizar booking
    await tx.update(bookings).set({
      status: 'cancelled',
      paymentStatus: 'refunded',
      updatedAt: new Date()
    }).where(eq(bookings.id, bookingId));
    
    // Registrar refund
    await tx.insert(refunds).values({
      bookingId,
      originalAmountClp: refundCalc.originalAmount,
      refundAmountClp: refundCalc.refundAmount,
      cancellationFeeClp: refundCalc.cancellationFee,
      reason,
      externalRefundId: mpRefund.id,
      status: 'processing',
      processedAt: new Date()
    });
    
    // Liberar availability block
    await tx.update(availabilityBlocks).set({
      status: 'available',
      updatedAt: new Date()
    }).where(eq(availabilityBlocks.id, booking.availabilityBlockId));
    
    return { refundAmount: refundCalc.refundAmount, mpRefundId: mpRefund.id };
  });
}
```

## 3.8 Operaci√≥n, SRE y Calidad

### Monitoreo y Observabilidad

**Logs Estructurados**
```javascript
import winston from 'winston';

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: 'estacionate-api' },
  transports: [
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    })
  ]
});

// Structured logging for business events
export const businessLogger = {
  bookingCreated: (booking: Booking) => {
    logger.info('Booking created', {
      event: 'booking.created',
      bookingId: booking.id,
      buildingId: booking.buildingId,
      residentId: booking.residentId,
      amount: booking.amountClp,
      duration: booking.duration,
      startTime: booking.startTime
    });
  },
  
  paymentProcessed: (payment: Payment) => {
    logger.info('Payment processed', {
      event: 'payment.processed',
      paymentId: payment.id,
      bookingId: payment.bookingId,
      status: payment.status,
      amount: payment.amountClp,
      method: payment.paymentMethod,
      processingTime: payment.processedAt - payment.createdAt
    });
  },
  
  apiError: (endpoint: string, error: Error, context: Record<string, any>) => {
    logger.error('API error', {
      event: 'api.error',
      endpoint,
      error: error.message,
      stack: error.stack,
      ...context
    });
  }
};
```

**M√©tricas con Prometheus/Grafana-compatible**
```javascript
import client from 'prom-client';

// Business metrics
const bookingsCounter = new client.Counter({
  name: 'bookings_created_total',
  help: 'Total number of bookings created',
  labelNames: ['building_id', 'duration', 'status']
});

const paymentSuccessRate = new client.Gauge({
  name: 'payment_success_rate',
  help: 'Payment success rate (0-1)',
  labelNames: ['payment_method']
});

const spotOccupancyRate = new client.Gauge({
  name: 'spot_occupancy_rate', 
  help: 'Spot occupancy rate by building (0-1)',
  labelNames: ['building_id']
});

// Technical metrics  
const apiDuration = new client.Histogram({
  name: 'api_request_duration_seconds',
  help: 'Duration of API requests in seconds',
  labelNames: ['method', 'endpoint', 'status_code'],
  buckets: [0.1, 0.3, 0.5, 0.7, 1, 1.5, 2, 3, 5, 10]
});

const dbConnectionsActive = new client.Gauge({
  name: 'db_connections_active',
  help: 'Active database connections'
});

// Middleware para m√©tricas autom√°ticas
export function withMetrics(handler: ApiHandler): ApiHandler {
  return async (req: NextApiRequest, res: NextApiResponse) => {
    const startTime = Date.now();
    
    try {
      await handler(req, res);
    } finally {
      const duration = (Date.now() - startTime) / 1000;
      const endpoint = req.url?.split('?')[0] || 'unknown';
      
      apiDuration
        .labels(req.method || 'unknown', endpoint, res.statusCode.toString())
        .observe(duration);
    }
  };
}

// Endpoint m√©tricas para Vercel Analytics
export default async function metricsHandler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'GET') {
    return res.status(405).end();
  }
  
  // Actualizar m√©tricas de negocio en tiempo real
  await updateBusinessMetrics();
  
  res.setHeader('Content-Type', client.register.contentType);
  res.status(200).send(await client.register.metrics());
}

async function updateBusinessMetrics() {
  // Payment success rate last 24h
  const paymentStats = await db.select({
    method: payments.paymentMethod,
    successful: sql<number>`COUNT(CASE WHEN status = 'approved' THEN 1 END)`,
    total: sql<number>`COUNT(*)`
  }).from(payments)
  .where(gte(payments.createdAt, new Date(Date.now() - 24 * 60 * 60 * 1000)))
  .groupBy(payments.paymentMethod);
  
  for (const stat of paymentStats) {
    const successRate = stat.total > 0 ? stat.successful / stat.total : 0;
    paymentSuccessRate.labels(stat.method).set(successRate);
  }
  
  // Occupancy rate por building
  const occupancyStats = await db.select({
    buildingId: buildings.id,
    occupied: sql<number>`COUNT(CASE WHEN ab.status = 'reserved' THEN 1 END)`,
    total: sql<number>`COUNT(ab.id)`
  }).from(buildings)
  .leftJoin(visitorSpots, eq(buildings.id, visitorSpots.buildingId))
  .leftJoin(availabilityBlocks, eq(visitorSpots.id, availabilityBlocks.spotId))
  .where(
    and(
      gte(availabilityBlocks.startDatetime, new Date()),
      lte(availabilityBlocks.startDatetime, new Date(Date.now() + 7 * 24 * 60 * 60 * 1000))
    )
  )
  .groupBy(buildings.id);
  
  for (const stat of occupancyStats) {
    const occupancyRate = stat.total > 0 ? stat.occupied / stat.total : 0;
    spotOccupancyRate.labels(stat.buildingId).set(occupancyRate);
  }
}
```

**Alertas Cr√≠ticas (usando servicio como Better Uptime o PagerDuty)**
```javascript
// lib/alerting.ts
import fetch from 'node-fetch';

interface Alert {
  level: 'info' | 'warning' | 'critical';
  title: string;
  message: string;
  tags: string[];
  context?: Record<string, any>;
}

export async function sendAlert(alert: Alert) {
  if (process.env.NODE_ENV !== 'production') {
    console.log('ALERT:', alert);
    return;
  }
  
  // Webhook a servicio de alerting (ej: PagerDuty, Slack)
  await fetch(process.env.ALERTS_WEBHOOK_URL!, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      routing_key: process.env.PAGERDUTY_ROUTING_KEY,
      event_action: 'trigger',
      payload: {
        summary: alert.title,
        source: 'estacionate-api',
        severity: alert.level,
        component: 'api',
        custom_details: {
          message: alert.message,
          context: alert.context || {}
        }
      }
    })
  });
}

// Usage en error handlers
export async function handleCriticalError(error: Error, context: Record<string, any>) {
  businessLogger.apiError('critical-path', error, context);
  
  if (error.message.includes('payment') || error.message.includes('booking')) {
    await sendAlert({
      level: 'critical',
      title: 'Critical API Error',
      message: `${error.message}`,
      tags: ['payments', 'bookings'],
      context
    });
  }
}
```

### Testing Strategy

**Unit Tests (Jest + Supertest)**
```javascript
// tests/api/bookings.test.ts
import { createBooking } from '../../api/bookings/create';
import { setupTestDb, cleanupTestDb, createTestUser, createTestBuilding } from '../helpers';

describe('/api/bookings/create', () => {
  beforeAll(setupTestDb);
  afterAll(cleanupTestDb);
  
  it('should create booking with valid input', async () => {
    const user = await createTestUser();
    const building = await createTestBuilding();
    const spot = await createTestSpot(building.id);
    const availability = await createTestAvailability(spot.id);
    
    const bookingData = {
      availabilityBlockId: availability.id,
      visitorName: 'Juan P√©rez',
      visitorPhone: '+56987654321',
      vehiclePlate: 'ABCD-12',
      specialInstructions: 'Veh√≠culo azul'
    };
    
    const response = await request(app)
      .post('/api/bookings/create')
      .set('Authorization', `Bearer ${user.jwt}`)
      .send(bookingData)
      .expect(201);
    
    expect(response.body.data.confirmationCode).toMatch(/^EST-\d{4}$/);
    expect(response.body.data.status).toBe('pending_payment');
    
    // Verify availability block is marked as reserved
    const updatedBlock = await getAvailabilityBlock(availability.id);
    expect(updatedBlock.status).toBe('reserved');
  });
  
  it('should prevent double booking with race condition', async () => {
    const availability = await createTestAvailability();
    const user1 = await createTestUser({ email: 'user1@building.cl' });
    const user2 = await createTestUser({ email: 'user2@building.cl' });
    
    const bookingData = {
      availabilityBlockId: availability.id,
      visitorName: 'Concurrent User',
      visitorPhone: '+56987654321',
      vehiclePlate: 'TEST-01'
    };
    
    // Simulate concurrent requests
    const [response1, response2] = await Promise.allSettled([
      request(app).post('/api/bookings/create').set('Authorization', `Bearer ${user1.jwt}`).send(bookingData),
      request(app).post('/api/bookings/create').set('Authorization', `Bearer ${user2.jwt}`).send(bookingData)
    ]);
    
    expect(response1.status).toBe('fulfilled');
    expect(response2.status).toBe('fulfilled');
    
    // One should succeed, one should fail
    const results = [response1, response2].map(r => r.status === 'fulfilled' ? r.value.status : 500);
    expect(results).toContain(201); // One success
    expect(results).toContain(409); // One conflict (SPOT_UNAVAILABLE)
  });
  
  it('should validate Chilean RUT format', async () => {
    const user = await createTestUser({ rut: 'invalid-rut' });
    
    const response = await request(app)
      .post('/api/bookings/create')
      .set('Authorization', `Bearer ${user.jwt}`)
      .send({ /* booking data */ })
      .expect(400);
    
    expect(response.body.error).toBe('INVALID_RUT');
  });
  
  it('should handle CLP integer amounts correctly', async () => {
    const availability = await createTestAvailability({ priceClp: 4567.89 }); // Simulate decimal input
    
    const response = await request(app)
      .post('/api/bookings/create')
      .set('Authorization', `Bearer ${user.jwt}`)
      .send(validBookingData)
      .expect(201);
    
    // Amount should be rounded to integer
    expect(response.body.data.amountClp).toBe(4568);
    expect(Number.isInteger(response.body.data.amountClp)).toBe(true);
  });
});